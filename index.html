<!DOCTYPE html>
<!-- saved from url=(0055)file:///C:/Users/Alpine/Desktop/test%20no%20sunday.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bible Land Check-In ‚òÅÔ∏è üåü</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kids Check-In">
    <style>
        /* Prevent double-tap zoom globally */
        * {
            touch-action: manipulation;
            box-sizing: border-box;
        }
        
        /* Prevent text overflow */
        body, div, p, span, td, th {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        :root {
            --primary: #4a90e2;
            --primary-light: #a3d0ff;
            --success: #50c878;
            --warning: #ffaa33;
            --bg: #f0f7ff;
            --card: #ffffff;
            --text: #2c3e50;
            --shadow: 0 8px 25px rgba(74, 144, 226, 0.18);
        }

        body {
            font-family: "Segoe UI", system-ui, sans-serif;
            background: linear-gradient(135deg, #e0f2ff, #f0f7ff);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        h1,
        h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 0.6em;
        }

        .card {
            background: var(--card);
            border-radius: 24px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin: 20px 0;
            position: relative;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        #login-screen {
            max-width: 520px;
            margin: 40px auto;
            padding: 40px 32px;
        }

        #login-screen h1 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
                border-radius: 16px;
                margin: 10px 0;
            }

            #login-screen {
                margin: 20px auto;
                padding: 24px 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.2rem;
            }
        }

        .main-buttons {
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
            margin: 60px 0 40px;
        }

        .main-buttons button {
            font-size: 1.5rem;
            padding: 24px 48px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            max-width: 420px;
            color: white;
            transition: all 0.2s;
        }

        .main-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        #btn-checkin {
            background: var(--success);
        }

        #btn-view {
            background: var(--primary);
        }

        #btn-schedule {
            background: #9b59b6;
        }

        #btn-admin {
            background: #7f8c8d;
        }

        .hidden {
            display: none !important;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-overlay:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .modal-overlay:not(.hidden) {
                padding: 10px;
                align-items: flex-start;
            }
        }
        
        .modal-overlay-high {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-overlay-high:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .modal-overlay-high:not(.hidden) {
                padding: 10px;
                align-items: flex-start;
            }
        }

        input[type="tel"],
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="email"],
        select {
            font-size: 1.3rem;
            padding: 14px 18px;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            width: 100%;
            max-width: 340px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            input[type="tel"],
            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="email"],
            select {
                font-size: 1rem;
                padding: 12px 14px;
                max-width: 100%;
            }
        }

        button:not(.main-buttons button, .numpad-btn) {
            font-size: 1.15rem;
            padding: 14px 28px;
            border-radius: 16px;
            margin: 10px 6px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            button:not(.main-buttons button, .numpad-btn) {
                font-size: 1rem;
                padding: 12px 20px;
                margin: 8px 4px;
            }
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
        }

        /* Card close button (X) for main screens */
        .card-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            padding: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .card-close-btn:hover {
            background: #e0e0e0;
            color: #333;
            transform: scale(1.1);
        }

        .card-close-btn:active {
            transform: scale(0.95);
        }

        /* Make sure cards have relative positioning for absolute close button */
        .card {
            position: relative;
        }



        /* Custom confirmation modal */
        #confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #confirm-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #confirm-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 360px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #confirm-content h3 {
            margin-top: 0;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            #confirm-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #confirm-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        #confirm-content .modal-buttons {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            #confirm-content .modal-buttons {
                gap: 10px;
            }
            
            #confirm-content .modal-buttons button {
                min-width: 100px;
            }
        }

        /* Success modal styles */
        .success-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .success-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .success-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            .success-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        .success-content h2 {
            color: var(--success);
            margin-top: 0;
        }

        /* Schedule view modal */
        #schedule-view-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #schedule-view-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #schedule-view-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 700px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            margin: 20px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            #schedule-view-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #schedule-view-content {
                padding: 24px 16px;
                margin: 10px;
                max-height: 85vh;
            }
        }

        #schedule-view-content .card-close-btn {
            position: fixed;
            top: -4px;
            right: -2px;
            z-index: 10001;
            background: #ef4444;
            border: none;
            font-size: 28px;
            cursor: pointer;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #schedule-view-content .card-close-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.6);
        }

        .schedule-date-block {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary);
        }

        .schedule-date-block h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
        }

        .schedule-date-block p {
            margin: 4px 0;
            color: var(--text);
        }

        /* Admin password modal */
        #admin-password-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #admin-password-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #password-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 360px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        #password-content h2 {
            margin-top: 0;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            #admin-password-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #password-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        /* Validation modal */
        #validation-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #validation-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #validation-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        #validation-content h3 {
            margin-top: 0;
            color: #ef4444;
        }

        #validation-content p {
            font-size: 1.1rem;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            #validation-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #validation-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
            
            #validation-content p {
                font-size: 1rem;
            }
        }

        .child-name-group {
            display: block;
            margin-bottom: 8px;
        }

        .child-allergies::placeholder {
            color: #bbb;
        }

        .child-entry {
            background: #f8fbff;
            border: 2px dashed #c3daff;
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .child-entry {
                padding: 12px;
                margin: 12px 0;
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            min-width: 600px;
        }

        @media (max-width: 768px) {
            table {
                min-width: 100%;
                font-size: 0.85rem;
                border-spacing: 0 6px;
            }
            
            th, td {
                padding: 6px 3px;
                font-size: 0.8rem;
            }
            
            th {
                padding: 6px 4px;
            }
        }
        
        @media (max-width: 480px) {
            table {
                font-size: 0.75rem;
                border-spacing: 0 4px;
            }
            
            th, td {
                padding: 4px 2px;
                font-size: 0.7rem;
            }
            
            /* Abbreviate column headers on very small screens */
            th {
                font-size: 0.65rem;
                padding: 4px 2px;
            }
            
            /* Extra small buttons in tables */
            table .btn-sm,
            table button {
                font-size: 0.6rem;
                padding: 3px 6px;
                border-radius: 4px;
            }
            
            /* Make action emojis smaller */
            .volunteer-actions {
                font-size: 1.2rem;
            }
        }

        th {
            background: var(--primary);
            color: white;
            padding: 8px;
            border-radius: 12px 12px 0 0;
        }

        td {
            background: white;
            padding: 8px;
            border-radius: 12px;
        }

        .phone-cell {
            display: table-cell;
            filter: blur(5px);
            cursor: pointer;
            transition: filter 0.3s;
        }

        .phone-revealed .phone-cell {
            filter: none;
            cursor: default;
        }

        .volunteer-name,
        .volunteer-phone {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .volunteer-name:hover,
        .volunteer-phone:hover {
            background: #e8f0fe;
            text-decoration: underline;
        }

        .volunteer-actions {
            font-size: 1.4rem;
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            opacity: 0.7;
        }

        .volunteer-actions:hover {
            opacity: 1;
            transform: scale(1.15);
        }

        .inline-edit {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .inline-edit input {
            font-size: 1rem;
            padding: 4px 8px;
            width: 140px;
            border: 1px solid #a3d0ff;
            border-radius: 6px;
        }

        .add-vol-form {
            margin-top: 12px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 12px;
            border: 1px solid #d1e3ff;
        }

        #buzzer-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            max-width: 600px;
            margin: 30px auto;
            justify-items: center;
        }

        .buzzer-btn {
            font-size: 1.6rem;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #d1e3ff;
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            max-width: 80px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buzzer-btn:hover:not(.unavailable) {
            background: var(--primary-light);
            transform: scale(1.08);
        }

        .buzzer-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.3);
        }

        .buzzer-btn.unavailable {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .buzzer-btn.available {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        /* TABLET & MOBILE LANDSCAPE - 4 columns (24√∑4=6 rows, perfect!) */
        @media (max-width: 768px) {
            #buzzer-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                max-width: 400px;
                margin: 20px auto;
            }
            
            .buzzer-btn {
                font-size: 1.4rem;
                padding: 16px;
                max-width: 90px;
            }
        }

        /* MOBILE PORTRAIT - 4 columns still works perfectly */
        @media (max-width: 480px) {
            #buzzer-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                max-width: 100%;
                padding: 0 10px;
            }
            
            .buzzer-btn {
                font-size: 1.2rem;
                padding: 14px;
                max-width: none;
            }
        }

        .membership-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }

        .schedule-list {
            margin: 20px 0;
        }

        .schedule-item {
            background: #f8fbff;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .schedule-item {
                padding: 10px 12px;
                gap: 6px;
            }
        }

        .schedule-item.open {
            background: #e6ffe6;
            border-color: #b3ffb3;
        }

        .volunteer-form {
            background: var(--card);
            border-radius: 24px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin: 20px 0;
        }

        /* Clock and date display */
        .datetime-display {
            text-align: center;
            margin: 20px 0 30px;
        }

        .current-date {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(74, 144, 226, 0.2);
        }

        .current-time {
            font-size: 3.2rem;
            color: var(--success);
            font-weight: 700;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(80, 200, 120, 0.3);
        }

        .day-name {
            font-size: 1.3rem;
            color: #7f8c8d;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Modern Admin Styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3f2fd;
        }

/* Red X button over username for admin, view-checkins, and view-schedule */
#admin-content .card-close-btn,
#view-checkins .card-close-btn,
#view-schedule .card-close-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 10001;
    background: #ef4444;
    border: none;
    font-size: 28px;
    cursor: pointer;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

#admin-content .card-close-btn:hover,
#view-checkins .card-close-btn:hover,
#view-schedule .card-close-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.6);
}

#admin-content.hidden .card-close-btn,
#view-checkins.hidden .card-close-btn,
#view-schedule.hidden .card-close-btn {
    display: none;
}

/* Ensure button is on top in both landscape and portrait */
@media (orientation: portrait) {
    #admin-content .card-close-btn,
    #view-checkins .card-close-btn,
    #view-schedule .card-close-btn {
        top: -3px;
        right: -3px;
    }
}

@media (orientation: landscape) {
    #admin-content .card-close-btn,
    #view-checkins .card-close-btn,
    #view-schedule .card-close-btn {
        top: -3px;
        right: -3px;
    }
}

        .admin-section {
            background: #f8fbff;
            border-radius: 12px;
            padding: 18px;
            margin: 15px 0;
            border: 1px solid #d1e3ff;
            box-sizing: border-box;
            overflow: hidden;
            max-width: 100%;
        }

        .admin-section h2 {
            color: var(--primary);
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .admin-section {
                padding: 12px;
                margin: 10px 0;
            }
            
            .admin-section h2 {
                font-size: 1.1rem;
            }
        }
        
        /* Responsive database cards */
        @media (max-width: 768px) {
            /* Volunteer database - stack Quick Assign below name/phone on smaller screens */
            #volunteer-database-content > div > div {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            #volunteer-database-content > div > div > div:last-child {
                width: 100%;
                justify-content: space-between;
            }
            
            /* Adjust Quick Assign controls */
            #volunteer-database-content select,
            #volunteer-database-content .btn-primary {
                font-size: 0.7rem !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Further reduce sizes on very small screens */
            #volunteer-database-content > div,
            #family-database-content > div,
            #supervisor-database-content > div {
                padding: 10px !important;
                margin: 8px 0 !important;
            }
            
            #volunteer-database-content strong,
            #family-database-content strong,
            #supervisor-database-content strong {
                font-size: 1rem !important;
            }
            
            #volunteer-database-content span,
            #family-database-content span,
            #supervisor-database-content span {
                font-size: 0.85rem !important;
            }
            
            .btn-icon {
                padding: 3px 6px !important;
                font-size: 0.75rem !important;
            }
        }
        
        /* Two-column grid for admin sections */
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .admin-grid .admin-section {
            margin: 0;
        }
        
        /* Make some sections full-width */
        .admin-section.full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 900px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .admin-table {
            background: white;
            border-radius: 12px;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .admin-table table {
            margin: 0;
        }

        .admin-table th {
            background: linear-gradient(135deg, var(--primary), #6bb6ff);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            padding: 6px 4px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .admin-table th {
                font-size: 0.65rem;
                padding: 5px 3px;
                letter-spacing: 0.1px;
            }
        }
        
        @media (max-width: 480px) {
            .admin-table th {
                font-size: 0.6rem;
                padding: 4px 2px;
            }
        }

        .admin-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .admin-table tr:hover td {
            background: #f8fbff;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            padding: 0;
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-edit:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 8px 12px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-width: 70px;
            height: auto;
            font-size: 0.7rem;
            line-height: 1.2;
            white-space: nowrap;
        }

        .btn-delete:hover {
            background: #dc2626;
            color: white;
            transform: scale(1.05);
        }
        
        .btn-delete .icon {
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .btn-delete .text {
            font-size: 0.65rem;
            line-height: 1.1;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .btn-delete {
                padding: 6px 8px;
                min-width: 60px;
                font-size: 0.65rem;
                gap: 1px;
            }
            
            .btn-delete .icon {
                font-size: 1rem;
            }
            
            .btn-delete .text {
                font-size: 0.55rem;
            }
        }
        
        @media (max-width: 480px) {
            .btn-delete {
                padding: 5px 6px;
                min-width: 55px;
                font-size: 0.6rem;
            }
            
            .btn-delete .icon {
                font-size: 0.9rem;
            }
            
            .btn-delete .text {
                font-size: 0.5rem;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .editable-field {
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-block;
            min-width: 100px;
        }

        .editable-field:hover {
            background: #e3f2fd;
        }

        .edit-input {
            padding: 6px 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 1rem;
            width: 150px;
        }

        /* Professional modern numpad - fully responsive */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 100%;
            width: 100%;
            margin: 20px auto;
            padding: 0;
        }

        @media (min-width: 480px) {
            .numpad {
                gap: 14px;
                max-width: 360px;
                padding: 10px;
            }
        }

        @media (min-width: 768px) {
            .numpad {
                gap: 16px;
                max-width: 380px;
                padding: 15px;
            }
        }

        .numpad-btn {
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* Makes it square using aspect ratio trick */
            position: relative;
            font-size: clamp(1.4rem, 4vw, 2rem);
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            box-shadow: 
                6px 6px 12px rgba(163, 208, 255, 0.15),
                -6px -6px 12px rgba(255, 255, 255, 0.9),
                inset 0 0 0 1px rgba(74, 144, 226, 0.1);
            color: var(--primary);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            touch-action: manipulation;
        }

        .numpad-btn::before {
            content: attr(data-value);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* For buttons with text content, display it */
        .numpad-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            height: auto;
            aspect-ratio: 1;
            min-height: 60px;
        }

        @media (min-width: 480px) {
            .numpad-btn {
                min-height: 70px;
                border-radius: 14px;
            }
        }

        @media (min-width: 768px) {
            .numpad-btn {
                min-height: 80px;
                border-radius: 16px;
                font-size: 2rem;
            }
        }

        .numpad-btn:active {
            transform: scale(0.95);
            background: linear-gradient(145deg, #e3f2fd, #d1e7ff);
            box-shadow: 
                3px 3px 6px rgba(163, 208, 255, 0.3) inset,
                -2px -2px 4px rgba(255, 255, 255, 0.5) inset;
        }

        @media (hover: hover) {
            .numpad-btn:hover {
                background: linear-gradient(145deg, #f0f7ff, #e3f2fd);
                box-shadow: 
                    4px 4px 10px rgba(163, 208, 255, 0.25),
                    -4px -4px 10px rgba(255, 255, 255, 0.95),
                    inset 0 0 0 1px rgba(74, 144, 226, 0.2);
                transform: translateY(-2px);
            }
        }

        .numpad-btn.small-btn {
            font-size: clamp(1rem, 3vw, 1.4rem);
            font-weight: 600;
            background: linear-gradient(145deg, #ffebee, #fce4ec);
            color: #d32f2f;
            box-shadow: 
                4px 4px 8px rgba(255, 182, 193, 0.15),
                -4px -4px 8px rgba(255, 255, 255, 0.9),
                inset 0 0 0 1px rgba(211, 47, 47, 0.1);
        }

        @media (hover: hover) {
            .numpad-btn.small-btn:hover {
                background: linear-gradient(145deg, #fce4ec, #f8bbd0);
                box-shadow: 
                    3px 3px 8px rgba(255, 182, 193, 0.25),
                    -3px -3px 8px rgba(255, 255, 255, 0.95),
                    inset 0 0 0 1px rgba(211, 47, 47, 0.2);
            }
        }

        .numpad-btn.small-btn:active {
            background: linear-gradient(145deg, #f8bbd0, #f48fb1);
            box-shadow: 
                3px 3px 6px rgba(211, 47, 47, 0.3) inset,
                -2px -2px 4px rgba(255, 255, 255, 0.5) inset;
        }

        #pin-display {
            font-size: clamp(2rem, 6vw, 3.2rem);
            font-weight: 700;
            text-align: center;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #f8fbff);
            border: 3px solid rgba(74, 144, 226, 0.15);
            border-radius: 16px;
            margin: 20px auto;
            max-width: 100%;
            min-height: 70px;
            letter-spacing: clamp(10px, 3vw, 20px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            box-shadow: 
                6px 6px 15px rgba(163, 208, 255, 0.12),
                -6px -6px 15px rgba(255, 255, 255, 0.95),
                inset 0 2px 4px rgba(74, 144, 226, 0.05);
        }

        @media (min-width: 480px) {
            #pin-display {
                padding: 24px;
                min-height: 80px;
                border-radius: 18px;
            }
        }

        @media (min-width: 768px) {
            #pin-display {
                padding: 28px;
                min-height: 90px;
                border-radius: 20px;
                max-width: 340px;
            }
        }

        /* Password modal content */
        #password-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 95%;
            max-width: 420px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        @media (min-width: 480px) {
            #password-content {
                padding: 28px;
            }
        }

        @media (min-width: 768px) {
            #password-content {
                padding: 32px;
                width: 90%;
            }
        }

        /* Centered alert modal */
        .centered-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .centered-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .centered-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .centered-modal-content h3 {
            margin-top: 0;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            .centered-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            .centered-modal-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        /* Login Screen Styles */
        #login-screen {
            max-width: 450px;
            margin: 100px auto;
        }

        #login-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .login-form {
            margin: 30px auto;
            max-width: 400px;
            width: 100%;
        }

        #church-code-field {
            margin: 0;
        }

        #church-code-field label {
            display: block;
            margin: 20px 0 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin: 20px 0 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            text-align: left;
        }

        .login-form input[type="email"],
        .login-form input[type="password"],
        .login-form input[type="text"] {
            width: 100% !important;
            max-width: 100% !important;
            padding: 14px 16px;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            margin: 0;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 28px;
            transition: all 0.2s;
        }

        .btn-login:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }

        .login-toggle {
            text-align: center;
            margin-top: 24px;
            color: #666;
            font-size: 0.95rem;
        }

        .login-toggle a {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .profile-circle {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .profile-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(74, 144, 226, 0.3);
        }

        .profile-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 220px;
            display: none;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown strong {
            color: var(--primary);
            display: block;
            margin-bottom: 12px;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        .loading-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success-message {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        /* Cloud sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }

        /* Custom Numpad */
        .numpad-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }

        .numpad-overlay.show {
            display: flex;
        }

        .numpad-container {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 360px;
            width: 90%;
        }

        .numpad-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 2rem;
            text-align: center;
            font-family: monospace;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            border: 2px solid #e0e0e0;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .numpad-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 24px;
            border-radius: 12px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .numpad-btn:hover {
            background: #3a7bc8;
            transform: scale(1.05);
        }

        .numpad-btn:active {
            transform: scale(0.95);
        }

        .numpad-btn-zero {
            grid-column: 2;
        }

        .numpad-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .numpad-backspace {
            background: #ff9800;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
        }

        .numpad-ok {
            background: var(--success);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
        }

        .numpad-backspace:hover {
            background: #f57c00;
        }

        .numpad-ok:hover {
            background: #45b565;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #50c878;
        }

        .sync-dot.syncing {
            background: #ffaa33;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========================================
           MOBILE & TABLET OPTIMIZATIONS
           Optimized for both landscape and portrait
           ======================================== */
        
        /* Universal mobile improvements */
        * {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        /* Touch-friendly minimum sizes for all interactive elements */
        button, a, input, select, .clickable, .kid-card, .btn-icon {
            min-height: 44px; /* Apple's recommended touch target */
        }

        /* Prevent text selection on interactive elements */
        button, .numpad-btn, .kid-card {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Better scrolling everywhere */
        .table-container, .modal-overlay, .modal-content, .card {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Better touch feedback */
        button:active, .kid-card:active, .numpad-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        /* TABLET (iPad & larger tablets) */
        @media (max-width: 1024px) {
            body {
                padding: 12px;
            }
            
            h1 {
                font-size: clamp(1.6rem, 4vw, 2rem);
            }
            
            h2 {
                font-size: clamp(1.3rem, 3.5vw, 1.7rem);
            }
            
            .card {
                padding: 20px;
            }
            
            .main-buttons button {
                font-size: 1.3rem;
                padding: 20px 40px;
                max-width: 100%;
            }
            
            /* Forms - prevent iOS zoom */
            input[type="text"],
            input[type="tel"],
            input[type="number"],
            input[type="password"],
            input[type="email"],
            select {
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px;
            }
            
            /* Modal adjustments */
            .modal-content,
            .numpad-container,
            .centered-modal-content {
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Admin grid for tablets */
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            /* Stats responsive */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-number {
                font-size: 2.2rem;
            }
            
            /* Numpad for tablets */
            .numpad-container {
                max-width: 400px;
            }
            
            .numpad-btn {
                padding: 20px;
                font-size: 1.8rem;
                min-height: 70px;
            }
        }
        
        /* MOBILE PHONES (portrait and landscape) */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .card {
                padding: 16px;
                border-radius: 16px;
                margin: 12px 0;
            }
            
            h1, h2 {
                font-size: clamp(1.3rem, 5vw, 1.6rem);
                margin-bottom: 0.5em;
            }
            
            h3 {
                font-size: clamp(1.1rem, 4vw, 1.3rem);
            }
            
            /* Main buttons mobile */
            .main-buttons {
                margin: 25px 0 20px;
                gap: 14px;
            }
            
            .main-buttons button {
                padding: 16px 32px;
                font-size: clamp(1.1rem, 3vw, 1.3rem);
                border-radius: 16px;
            }
            
            /* Standard buttons mobile */
            button:not(.main-buttons button, .numpad-btn) {
                font-size: 1rem;
                padding: 11px 22px;
                margin: 8px 4px;
            }
            
            .btn-sm {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            /* Make table buttons extra small on mobile */
            table .btn-sm,
            table button {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            /* Forms mobile - CRITICAL for iOS */
            input[type="tel"],
            input[type="text"],
            input[type="password"],
            input[type="email"],
            input[type="number"],
            select {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 12px 14px;
                -webkit-appearance: none;
            }
            
            /* Numpad mobile optimized */
            .numpad {
                gap: 10px;
                padding: 12px;
                max-width: 100%;
                margin: 20px auto;
            }
            
            .numpad-btn {
                width: 100%;
                height: auto;
                aspect-ratio: 1;
                padding: 14px;
                font-size: clamp(1.4rem, 5vw, 2rem);
                border-radius: 12px;
                min-height: 65px;
            }
            
            .numpad-btn.small-btn {
                font-size: clamp(1.1rem, 4vw, 1.5rem);
            }
            
            #pin-display {
                font-size: clamp(2rem, 7vw, 3rem);
                padding: 18px;
                min-height: 70px;
                letter-spacing: 10px;
            }
            
            /* Numpad overlay mobile */
            .numpad-container {
                padding: 16px;
                width: 95%;
                max-width: 95vw;
            }
            
            .numpad-display {
                font-size: 1.6rem;
                padding: 16px;
                min-height: 55px;
            }
            
            .numpad-grid .numpad-btn {
                padding: 20px;
                font-size: 1.6rem;
            }
            
            .numpad-actions button {
                padding: 16px;
                font-size: 1.1rem;
            }
            
            /* Tables mobile - horizontal scroll */
            .table-container {
                overflow-x: auto;
                margin: 15px -8px; /* Extend to edges */
            }
            
            table {
                font-size: 0.85rem;
                min-width: 600px; /* Force horizontal scroll */
            }
            
            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            .admin-table th {
                font-size: 0.75rem;
                padding: 7px 5px;
            }
            
            .admin-table td {
                padding: 7px 5px;
                font-size: 0.85rem;
            }
            
            /* Kids grid mobile */
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 10px;
                margin: 15px 0;
            }
            
            .kid-card {
                padding: 12px;
                border-radius: 10px;
            }
            
            .kid-card h3 {
                font-size: 1rem;
                margin: 6px 0;
            }
            
            .kid-card p {
                font-size: 0.85rem;
            }
            
            /* Modals mobile */
            #confirm-content,
            .success-content,
            .centered-modal-content {
                padding: 22px;
                width: 92%;
                max-width: 92vw;
            }
            
            #confirm-content h3,
            .success-content h2 {
                font-size: 1.25rem;
            }
            
            #confirm-content .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            #confirm-content button {
                width: 100%;
                margin: 0;
            }
            
            .success-icon {
                font-size: 3.5rem;
            }
            
            /* Login screen mobile */
            #login-screen {
                margin: 25px auto;
                padding: 0 8px;
                max-width: 100%;
            }
            
            #login-screen h1 {
                font-size: 1.9rem;
                margin-bottom: 8px;
            }
            
            .login-form input {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 13px;
            }
            
            .btn-login {
                padding: 15px;
                font-size: 1.1rem;
            }
            
            /* User profile mobile */
            .user-info {
                top: 8px;
                right: 8px;
            }
            
            .profile-circle {
                width: 42px;
                height: 42px;
                font-size: 1.1rem;
            }
            
            .profile-dropdown {
                top: 54px;
                min-width: 190px;
                font-size: 0.9rem;
                padding: 12px 16px;
            }
            
            .profile-dropdown button {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
            
            /* Sync indicator mobile */
            .sync-indicator {
                bottom: 8px;
                right: 8px;
                padding: 7px 11px;
                font-size: 0.8rem;
            }
            
            .sync-dot {
                width: 7px;
                height: 7px;
            }
            
            /* Admin sections mobile */
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .admin-section {
                padding: 14px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            /* Action buttons mobile */
            .action-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .btn-icon {
                width: 36px;
                height: 36px;
                font-size: 1.05rem;
            }
        }
        
        /* LANDSCAPE mode optimizations (phones in landscape) */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 5px;
            }
            
            .card {
                padding: 10px;
                margin: 8px 0;
            }
            
            h1, h2 {
                font-size: 1.3rem;
                margin-bottom: 0.3em;
            }
            
            .main-buttons {
                margin: 12px 0 8px;
                gap: 10px;
            }
            
            .main-buttons button {
                padding: 12px 28px;
                font-size: 1.1rem;
            }
            
            #login-screen {
                margin: 15px auto;
            }
            
            #login-screen h1 {
                font-size: 1.5rem;
            }
            
            .login-form input {
                padding: 10px;
            }
            
            .modal-content,
            .numpad-container,
            .centered-modal-content {
                max-height: 85vh;
                padding: 15px;
            }
            
            #pin-display {
                padding: 12px;
                min-height: 50px;
                font-size: 2rem;
            }
            
            .numpad {
                gap: 8px;
                padding: 10px;
            }
            
            .numpad-btn {
                min-height: 52px;
                padding: 10px;
                font-size: 1.5rem;
            }
            
            .numpad-display {
                padding: 10px;
                font-size: 1.3rem;
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
            
            .kid-card {
                padding: 8px;
            }
        }
        
        /* SMALL PHONES (iPhone SE, etc) */
        @media (max-width: 375px) {
            body {
                padding: 6px;
            }
            
            .card {
                padding: 12px;
                margin: 10px 0;
            }
            
            h1, h2 {
                font-size: 1.3rem;
            }
            
            .main-buttons button {
                padding: 14px 24px;
                font-size: 1.1rem;
            }
            
            .numpad-btn {
                min-height: 58px;
                font-size: 1.5rem;
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
                gap: 8px;
            }
            
            table {
                font-size: 0.75rem;
                min-width: 500px;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 0.95rem;
            }
        }
        
        /* TABLET LANDSCAPE (iPad in landscape, etc) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            }
            
            .numpad {
                max-width: 380px;
            }
        }
        
        /* TABLET PORTRAIT (iPad in portrait) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
        
        /* iOS SAFE AREA support (iPhone X and newer) */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: max(8px, env(safe-area-inset-top));
                padding-bottom: max(8px, env(safe-area-inset-bottom));
                padding-left: max(8px, env(safe-area-inset-left));
                padding-right: max(8px, env(safe-area-inset-right));
            }
            
            .user-info {
                top: max(8px, env(safe-area-inset-top));
                right: max(8px, env(safe-area-inset-right));
            }
            
            .sync-indicator {
                bottom: max(8px, env(safe-area-inset-bottom));
                right: max(8px, env(safe-area-inset-right));
            }
        }
        
        /* Disable hover effects on touch devices */
        @media (hover: none) and (pointer: coarse) {
            .numpad-btn:hover,
            .main-buttons button:hover,
            .btn-icon:hover,
            .kid-card:hover,
            button:hover {
                transform: none !important;
                box-shadow: none !important;
                background: inherit !important;
            }
        }
    </style>
</head>

<body>
    <!-- Custom Numpad Overlay -->
    <div class="numpad-overlay" id="numpad-overlay">
        <div class="numpad-container">
            <div class="numpad-display" id="numpad-display">(000) 000-0000</div>
            <div class="numpad-grid">
                <button class="numpad-btn" onclick="numpadPress('1')">1</button>
                <button class="numpad-btn" onclick="numpadPress('2')">2</button>
                <button class="numpad-btn" onclick="numpadPress('3')">3</button>
                <button class="numpad-btn" onclick="numpadPress('4')">4</button>
                <button class="numpad-btn" onclick="numpadPress('5')">5</button>
                <button class="numpad-btn" onclick="numpadPress('6')">6</button>
                <button class="numpad-btn" onclick="numpadPress('7')">7</button>
                <button class="numpad-btn" onclick="numpadPress('8')">8</button>
                <button class="numpad-btn" onclick="numpadPress('9')">9</button>
                <button class="numpad-btn numpad-btn-zero" onclick="numpadPress('0')">0</button>
            </div>
            <div class="numpad-actions">
                <button class="numpad-backspace" onclick="numpadBackspace()">‚å´ Backspace</button>
                <button class="numpad-ok" onclick="numpadOK()">‚úì OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Login/Signup Screen -->
        <div id="login-screen" class="card">
            <h1>‚òÅÔ∏è Bible Land Check-In</h1>
            
            <div id="login-error" class="error-message hidden"></div>
            <div id="login-success" class="success-message hidden"></div>
            
            <div class="login-form">
                <label>Email</label>
                <input type="email" id="auth-email" placeholder="your@email.com" autocomplete="email">
                
                <label>Password</label>
                <input type="password" id="auth-password" placeholder="Enter password (min 6 characters)" autocomplete="current-password">
                
                <div id="church-code-field" class="hidden">
                    <label>Church Code (required for signup)</label>
                    <input type="text" id="church-code" placeholder="Enter church code">
                </div>
                
                <button class="btn-login" id="btn-login" onclick="handleLogin()">Sign In</button>
            </div>
            
            <div class="login-toggle">
                <span id="toggle-text">Don't have an account? </span>
                <a onclick="toggleAuthMode()" id="toggle-link">Create one</a>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="card hidden">
            <div class="loading-screen">
                <div class="spinner"></div>
                <p style="font-size: 1.2rem; color: var(--primary);">Loading your data from the cloud...</p>
            </div>
        </div>

        <!-- Service Selection Screen (shown after login if no service selected) -->
        <div id="service-selection-screen" class="card hidden">
            <h1>Select Your Service</h1>
            <p style="text-align: center; color: #666; margin-bottom: 40px;">Choose which service you'll be checking in for today</p>
            <div class="main-buttons">
                <button style="background: #ff6b6b; font-size: 1.4rem;" onclick="selectService('russian')">
                    üá∑üá∫ Russian Service<br>
                    <span style="font-size: 0.9rem; opacity: 0.9;">9:00 AM</span>
                </button>
                <button style="background: #4a90e2; font-size: 1.4rem;" onclick="selectService('english')">
                    üá∫üá∏ English Service<br>
                    <span style="font-size: 0.9rem; opacity: 0.9;">12:00 PM</span>
                </button>
            </div>
        </div>

        <!-- Main App Container (shown after login) -->
        <div id="main-app-container" class="hidden">
            <!-- User Info Display -->
            <div class="user-info">
                <div class="profile-circle" onclick="toggleProfileDropdown()">
                    <span id="user-initial">U</span>
                </div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <strong id="user-email-display"></strong>
                    <div style="margin: 10px 0; padding: 8px; background: #f0f7ff; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">Current Service:</div>
                        <div id="profile-service-display" style="font-weight: 600; color: #1976d2; font-size: 0.9rem;">Loading...</div>
                        <button onclick="showServiceSwitchModal(); toggleProfileDropdown();" 
                                style="margin-top: 8px; padding: 6px 12px; font-size: 0.8rem; background: #4a90e2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Switch Service
                        </button>
                    </div>
                    <a href="#" onclick="event.preventDefault(); requestCurrentPasswordForChange(); toggleProfileDropdown();" 
                       style="font-size: 0.85rem; color: #4a90e2; text-decoration: none; display: block; margin: 8px 0; padding: 4px 0;">
                        Change Admin Password
                    </a>
                    <button class="btn-primary" onclick="showAdminPasswordModal(); toggleProfileDropdown();" style="width: 100%; margin-bottom: 8px;">Admin</button>
                    <button class="btn-logout" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <!-- Sync Indicator -->
            <div class="sync-indicator">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-text">Synced</span>
            </div>

        <!-- MAIN MENU -->
        <div id="main-screen" class="card">
            <h1>Bible Land Check-In </h1>
            <div style="text-align: center; margin: -10px 0 10px 0;">
                <span id="current-service-display" style="display: inline-block; background: #e3f2fd; color: #1976d2; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1rem;">
                    <!-- Service will be displayed here -->
                </span>
            </div>
            <div class="datetime-display">
                <div class="current-date" id="current-date">February 5, 2026</div>
                <div class="current-time" id="current-time">22:01:39</div>
                <div class="day-name" id="day-name">Thursday</div>
            </div>
            <div class="main-buttons">
                <button id="btn-checkin" onclick="showMembership()">Check In Child(ren)</button>
                <button id="btn-view" onclick="showViewCheckInsPasswordModal()">View Current Check-Ins</button>
                <button id="btn-schedule" onclick="showScheduleView()">View Schedule</button>
            </div>
        </div>
        <!-- Membership -->
        <div id="membership-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Are you a member? üë™</h1>
            <div class="membership-buttons">
                <button class="btn-primary" onclick="selectMembership(&#39;member&#39;)">Yes, Member</button>
                <button class="btn-outline" onclick="selectMembership(&#39;non-member&#39;)">No, Non-Member</button>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-outline" onclick="backToMain()">‚Üê Back</button>
            </div>
        </div>
        <!-- Non-member phone entry -->
        <div id="nonmem-phone-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Parent Phone Number</h1>
            <p style="text-align:center; color:#555;">Enter phone to load existing family info or add new</p>
            <label>Phone: <input type="tel" id="nonmem-phone" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this); onNonMemberPhoneInput()"></label><br><br>
            <button class="btn-primary" id="continue-nonmember">Continue</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer phone first -->
        <div id="volunteer-phone-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Volunteer Sign-Up</h1>
            <h2>Step 1: Your Phone Number</h2>
            <label>Phone: <input type="tel" id="vol-phone-first" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this); onVolunteerPhoneInput()"></label><br><br>
            <button class="btn-primary" id="continue-member">Continue</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer name -->
        <div id="volunteer-form" class="volunteer-form hidden" style="position: relative;">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h2>Step 2: Your Name</h2>
            <label>First Name: <input type="text" id="vol-first" placeholder="First name"></label><br>
            <label>Last Name: <input type="text" id="vol-last" placeholder="Last name"></label><br><br>
            <button class="btn-success" onclick="showVolunteerScheduleAfterName()">Continue to Schedule</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer schedule -->
        <div id="volunteer-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Volunteer Schedule</h1>
            <div id="volunteer-schedule">
                <h2>Upcoming Sundays (2 spots each)</h2>
                <div id="schedule-list" class="schedule-list"></div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-outline" onclick="skipVolunteerSchedule()">Skip</button>
            </div>
        </div>
        <!-- Buzzer selection -->
        <div id="buzzer-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Choose Buzzer Number üîî</h1>
            <p style="text-align:center; color:#555;">Green = available ¬∑ Red = in use</p>
            <div id="buzzer-grid"></div>
            <div style="text-align:center; margin-top:30px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                <button class="btn-outline" onclick="backFromBuzzerToInfo()">‚Üê Back to Info</button>
                <button class="btn-outline" onclick="backToMain()">Cancel</button>
            </div>
        </div>
        <!-- Parent + children info -->
        <div id="info-form" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Parent &amp; Children üòä</h1>
            <label>Phone: <input type="tel" id="phone" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this); onPhoneInput()"></label><br>
            <label>First name: <input type="text" id="firstName" placeholder="Parent first name"></label><br>
            <label>Last name: <input type="text" id="lastName" placeholder="Parent last name"></label><br>
            <h2>Children</h2>
            <div id="children-list"></div>
            <button class="btn-primary" onclick="addChildEntry()">+ Add child</button>
            <div style="margin-top:40px; text-align:center;">
                <button class="btn-success" onclick="finishCheckIn()">Check In Now</button>
                <button class="btn-outline" onclick="backToMain()">Cancel</button>
            </div>
        </div>
        <!-- Success modal -->
        <div id="success-modal" class="success-modal hidden">
            <div class="success-content">
                            <h2>Success! üéâ</h2>
                <p id="success-text"></p>
                <button class="btn-success" onclick="document.getElementById('success-modal').classList.add('hidden'); backToMain();">OK</button>
            </div>
        </div>
        <!-- View current check-ins -->
        <div id="view-checkins" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Currently Checked In üéâ</h1>
            
            <!-- Service Filter -->
            <div style="text-align: center; margin: 15px 0;">
                <label style="font-weight: 600; margin-right: 10px;">Filter by Service:</label>
                <select id="checkin-service-filter" onchange="renderCheckInTable()" 
                        style="padding: 8px 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                    <option value="all">All Services</option>
                    <option value="russian">üá∑üá∫ Russian (9 AM)</option>
                    <option value="english">üá∫üá∏ English (12 PM)</option>
                </select>
            </div>
            
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 20px 0;">
            <table id="checkin-table">
                <thead>
                    <tr>
                        <th>Buzzer</th>
                        <th>Child</th>
                        <th>Age</th>
                        <th>Allergies</th>
                        <th>Family</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
            <div style="margin-top:30px; text-align:center;">
                <button class="btn-outline" onclick="backToMain()">Back to Menu</button>
            </div>
        </div>
        <!-- Admin Area -->
        <div id="admin-content" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <div class="admin-header">
                <h1 style="margin: 0;">Admin Dashboard üîß</h1>
                <button class="btn-outline" onclick="backToMain()">‚Üê Back to Menu</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-checked-in">0</div>
                    <div class="stat-label">Currently Checked In</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="stat-volunteers">0</div>
                    <div class="stat-label">Total Volunteers</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="stat-upcoming">0</div>
                    <div class="stat-label">Upcoming Openings</div>
                </div>
            </div>

            <!-- Volunteer Schedule - Full Width -->
            <div class="admin-section full-width">
                <h2><span class="section-icon">üìÖ</span> Volunteer Schedule</h2>
                <div class="admin-table">
                    <table id="admin-schedule-table">
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>Volunteer #1</th>
                                <th>Volunteer #2</th>
                                <th>Supervisor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Two-Column Grid for Databases -->
            <div class="admin-grid">
                <div class="admin-section">
                    <h2><span class="section-icon">üë•</span> Volunteer Database</h2>
                    <button class="btn-success btn-sm" onclick="toggleAddToDatabaseForm()" style="margin-bottom: 12px; font-size: 0.85rem; padding: 6px 12px;">+ Add Volunteer</button>
                    <div id="add-to-db-form" class="hidden add-vol-form">
                        <label>Phone: <input type="tel" id="db-vol-phone" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this)"></label><br>
                        <label>First &amp; Last: <input type="text" id="db-vol-name" placeholder="John Doe"></label><br>
                        <button class="btn-success btn-sm" onclick="addToVolunteerDatabase()">Save</button>
                        <button class="btn-outline btn-sm" onclick="toggleAddToDatabaseForm()">Cancel</button>
                    </div>
                    <div id="volunteer-database-content"></div>
                </div>

                <div class="admin-section">
                    <h2><span class="section-icon">üëî</span> Supervisor Database</h2>
                    <button class="btn-success btn-sm" onclick="toggleAddSupervisorForm()" style="margin-bottom: 12px; font-size: 0.85rem; padding: 6px 12px;">+ Add Supervisor</button>
                    <div id="add-supervisor-form" class="hidden add-vol-form">
                        <label>Phone: <input type="tel" id="super-phone" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this)"></label><br>
                        <label>First Name: <input type="text" id="super-first-name" placeholder="John"></label><br>
                        <label>Last Name: <input type="text" id="super-last-name" placeholder="Doe"></label><br>
                        <button class="btn-success btn-sm" onclick="addSupervisorToDatabase()">Save</button>
                        <button class="btn-outline btn-sm" onclick="toggleAddSupervisorForm()">Cancel</button>
                    </div>
                    <div id="supervisor-database-content"></div>
                </div>
            </div>

            <!-- Family Database - Full Width -->
            <div class="admin-section full-width">
                <h2><span class="section-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Family Database</h2>
                <button class="btn-success btn-sm" onclick="showAddFamilyModal()" style="margin-bottom: 12px; font-size: 0.85rem; padding: 6px 12px;">+ Add Family</button>
                <div id="family-database-content"></div>
            </div>

            <!-- Weekly Reports - Full Width -->
            <div class="admin-section full-width">
                <h2><span class="section-icon">üìä</span> Weekly Reports</h2>
                <div id="reports-content"></div>
            </div>
        </div>
        <!-- Custom checkout confirmation modal -->
        <div id="confirm-modal" class="hidden">
            <div id="confirm-content">
                <h3>Are you sure?</h3>
                <p>This will check out the selected child.</p>
                <div class="modal-buttons">
                    <button class="btn-danger" onclick="confirmCheckout()">OK</button>
                    <button class="btn-outline" onclick="closeConfirmModal()">Cancel</button>
                </div>
            </div>
        </div>
        <!-- Admin password modal -->
        <div id="admin-password-modal" class="hidden">
            <div id="password-content">
                <h2>Enter Admin PIN</h2>
                <div id="pin-display"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addPinDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addPinDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addPinDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addPinDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addPinDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addPinDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addPinDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addPinDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addPinDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deletePinDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addPinDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearPin()" title="Clear All">C</button>
                </div>
                <div style="margin-top:20px;">
                    <button class="btn-outline" onclick="closeAdminPasswordModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Admin Password Modal - Step 1: Current Password -->
        <div id="change-password-step1-modal" class="hidden modal-overlay">
            <div id="password-content" style="position: relative;">
                <h2 style="margin-top: 0; color: var(--primary);">Enter Current Admin PIN</h2>
                <div id="change-pin-display" style="font-size: clamp(2rem, 6vw, 3rem); letter-spacing: clamp(10px, 3vw, 16px); margin: 20px 0; min-height: 60px; color: var(--text); font-weight: 700;"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addChangePinDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteChangePinDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearChangePin()" title="Clear All">C</button>
                </div>
                <div style="margin-top:20px;">
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Admin Password Modal - Step 2: New Password Entry -->
        <div id="change-password-step2-modal" class="hidden modal-overlay">
            <div style="background: white; border-radius: 16px; padding: 24px; width: 95%; max-width: 420px; text-align: center; position: relative;">
                <h2 style="margin-top: 0; color: var(--primary); font-size: clamp(1.3rem, 4vw, 1.6rem);">Enter New Admin Password</h2>
                <p style="color: #50c878; margin-bottom: 15px;">‚úì Current password verified</p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 1rem);">New Password (4 digits):</label>
                    <div id="new-password-display" style="font-size: clamp(1.8rem, 5vw, 2.5rem); letter-spacing: clamp(8px, 2.5vw, 12px); margin: 12px 0; min-height: 50px; color: var(--text); font-weight: 700;"></div>
                </div>
                
                <div class="numpad">
                    <button class="numpad-btn" onclick="addNewPasswordDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteNewPasswordDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearNewPassword()" title="Clear All">C</button>
                </div>
                
                <div style="margin-top:20px;">
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Admin Password Modal - Step 3: Confirm Password Entry -->
        <div id="change-password-step3-modal" class="hidden modal-overlay">
            <div style="background: white; border-radius: 16px; padding: 24px; width: 95%; max-width: 420px; text-align: center; position: relative;">
                <h2 style="margin-top: 0; color: var(--primary); font-size: clamp(1.3rem, 4vw, 1.6rem);">Confirm New Password</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: clamp(0.9rem, 2.5vw, 1rem);">Enter the password again</p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 1rem);">Confirm Password (4 digits):</label>
                    <div id="confirm-password-display" style="font-size: clamp(1.8rem, 5vw, 2.5rem); letter-spacing: clamp(8px, 2.5vw, 12px); margin: 12px 0; min-height: 50px; color: var(--text); font-weight: 700;"></div>
                </div>
                
                <div class="numpad">
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteConfirmPasswordDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearConfirmPassword()" title="Clear All">C</button>
                </div>
                
                <div style="margin-top:20px;">
                    <button class="btn-outline" onclick="backToNewPassword()">‚Üê Back</button>
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Modal for Password Change -->
        <div id="password-confirm-modal" class="hidden modal-overlay-high">
            <div style="background: white; border-radius: 16px; padding: 24px; width: 95%; max-width: 380px; text-align: center; position: relative;">
                <h3 style="margin-top: 0; color: var(--text); font-size: clamp(1.2rem, 3.5vw, 1.4rem);">Are you sure?</h3>
                <p style="font-size: clamp(1rem, 2.5vw, 1.1rem); margin: 15px 0;">Do you want to change the admin password?</p>
                <div style="display: flex; gap: 10px; margin-top: 24px; justify-content: center;">
                    <button class="btn-success" onclick="finalizePasswordChange()" style="padding: 12px 24px;">
                        Yes, Change It
                    </button>
                    <button class="btn-outline" onclick="closePasswordConfirmModal()" style="padding: 12px 24px;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Validation modal -->
        <div id="validation-modal" class="hidden">
            <div id="validation-content">
                <h3>‚ö†Ô∏è Required Information</h3>
                <p id="validation-message"></p>
                <button class="btn-primary" onclick="closeValidationModal()">OK</button>
            </div>
        </div>
        <!-- Centered Alert Modal -->
        <div id="centered-alert" class="centered-modal hidden">
            <div class="centered-modal-content">
                <h3 id="alert-title">Alert</h3>
                <p id="alert-message" style="font-size: 1.1rem; margin: 20px 0;"></p>
                <button class="btn-primary" onclick="closeCenteredAlert()">OK</button>
            </div>
        </div>
        
        <!-- Service Switch Modal -->
        <div id="service-switch-modal" class="hidden modal-overlay-high">
            <div style="background: white; border-radius: 20px; padding: 32px; width: 95%; max-width: 450px; text-align: center;">
                <h2 style="margin-top: 0; color: var(--primary);">Switch Service</h2>
                <p style="color: #666; margin-bottom: 30px;">Select which service you want to check in for</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="confirmServiceSwitch('russian')" 
                            style="padding: 20px; font-size: 1.2rem; background: #ff6b6b; color: white; border: none; border-radius: 12px; cursor: pointer;">
                        üá∑üá∫ Russian Service<br>
                        <span style="font-size: 0.85rem; opacity: 0.9;">9:00 AM</span>
                    </button>
                    <button onclick="confirmServiceSwitch('english')" 
                            style="padding: 20px; font-size: 1.2rem; background: #4a90e2; color: white; border: none; border-radius: 12px; cursor: pointer;">
                        üá∫üá∏ English Service<br>
                        <span style="font-size: 0.85rem; opacity: 0.9;">12:00 PM</span>
                    </button>
                </div>
                <button class="btn-outline" onclick="closeServiceSwitchModal()" style="margin-top: 20px; width: 100%;">Cancel</button>
            </div>
        </div>
        
        <!-- Add Child to Buzzer Modal -->
        <div id="add-child-modal" class="hidden modal-overlay">
            <div style="background: white; border-radius: 16px; padding: 32px; width: 450px; max-width: 90%; position: relative;">
                <h2 style="margin-top: 0; color: var(--primary);">Add Child to Buzzer <span id="add-child-buzzer-num"></span></h2>
                <p style="color: #666; margin-bottom: 20px;">For: <strong id="add-child-parent-name"></strong></p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Child's Name:</label>
                    <input type="text" id="add-child-name" placeholder="Enter child's name"
                           style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Age (1-6):</label>
                    <select id="add-child-age"
                            style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; color:#bbb;" required onchange="this.style.color='#000'">
                        <option value="" disabled selected>Select</option>
                        <option value="1" style="color:#000;">1</option>
                        <option value="2" style="color:#000;">2</option>
                        <option value="3" style="color:#000;">3</option>
                        <option value="4" style="color:#000;">4</option>
                        <option value="5" style="color:#000;">5</option>
                        <option value="6" style="color:#000;">6</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Allergies:</label>
                    <select id="add-child-allergies" onchange="toggleAddChildOtherAllergy(); this.style.color='#000'"
                            style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; color:#bbb;" required>
                        <option value="" disabled selected>Select</option>
                        <option value="None" style="color:#000;">None</option>
                        <option value="Other" style="color:#000;">Other</option>
                    </select>
                    <input type="text" id="add-child-allergies-other" placeholder="Specify allergy" class="hidden"
                           style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; margin-top: 10px;">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-success" onclick="submitAddChild()" style="flex: 1;">
                        Add Child
                    </button>
                    <button class="btn-outline" onclick="closeAddChildModal()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Admin password is now stored in Firebase
        const storageKeys = {
            parents: 'kids_checkin_parents',
            checkIns: 'kids_checkin_list',
            usedBuzzers: 'kids_checkin_used_buzzers',
            volunteers: 'kids_checkin_volunteers',
            familyDatabase: 'kids_checkin_family_database',
            weeklyReports: 'kids_checkin_weekly_reports',
            supervisors: 'kids_checkin_supervisors',
            scheduledSupervisors: 'kids_checkin_scheduled_supervisors'
        };
        // Initialize on window so Firebase can sync
        var checkIns = window.checkIns = window.checkIns || [];
        var parents = window.parents = window.parents || {};
        var usedBuzzers = window.usedBuzzers = window.usedBuzzers || new Set();
        var volunteers = window.volunteers = window.volunteers || {};
        var familyDatabase = window.familyDatabase = window.familyDatabase || {};
        var supervisorDatabase = window.supervisorDatabase = window.supervisorDatabase || {};
        var scheduledSupervisors = window.scheduledSupervisors = window.scheduledSupervisors || {};
        var weeklyReports = window.weeklyReports = window.weeklyReports || {};
        let currentBuzzer = null;
        let childCounter = 0;
        let pendingAction = null;
        let isMemberPath = false;
        let memberPhone = null;
        let memberFirst = null;
        let memberLast = null;
        let pendingCheckoutIndex = null;
        let checkoutPasswordAttempts = 0;

        // ‚îÄ‚îÄ‚îÄ Custom Numpad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let numpadCurrentInput = null;
        let numpadValue = '';

        function showNumpad(inputElement) {
            numpadCurrentInput = inputElement;
            numpadValue = inputElement.value.replace(/\D/g, ''); // Get just digits
            updateNumpadDisplay();
            document.getElementById('numpad-overlay').classList.add('show');
        }

        function hideNumpad() {
            document.getElementById('numpad-overlay').classList.remove('show');
            numpadCurrentInput = null;
            numpadValue = '';
        }

        function updateNumpadDisplay() {
            const display = document.getElementById('numpad-display');
            if (numpadValue.length === 0) {
                display.textContent = '(000) 000-0000';
                display.style.color = '#999';
            } else {
                const formatted = formatPhoneForDisplay(numpadValue);
                display.textContent = formatted;
                display.style.color = 'var(--text)';
            }
        }

        function formatPhoneForDisplay(digits) {
            if (digits.length <= 3) {
                return `(${digits}`;
            } else if (digits.length <= 6) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            } else {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
            }
        }

        // Helper function to generate age dropdown HTML
        function getAgeDropdownHTML(className, selectedAge = '', style = '') {
            const ages = [1, 2, 3, 4, 5, 6];
            let options = '<option value="">Age</option>';
            ages.forEach(age => {
                const selected = selectedAge == age ? 'selected' : '';
                options += `<option value="${age}" ${selected}>${age}</option>`;
            });
            return `<select class="${className}" style="${style}" required>${options}</select>`;
        }

        function numpadPress(digit) {
            if (numpadValue.length < 10) {
                numpadValue += digit;
                updateNumpadDisplay();
                
                // Auto-close and apply when 10 digits entered
                if (numpadValue.length === 10) {
                    setTimeout(() => {
                        if (numpadCurrentInput) {
                            const formatted = formatPhoneForDisplay(numpadValue);
                            numpadCurrentInput.value = formatted;
                            
                            // Trigger the oninput event manually
                            const event = new Event('input', { bubbles: true });
                            numpadCurrentInput.dispatchEvent(event);
                        }
                        hideNumpad();
                    }, 300); // Small delay so user sees the complete number
                }
            }
        }

        function numpadBackspace() {
            if (numpadValue.length > 0) {
                numpadValue = numpadValue.slice(0, -1);
                updateNumpadDisplay();
            }
        }

        function numpadOK() {
            if (numpadCurrentInput) {
                const formatted = formatPhoneForDisplay(numpadValue);
                numpadCurrentInput.value = formatted;
                
                // Trigger the oninput event manually
                const event = new Event('input', { bubbles: true });
                numpadCurrentInput.dispatchEvent(event);
            }
            hideNumpad();
        }

        // Add click listeners to all phone inputs
        function setupPhoneInputs() {
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('focus', function() {
                    showNumpad(this);
                });
                // Prevent keyboard from showing on mobile
                input.setAttribute('readonly', 'readonly');
            });
        }

        // Setup phone inputs after a short delay to ensure DOM is ready
        setTimeout(setupPhoneInputs, 500);

        // ‚îÄ‚îÄ‚îÄ Clock and Date Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDateTime() {
            const now = new Date();
            
            // Update time
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
            
            // Update date
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = days[now.getDay()];
            const monthName = months[now.getMonth()];
            const date = now.getDate();
            const year = now.getFullYear();
            
            document.getElementById('current-date').textContent = `${monthName} ${date}, ${year}`;
            document.getElementById('day-name').textContent = dayName;
        }

        // Update clock every second
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Initial call

        // ‚îÄ‚îÄ‚îÄ Load / Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadData() {
            const loadedParents = JSON.parse(localStorage.getItem(storageKeys.parents)) || {};
            const loadedCheckIns = JSON.parse(localStorage.getItem(storageKeys.checkIns)) || [];
            const loadedUsedBuzzers = new Set(JSON.parse(localStorage.getItem(storageKeys.usedBuzzers)) || []);
            const loadedVolunteers = JSON.parse(localStorage.getItem(storageKeys.volunteers)) || {};
            const loadedFamilyDatabase = JSON.parse(localStorage.getItem(storageKeys.familyDatabase)) || {};
            const loadedWeeklyReports = JSON.parse(localStorage.getItem(storageKeys.weeklyReports)) || {};
            const loadedSupervisorDatabase = JSON.parse(localStorage.getItem(storageKeys.supervisors)) || {};
            const loadedScheduledSupervisors = JSON.parse(localStorage.getItem(storageKeys.scheduledSupervisors)) || {};
            
            // Replace arrays/objects (don't append)
            Object.keys(parents).forEach(k => delete parents[k]);
            Object.assign(parents, loadedParents);
            
            checkIns.length = 0; // Clear array
            checkIns.push(...loadedCheckIns);
            
            usedBuzzers.clear(); // Clear set
            loadedUsedBuzzers.forEach(b => usedBuzzers.add(b));
            
            Object.keys(volunteers).forEach(k => delete volunteers[k]);
            Object.assign(volunteers, loadedVolunteers);
            
            Object.keys(familyDatabase).forEach(k => delete familyDatabase[k]);
            Object.assign(familyDatabase, loadedFamilyDatabase);
            
            Object.keys(weeklyReports).forEach(k => delete weeklyReports[k]);
            Object.assign(weeklyReports, loadedWeeklyReports);
            
            Object.keys(supervisorDatabase).forEach(k => delete supervisorDatabase[k]);
            Object.assign(supervisorDatabase, loadedSupervisorDatabase);
            
            Object.keys(scheduledSupervisors).forEach(k => delete scheduledSupervisors[k]);
            Object.assign(scheduledSupervisors, loadedScheduledSupervisors);
            
            if (!volunteers.all) volunteers.all = [];
            checkAndSaveWeeklyReport(); // Check if we need to save today's report
        }

        window.saveData = function() {
            localStorage.setItem(storageKeys.parents, JSON.stringify(parents));
            localStorage.setItem(storageKeys.checkIns, JSON.stringify(checkIns));
            localStorage.setItem(storageKeys.usedBuzzers, JSON.stringify([...usedBuzzers]));
            localStorage.setItem(storageKeys.volunteers, JSON.stringify(volunteers));
            localStorage.setItem(storageKeys.familyDatabase, JSON.stringify(familyDatabase));
            localStorage.setItem(storageKeys.weeklyReports, JSON.stringify(weeklyReports));
            localStorage.setItem(storageKeys.supervisors, JSON.stringify(supervisorDatabase));
            localStorage.setItem(storageKeys.scheduledSupervisors, JSON.stringify(scheduledSupervisors));
        }
        // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function hideAll() {
            document.querySelectorAll('.card, .volunteer-form').forEach(c => c.classList.add('hidden'));
        }

        function show(id) {
            hideAll();
            document.getElementById(id).classList.remove('hidden');
            // Re-attach numpad to any new phone inputs
            setTimeout(setupPhoneInputs, 100);
        }

        function backToMain() {
            document.querySelectorAll('.buzzer-btn.selected').forEach(b => b.classList.remove('selected'));
            currentBuzzer = null;
            childCounter = 0;
            isMemberPath = false;
            memberPhone = null;
            memberFirst = null;
            memberLast = null;
            document.getElementById('children-list').innerHTML = '';
            show('main-screen');
        }

        function backFromBuzzerToInfo() {
            currentBuzzer = null;
            show('info-form');
        }
        // ‚îÄ‚îÄ‚îÄ Check-in flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showMembership() {
            show('membership-screen');
        }

        function selectMembership(type) {
            isMemberPath = (type === 'member');

            if (isMemberPath) {
                document.getElementById('vol-phone-first').value = '';
                show('volunteer-phone-screen');
                document.getElementById('vol-phone-first').focus();
            } else {
                document.getElementById('nonmem-phone').value = '';
                show('nonmem-phone-screen');
                document.getElementById('nonmem-phone').focus();
            }
        }

        // ‚îÄ‚îÄ‚îÄ Non-member phone pre-fill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onNonMemberPhoneInput() {
            const raw = document.getElementById('nonmem-phone').value;
            const phone = raw.replace(/\D/g, '');
            
            if (phone.length === 10) {
                // Check familyDatabase first, then parents
                if (familyDatabase[phone]) {
                    const family = familyDatabase[phone];
                    document.getElementById('firstName').value = family.firstName || '';
                    document.getElementById('lastName').value = family.lastName || '';
                } else if (parents[phone]) {
                    const p = parents[phone];
                    document.getElementById('firstName').value = p.firstName || '';
                    document.getElementById('lastName').value = p.lastName || '';
                } else {
                    // Unknown phone number - clear the autofilled fields
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                }
            } else if (phone.length < 10) {
                // Phone number incomplete - clear the autofilled fields
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
            }
        }

        function handleNonMemberPhone() {
            const input = document.getElementById('nonmem-phone');
            const phoneClean = input.value.replace(/\D/g, '').trim();

            if (phoneClean.length !== 10) {
                showCenteredAlert("Please enter a valid 10-digit phone number");
                input.focus();
                return;
            }

            // Set phone in info form
            document.getElementById('phone').value = input.value;

            // Check familyDatabase first for saved kids
            if (familyDatabase[phoneClean] && familyDatabase[phoneClean].kids && familyDatabase[phoneClean].kids.length > 0) {
                // Prefill from family database
                const family = familyDatabase[phoneClean];
                document.getElementById('firstName').value = family.firstName || '';
                document.getElementById('lastName').value = family.lastName || '';
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                
                familyDatabase[phoneClean].kids.forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
              <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Child:</strong>
                      <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Age:</strong>
                      <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                          <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                          ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                      </select>
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Allergies:</strong>
                      <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                          <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                          <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                          <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                      </select>
                  </label>
                  <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
              </div>
              
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                  <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
              </button>
          </div>
        `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else if (parents[phoneClean]) {
                const p = parents[phoneClean];
                document.getElementById('firstName').value = p.firstName || '';
                document.getElementById('lastName').value = p.lastName || '';
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                (p.children || []).forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
              <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Child:</strong>
                      <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Age:</strong>
                      <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                          <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                          ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                      </select>
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Allergies:</strong>
                      <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                          <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                          <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                          <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                      </select>
                  </label>
                  <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
              </div>
              
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                  <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
              </button>
          </div>
        `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else {
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('children-list').innerHTML = '';
                addChildEntry();
            }

            show('info-form');
        }

        // ‚îÄ‚îÄ‚îÄ Centered Alert Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showCenteredAlert(message, title = 'Alert') {
            // Close numpad first to prevent overlay issues
            hideNumpad();
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('centered-alert').classList.remove('hidden');
        }

        function closeCenteredAlert() {
            document.getElementById('centered-alert').classList.add('hidden');
        }

        function showConfirmModal(message, title, onYes, onNo) {
            // Close numpad first to prevent overlay issues
            hideNumpad();
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const modal = document.getElementById('centered-alert');
            const okBtn = modal.querySelector('.btn-primary');
            
            // Change OK button to Yes/No buttons
            okBtn.textContent = 'Yes';
            okBtn.onclick = () => {
                modal.classList.add('hidden');
                okBtn.textContent = 'OK';
                okBtn.onclick = closeCenteredAlert;
                if (onYes) onYes();
            };
            
            // Add No button if not exists
            let noBtn = modal.querySelector('.btn-cancel-temp');
            if (!noBtn) {
                noBtn = document.createElement('button');
                noBtn.className = 'btn-outline btn-cancel-temp';
                noBtn.textContent = 'No';
                modal.querySelector('.centered-modal-content').appendChild(noBtn);
            }
            noBtn.style.display = 'inline-block';
            noBtn.onclick = () => {
                modal.classList.add('hidden');
                okBtn.textContent = 'OK';
                okBtn.onclick = closeCenteredAlert;
                noBtn.style.display = 'none';
                if (onNo) onNo();
            };
            
            modal.classList.remove('hidden');
        }

        // ‚îÄ‚îÄ‚îÄ Volunteer phone input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onVolunteerPhoneInput() {
            // Optional: could pre-fill volunteer name if they exist in database
            const raw = document.getElementById('vol-phone-first').value;
            const phone = raw.replace(/\D/g, '');
            // Could look up in volunteers.all if needed
        }

        // ‚îÄ‚îÄ‚îÄ Show volunteer schedule after name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showVolunteerScheduleAfterName() {
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();
            const phoneRaw = document.getElementById('vol-phone-first').value;
            const phone = phoneRaw.replace(/\D/g, '');

            if (!first || !last) {
                showCenteredAlert("Please enter both first and last name");
                return;
            }

            if (phone.length !== 10) {
                showCenteredAlert("Please enter a valid 10-digit phone number");
                return;
            }

            // Store for later use
            memberPhone = phoneRaw;
            memberFirst = first;
            memberLast = last;

            // Add or update volunteer in database
            const fullName = `${first} ${last}`;
            const existingVol = getVolunteerByPhone(phone);
            
            if (existingVol) {
                // Update if name changed
                if (existingVol.name !== fullName) {
                    updateAllVolunteers(phone, 'name', fullName);
                }
            } else {
                // Add new volunteer to database
                if (!volunteers.all) volunteers.all = [];
                volunteers.all.push({
                    name: fullName,
                    phone: phone
                });
                saveData();
            }

            // Check if already scheduled in next 2 months
            const next2Months = getUpcomingSundays(13); // 3 months of Sundays
            let isAlreadyScheduled = false;
            
            for (const date of next2Months) {
                const slots = volunteers[date] || [];
                if (slots.some(v => v.phone === phone)) {
                    isAlreadyScheduled = true;
                    break;
                }
            }

            // If already scheduled, skip to buzzer selection
            if (isAlreadyScheduled) {
                continueToChildCheckInFromVolunteer();
                return;
            }

            // Otherwise show volunteer schedule
            renderVolunteerSchedule();
            show('volunteer-screen');
        }

        // ‚îÄ‚îÄ‚îÄ Render volunteer schedule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderVolunteerSchedule() {
            const schedList = document.getElementById('schedule-list');
            schedList.innerHTML = '';
            const sundays = getUpcomingSundays(13);
            const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();

            sundays.forEach(date => {
                const slots = volunteers[date] || [];
                const isFull = slots.length >= 2;
                const alreadySignedUp = slots.some(v => v.phone === phone);
                
                const div = document.createElement('div');
                div.className = 'schedule-item' + (isFull || alreadySignedUp ? '' : ' open');
                
                let statusText = '';
                if (alreadySignedUp) {
                    statusText = '‚úì You are signed up';
                } else if (isFull) {
                    statusText = 'Full (2/2)';
                } else if (slots.length === 1) {
                    statusText = 'Need 1 more (1/2)';
                } else {
                    statusText = 'Open (0/2)';
                }

                div.innerHTML = `
                    <span><strong>${date}</strong> - ${statusText}</span>
                    ${!isFull && !alreadySignedUp ? 
                        `<button class="btn-success btn-sm" onclick="signUpForDate('${date}')">Sign Up</button>` : 
                        ''}
                `;
                schedList.appendChild(div);
            });
        }

        // ‚îÄ‚îÄ‚îÄ Sign up for volunteer date ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function signUpForDate(date) {
            const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();
            const name = `${first} ${last}`;

            if (!volunteers[date]) volunteers[date] = [];
            
            if (volunteers[date].length >= 2) {
                showCenteredAlert("This date is already full.");
                return;
            }

            if (volunteers[date].some(v => v.phone === phone)) {
                showCenteredAlert("You are already signed up for this date.");
                return;
            }

            const vol = { name, phone };
            volunteers[date].push(vol);
            addToVolunteerAllIfNotExists(vol);
            saveData();
            
            // Auto-advance to child check-in
            skipVolunteerSchedule();
        }

        // ‚îÄ‚îÄ‚îÄ Skip volunteer schedule and go to child check-in ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function skipVolunteerSchedule() {
            // Transfer volunteer info to parent info
            document.getElementById('phone').value = memberPhone;
            document.getElementById('firstName').value = memberFirst;
            document.getElementById('lastName').value = memberLast;

            // Check if they have existing children in familyDatabase
            const phoneClean = memberPhone.replace(/\D/g, '');
            if (familyDatabase[phoneClean] && familyDatabase[phoneClean].kids && familyDatabase[phoneClean].kids.length > 0) {
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                familyDatabase[phoneClean].kids.forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Child:</strong>
                                    <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                </label>
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Age:</strong>
                                    <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                                        <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                        ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                    </select>
                                </label>
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Allergies:</strong>
                                    <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                                        <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                        <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                        <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                    </select>
                                </label>
                                <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                            </div>
                            
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                            </button>
                        </div>
                    `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else {
                document.getElementById('children-list').innerHTML = '';
                addChildEntry();
            }

            show('info-form');
        }

        // ‚îÄ‚îÄ‚îÄ Add child entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function addChildEntry() {
            childCounter++;
            const div = document.createElement('div');
            div.className = 'child-entry';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Child:</strong>
                            <input type="text" class="child-name" placeholder="Name" required style="width: 140px;" />
                        </label>
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Age:</strong>
                            <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                                <option value="" disabled selected>Select</option>
                                ${[1,2,3,4,5,6].map(age => `<option value="${age}" style="color:#000;">${age}</option>`).join('')}
                            </select>
                        </label>
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Allergies:</strong>
                            <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                                <option value="" disabled selected>Select</option>
                                <option value="None" style="color:#000;">None</option>
                                <option value="Other" style="color:#000;">Other</option>
                            </select>
                        </label>
                        <input type="text" class="child-allergies-other" style="width: 140px; display:none;" placeholder="Specify allergy" />
                    </div>
                    
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                        <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                    </button>
                </div>
            `;
            document.getElementById('children-list').appendChild(div);
            attachAllergyHandler(div);
        }

        // ‚îÄ‚îÄ‚îÄ Attach allergy handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function attachAllergyHandler(div) {
            const select = div.querySelector('.child-allergies');
            const otherInput = div.querySelector('.child-allergies-other');
            select.addEventListener('change', function() {
                if (this.value === 'Other') {
                    otherInput.style.display = 'inline';
                } else {
                    otherInput.style.display = 'none';
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ Renumber children ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renumberChildren() {
            childCounter = 0;
            document.querySelectorAll('.child-entry').forEach(entry => {
                childCounter++;
                entry.querySelector('strong').textContent = `Child ${childCounter}`;
            });
        }

        // ‚îÄ‚îÄ‚îÄ Phone input handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onPhoneInput() {
            const raw = document.getElementById('phone').value;
            const phone = raw.replace(/\D/g, '');
            if (phone.length === 10 && parents[phone]) {
                const p = parents[phone];
                document.getElementById('firstName').value = p.firstName || '';
                document.getElementById('lastName').value = p.lastName || '';
            }
            
            // Prefill ALL kids from family database if exists
            if (phone.length === 10 && familyDatabase[phone]) {
                const family = familyDatabase[phone];
                if (family.kids && family.kids.length > 0) {
                    document.getElementById('children-list').innerHTML = '';
                    childCounter = 0;
                    family.kids.forEach(child => {
                        childCounter++;
                        const div = document.createElement('div');
                        div.className = 'child-entry';
                        const allergiesValue = child.allergies || '';
                        const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                        const otherText = isOther ? allergiesValue : '';
                        
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Child:</strong>
                                        <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                    </label>
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Age:</strong>
                                        <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                                            <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                            ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                        </select>
                                    </label>
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Allergies:</strong>
                                        <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                                            <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                            <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                            <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                        </select>
                                    </label>
                                    <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                                </div>
                                
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                    <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                                </button>
                            </div>
                        `;
                        document.getElementById('children-list').appendChild(div);
                        attachAllergyHandler(div);
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ Close validation modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function closeValidationModal() {
            document.getElementById('validation-modal').classList.add('hidden');
        }

        // ‚îÄ‚îÄ‚îÄ Show validation modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showValidationModal(message) {
            document.getElementById('validation-message').textContent = message;
            document.getElementById('validation-modal').classList.remove('hidden');
        }

        // ‚îÄ‚îÄ‚îÄ Finish check-in ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let isProcessingCheckIn = false; // Guard to prevent duplicate submissions
        
        function resetCheckInButton() {
            const checkInBtn = document.querySelector('button[onclick="finishCheckIn()"]');
            if (checkInBtn) {
                checkInBtn.disabled = false;
                checkInBtn.style.opacity = '1';
            }
        }
        
        function finishCheckIn() {
            // Prevent multiple simultaneous calls
            if (isProcessingCheckIn) {
                console.log('‚ö†Ô∏è Check-in already in progress, ignoring duplicate call');
                return;
            }
            
            isProcessingCheckIn = true;
            
            // Disable the check-in button to prevent double-clicks
            const checkInBtn = document.querySelector('button[onclick="finishCheckIn()"]');
            if (checkInBtn) {
                checkInBtn.disabled = true;
                checkInBtn.style.opacity = '0.5';
            }
            
            const phone = document.getElementById('phone').value.replace(/\D/g, '').trim();
            const first = document.getElementById('firstName').value.trim();
            const last = document.getElementById('lastName').value.trim();
            
            if (phone.length !== 10) {
                showValidationModal("Please enter a valid 10-digit phone number");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            if (!first || !last) {
                showValidationModal("Please fill in parent first and last name");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            // Check if this phone number already checked in today
            const today = new Date().toDateString();
            const alreadyCheckedIn = checkIns.some(entry => {
                const entryDate = new Date(entry.timestamp || Date.now()).toDateString();
                const entryPhone = entry.phone.replace(/\D/g, '');
                return entryDate === today && entryPhone === phone;
            });
            
            if (alreadyCheckedIn) {
                showCenteredAlert("This phone number is already checked in today!", "Duplicate Check-In");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            let added = 0;
            let hasError = false;
            let errorMessage = '';
            const currentChildren = [];
            
            document.querySelectorAll('.child-entry').forEach((row, index) => {
                const name = row.querySelector('.child-name').value.trim();
                const ageInput = row.querySelector('.child-age');
                const age = ageInput.value.trim();
                const allergiesSelect = row.querySelector('.child-allergies');
                let allergies = allergiesSelect.value;
                const otherInput = row.querySelector('.child-allergies-other');
                
                if (!name) {
                    errorMessage = `Child ${index + 1}: Please enter a name`;
                    hasError = true;
                    return;
                }
                
                if (!age || age < 1 || age > 6) {
                    errorMessage = `Child ${index + 1} (${name}): Please enter a valid age between 1 and 6`;
                    hasError = true;
                    return;
                }
                
                if (!allergies || allergies === '') {
                    errorMessage = `Child ${index + 1} (${name}): Please select an allergy option (select "None" if no allergies)`;
                    hasError = true;
                    return;
                }
                
                if (allergies === 'Other') {
                    const otherValue = otherInput.value.trim();
                    if (!otherValue) {
                        errorMessage = `Child ${index + 1} (${name}): Please specify the allergy or select "None"`;
                        hasError = true;
                        return;
                    }
                    allergies = otherValue;
                }
                
                currentChildren.push({
                    name,
                    age,
                    allergies
                });
                added++;
            });
            
            if (hasError) {
                showValidationModal(errorMessage);
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            if (added === 0) {
                showValidationModal("Please add at least one child");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            if (!currentBuzzer) {
                memberPhone = document.getElementById('phone').value;
                memberFirst = first;
                memberLast = last;
                showBuzzerScreen();
                resetCheckInButton();
                isProcessingCheckIn = false; // Reset because we're not done yet, just going to buzzer screen
                return;
            }
            
            const formattedPhone = document.getElementById('phone').value;
            currentChildren.forEach(child => {
                checkIns.push({
                    buzzer: currentBuzzer,
                    childName: child.name,
                    age: child.age || '‚Äî',
                    allergies: child.allergies || 'None',
                    phone: formattedPhone,
                    parentName: `${first} ${last}`,
                    timestamp: Date.now(),
                    service: window.currentService || 'english' // Tag with current service
                });
            });
            
            if (!parents[phone]) parents[phone] = {};
            parents[phone].firstName = first;
            parents[phone].lastName = last;
            parents[phone].children = currentChildren;
            
            // Update family database - only add NEW children, don't remove existing ones
            if (!familyDatabase[phone]) {
                // First time for this phone - create new entry
                familyDatabase[phone] = {
                    type: isMemberPath ? 'member' : 'nonmember',
                    firstName: first,
                    lastName: last,
                    kids: currentChildren.map(child => ({
                        name: child.name,
                        age: child.age,
                        allergies: child.allergies
                    }))
                };
            } else {
                // Phone exists - only add NEW children
                const existingKids = familyDatabase[phone].kids || [];
                const existingKidNames = existingKids.map(k => k.name.toLowerCase());
                
                // Add new children that don't exist yet
                currentChildren.forEach(child => {
                    if (!existingKidNames.includes(child.name.toLowerCase())) {
                        existingKids.push({
                            name: child.name,
                            age: child.age,
                            allergies: child.allergies
                        });
                    }
                });
                
                // Update the family database with merged list
                familyDatabase[phone].kids = existingKids;
                // Update parent names in case they changed
                familyDatabase[phone].firstName = first;
                familyDatabase[phone].lastName = last;
            }
            
            usedBuzzers.add(currentBuzzer);
            saveData();
            checkAndSaveWeeklyReport(); // Update Sunday report if today is Sunday
            
            // Create child names list
            const childNames = currentChildren.map(c => c.name).join(', ');
            document.getElementById('success-text').textContent = `Checked in ${childNames} with buzzer #${currentBuzzer}`;
            document.getElementById('success-modal').classList.remove('hidden');
            
            // Reset the guard and button after successful check-in
            resetCheckInButton();
            isProcessingCheckIn = false;
        }

        // ‚îÄ‚îÄ‚îÄ Show buzzer screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showBuzzerScreen() {
            renderBuzzerGrid();
            show('buzzer-screen');
        }

        // ‚îÄ‚îÄ‚îÄ Render buzzer grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderBuzzerGrid() {
            const grid = document.getElementById('buzzer-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 24; i++) {
                const btn = document.createElement('button');
                btn.className = 'buzzer-btn';
                btn.textContent = i;
                
                if (usedBuzzers.has(i)) {
                    btn.classList.add('unavailable');
                } else {
                    btn.classList.add('available');
                    btn.onclick = () => selectBuzzer(i);
                }
                
                grid.appendChild(btn);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Select buzzer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function selectBuzzer(num) {
            document.querySelectorAll('.buzzer-btn.selected').forEach(b => b.classList.remove('selected'));
            const btn = Array.from(document.querySelectorAll('.buzzer-btn')).find(b => b.textContent == num);
            if (btn) {
                btn.classList.add('selected');
                currentBuzzer = num;
                
                // Auto-proceed to finish check-in
                setTimeout(() => {
                    finishCheckIn();
                }, 500);
            }
        }

        // ‚îÄ‚îÄ‚îÄ View Current Check-Ins ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // Store temporary data for adding child
        let pendingAddChild = null;
        
        function requestAddChildToBuzzer(buzzerNum, phone, parentName) {
            // Store the data
            pendingAddChild = { buzzerNum, phone, parentName };
            
            // Request admin password first
            pendingAction = { action: 'add-child-to-buzzer' };
            showAdminPasswordModal();
        }
        
        function showAddChildForm() {
            if (!pendingAddChild) return;
            
            document.getElementById('add-child-buzzer-num').textContent = '#' + pendingAddChild.buzzerNum;
            document.getElementById('add-child-parent-name').textContent = pendingAddChild.parentName;
            document.getElementById('add-child-name').value = '';
            document.getElementById('add-child-age').value = '';
            document.getElementById('add-child-allergies').value = '';
            document.getElementById('add-child-allergies-other').value = '';
            document.getElementById('add-child-allergies-other').classList.add('hidden');
            
            document.getElementById('add-child-modal').classList.remove('hidden');
        }
        
        function closeAddChildModal() {
            document.getElementById('add-child-modal').classList.add('hidden');
            // Clear form fields
            document.getElementById('add-child-name').value = '';
            document.getElementById('add-child-age').value = '';
            document.getElementById('add-child-allergies').value = '';
            document.getElementById('add-child-allergies-other').value = '';
            document.getElementById('add-child-allergies-other').classList.add('hidden');
            pendingAddChild = null;
        }
        
        function toggleAddChildOtherAllergy() {
            const select = document.getElementById('add-child-allergies');
            const otherInput = document.getElementById('add-child-allergies-other');
            
            if (select.value === 'Other') {
                otherInput.classList.remove('hidden');
            } else {
                otherInput.classList.add('hidden');
            }
        }
        
        function submitAddChild() {
            if (!pendingAddChild) return;
            
            const name = document.getElementById('add-child-name').value.trim();
            const age = document.getElementById('add-child-age').value.trim();
            let allergies = document.getElementById('add-child-allergies').value;
            const otherAllergy = document.getElementById('add-child-allergies-other').value.trim();
            
            // Validation
            if (!name) {
                showCenteredAlert('Required', 'Please enter the child\'s name');
                return;
            }
            
            if (!age) {
                showCenteredAlert('Required', 'Please select the child\'s age (1-6)');
                return;
            }
            
            if (!allergies) {
                showCenteredAlert('Required', 'Please select an allergy option (select "None" if no allergies)');
                return;
            }
            
            if (allergies === 'Other') {
                if (!otherAllergy) {
                    showCenteredAlert('Required', 'Please specify the allergy or select "None"');
                    return;
                }
                allergies = otherAllergy;
            }
            
            // Add child to check-ins
            const phone = pendingAddChild.phone;
            const buzzer = pendingAddChild.buzzerNum;
            const parentName = pendingAddChild.parentName;
            
            checkIns.push({
                buzzer: buzzer,
                childName: name,
                age: age,
                allergies: allergies,
                phone: phone,
                parentName: parentName,
                timestamp: Date.now(),
                service: window.currentService || 'english' // Tag with current service
            });
            
            // Update family database
            const cleanPhone = phone.replace(/\D/g, '');
            if (familyDatabase[cleanPhone]) {
                const existingKids = familyDatabase[cleanPhone].kids || [];
                const existingKid = existingKids.find(k => k.name.toLowerCase() === name.toLowerCase());
                
                if (existingKid) {
                    // Update age if different
                    if (existingKid.age != age) {
                        existingKid.age = age;
                    }
                } else {
                    // Add new child
                    existingKids.push({
                        name: name,
                        age: age,
                        allergies: allergies
                    });
                    familyDatabase[cleanPhone].kids = existingKids;
                }
            }
            
            saveData();
            closeAddChildModal();
            renderCheckInTable();
            showCenteredAlert('Success! ‚úÖ', `${name} has been added to buzzer #${buzzer}`);
        }
        
        function showViewCheckInsPasswordModal() {
            window.pendingViewCheckIns = true;
            showAdminPasswordModal();
        }
        
        function showViewCheckIns() {
            show('view-checkins');
            renderCheckInTable();
        }

        function renderCheckInTable() {
            const tbody = document.querySelector('#checkin-table tbody');
            tbody.innerHTML = '';
            
            // Get service filter
            const filterSelect = document.getElementById('checkin-service-filter');
            const serviceFilter = filterSelect ? filterSelect.value : 'all';
            
            // Filter check-ins by service
            let filteredCheckIns = checkIns;
            if (serviceFilter !== 'all') {
                filteredCheckIns = checkIns.filter(ci => ci.service === serviceFilter);
            }
            
            // Group check-ins by buzzer
            const buzzerGroups = {};
            filteredCheckIns.forEach((ci, idx) => {
                // Find original index in checkIns array
                const originalIndex = checkIns.indexOf(ci);
                if (!buzzerGroups[ci.buzzer]) {
                    buzzerGroups[ci.buzzer] = [];
                }
                buzzerGroups[ci.buzzer].push({...ci, originalIndex: originalIndex});
            });
            
            // Render grouped by buzzer
            Object.keys(buzzerGroups).sort((a, b) => a - b).forEach(buzzerNum => {
                const group = buzzerGroups[buzzerNum];
                const firstChild = group[0];
                
                // First row shows buzzer, first child, and checkout button with rowspan
                let tr = document.createElement('tr');
                let allergiesStyle = (firstChild.allergies && firstChild.allergies !== 'None' && firstChild.allergies.trim() !== '') ?
                    ' style="color: red; font-weight: bold;"' : '';
                
                tr.innerHTML = `
                    <td rowspan="${group.length}">#${buzzerNum}</td>
                    <td>${firstChild.childName}</td>
                    <td>${firstChild.age}</td>
                    <td${allergiesStyle}>${firstChild.allergies}</td>
                    <td rowspan="${group.length}">${firstChild.parentName}</td>
                    <td rowspan="${group.length}" class="phone-cell" onclick="requestAdminAction('show-phone', ${firstChild.originalIndex})">${firstChild.phone}</td>
                    <td rowspan="${group.length}">
                        <button class="btn-danger btn-sm" onclick="requestCheckoutByBuzzer(${buzzerNum})" style="display: block; margin: 4px auto;">Check Out</button>
                        <button class="btn-primary btn-sm" onclick="requestAddChildToBuzzer(${buzzerNum}, '${firstChild.phone}', '${firstChild.parentName}')" style="display: block; margin: 4px auto;">+ Add Child</button>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Additional rows for siblings (only show child info)
                for (let i = 1; i < group.length; i++) {
                    const child = group[i];
                    let siblingTr = document.createElement('tr');
                    let siblingAllergiesStyle = (child.allergies && child.allergies !== 'None' && child.allergies.trim() !== '') ?
                        ' style="color: red; font-weight: bold;"' : '';
                    
                    siblingTr.innerHTML = `
                        <td>${child.childName}</td>
                        <td>${child.age}</td>
                        <td${siblingAllergiesStyle}>${child.allergies}</td>
                    `;
                    tbody.appendChild(siblingTr);
                }
            });
        }
        // ‚îÄ‚îÄ‚îÄ Custom checkout confirmation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function requestCheckout(index) {
            pendingCheckoutIndex = index;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function requestCheckoutByBuzzer(buzzerNum) {
            pendingCheckoutIndex = buzzerNum;
            const children = checkIns.filter(ci => ci.buzzer === buzzerNum);
            const childNames = children.map(c => c.childName).join(', ');
            document.querySelector('#confirm-content p').textContent = 
                `This will check out ${childNames} with buzzer #${buzzerNum}.`;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingCheckoutIndex = null;
        }

        function confirmCheckout() {
            document.getElementById('confirm-modal').classList.add('hidden');
            finalizeCheckout();
        }

        function finalizeCheckout() {
            if (pendingCheckoutIndex === null) return;
            
            // pendingCheckoutIndex now holds the buzzer number
            const buzzerNum = pendingCheckoutIndex;
            
            // Remove all check-ins with this buzzer number
            checkIns = checkIns.filter(ci => ci.buzzer !== buzzerNum);
            
            // Remove buzzer from used set
            usedBuzzers.delete(buzzerNum);
            
            saveData();
            renderCheckInTable();
            pendingCheckoutIndex = null;
            
            // Reset confirmation modal text
            document.querySelector('#confirm-content p').textContent = 
                'This will check out the selected child.';
        }

        // ‚îÄ‚îÄ‚îÄ Admin actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function requestAdminAction(action, index) {
            pendingAction = {
                action,
                index
            };
            showAdminPasswordModal();
        }

        let adminPin = '';

        function showAdminPasswordModal() {
            adminPin = '';
            updatePinDisplay();
            document.getElementById('admin-password-modal').classList.remove('hidden');
        }

        function closeAdminPasswordModal() {
            document.getElementById('admin-password-modal').classList.add('hidden');
            adminPin = '';
        }

        function addPinDigit(digit) {
            if (adminPin.length < 4) {
                adminPin += digit;
                updatePinDisplay();
                
                // Auto-check when 4 digits entered (iPhone style)
                if (adminPin.length === 4) {
                    setTimeout(checkAdminPassword, 200);
                }
            }
        }

        function deletePinDigit() {
            adminPin = adminPin.slice(0, -1);
            updatePinDisplay();
        }

        function clearPin() {
            adminPin = '';
            updatePinDisplay();
        }

        function updatePinDisplay() {
            const display = document.getElementById('pin-display');
            if (adminPin.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = '‚óè'.repeat(adminPin.length);
            }
        }

        async function checkAdminPassword() {
            const entered = adminPin;
            
            // Get password from Firebase
            try {
                const settingsRef = window.firebaseDB ? window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin') : null;
                if (!settingsRef) {
                    showCenteredAlert('Error', 'Firebase not initialized');
                    return;
                }
                
                const settingsSnap = await window.getDoc(settingsRef);
                let correctPassword = '0000'; // Default password
                
                if (settingsSnap.exists()) {
                    correctPassword = settingsSnap.data().password || '0000';
                } else {
                    // First time - set default password
                    await window.setDoc(settingsRef, { password: '0000' });
                }
                
                if (entered !== correctPassword) {
                    adminPin = '';
                    updatePinDisplay();
                    showCenteredAlert('Incorrect PIN', 'Access Denied');
                    return;
                }
                
                // Correct password
                document.getElementById('admin-password-modal').classList.add('hidden');
                adminPin = '';
                
                // Check if this was for View Check-Ins
                if (window.pendingViewCheckIns) {
                    window.pendingViewCheckIns = false;
                    showViewCheckIns();
                    return;
                }
                
                if (!pendingAction) {
                    show('admin-content');
                    updateDisplays();
                    return;
                }
                const { action, index } = pendingAction;
                pendingAction = null;
                if (action === 'checkout') {
                    finalizeCheckout();
                    return;
                }
                if (action === 'add-child-to-buzzer') {
                    showAddChildForm();
                    return;
                }
                if (action === 'show-phone') {
                    const rows = document.querySelectorAll('#checkin-table tbody tr');
                    if (rows[index]) rows[index].classList.add('phone-revealed');
                }
            } catch (error) {
                console.error('Error checking admin password:', error);
                adminPin = '';
                updatePinDisplay();
                showCenteredAlert('Error', 'Could not verify password');
            }
        }

        // Show/Hide Change Password Modal
        // ===== CHANGE ADMIN PASSWORD FLOW =====
        let changePasswordPin = '';
        let newPasswordValue = '';
        let confirmPasswordValue = '';
        
        // Step 1: Request current password
        function requestCurrentPasswordForChange() {
            changePasswordPin = '';
            newPasswordValue = '';
            confirmPasswordValue = '';
            updateChangePinDisplay();
            document.getElementById('change-password-step1-modal').classList.remove('hidden');
        }
        
        function closeChangePasswordFlow() {
            document.getElementById('change-password-step1-modal').classList.add('hidden');
            document.getElementById('change-password-step2-modal').classList.add('hidden');
            document.getElementById('change-password-step3-modal').classList.add('hidden');
            document.getElementById('password-confirm-modal').classList.add('hidden');
            changePasswordPin = '';
            newPasswordValue = '';
            confirmPasswordValue = '';
        }
        
        function addChangePinDigit(digit) {
            if (changePasswordPin.length < 4) {
                changePasswordPin += digit;
                updateChangePinDisplay();
                
                // Auto-check when 4 digits entered
                if (changePasswordPin.length === 4) {
                    setTimeout(verifyCurrentPasswordForChange, 200);
                }
            }
        }
        
        function deleteChangePinDigit() {
            changePasswordPin = changePasswordPin.slice(0, -1);
            updateChangePinDisplay();
        }
        
        function clearChangePin() {
            changePasswordPin = '';
            updateChangePinDisplay();
        }
        
        function updateChangePinDisplay() {
            const display = document.getElementById('change-pin-display');
            if (changePasswordPin.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = '‚óè'.repeat(changePasswordPin.length);
            }
        }
        
        // New password entry functions
        function addNewPasswordDigit(digit) {
            if (newPasswordValue.length < 4) {
                newPasswordValue += digit;
                updateNewPasswordDisplay();
                
                // Auto-advance when 4 digits entered
                if (newPasswordValue.length === 4) {
                    setTimeout(() => {
                        document.getElementById('change-password-step2-modal').classList.add('hidden');
                        document.getElementById('change-password-step3-modal').classList.remove('hidden');
                    }, 200);
                }
            }
        }
        
        function deleteNewPasswordDigit() {
            newPasswordValue = newPasswordValue.slice(0, -1);
            updateNewPasswordDisplay();
        }
        
        function clearNewPassword() {
            newPasswordValue = '';
            updateNewPasswordDisplay();
        }
        
        function updateNewPasswordDisplay() {
            const display = document.getElementById('new-password-display');
            if (newPasswordValue.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = newPasswordValue; // Show actual numbers
            }
        }
        
        // Confirm password entry functions
        function addConfirmPasswordDigit(digit) {
            if (confirmPasswordValue.length < 4) {
                confirmPasswordValue += digit;
                updateConfirmPasswordDisplay();
                
                // Auto-check when 4 digits entered
                if (confirmPasswordValue.length === 4) {
                    setTimeout(validateAndConfirmPassword, 200);
                }
            }
        }
        
        function deleteConfirmPasswordDigit() {
            confirmPasswordValue = confirmPasswordValue.slice(0, -1);
            updateConfirmPasswordDisplay();
        }
        
        function clearConfirmPassword() {
            confirmPasswordValue = '';
            updateConfirmPasswordDisplay();
        }
        
        function updateConfirmPasswordDisplay() {
            const display = document.getElementById('confirm-password-display');
            if (confirmPasswordValue.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = confirmPasswordValue; // Show actual numbers
            }
        }
        
        function backToNewPassword() {
            confirmPasswordValue = '';
            updateConfirmPasswordDisplay();
            document.getElementById('change-password-step3-modal').classList.add('hidden');
            document.getElementById('change-password-step2-modal').classList.remove('hidden');
        }
        
        // Verify current password
        async function verifyCurrentPasswordForChange() {
            const entered = changePasswordPin;
            
            try {
                const settingsRef = window.firebaseDB ? window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin') : null;
                if (!settingsRef) {
                    showCenteredAlert('Error', 'Firebase not initialized');
                    changePasswordPin = '';
                    updateChangePinDisplay();
                    return;
                }
                
                const settingsSnap = await window.getDoc(settingsRef);
                let correctPassword = '0000';
                
                if (settingsSnap.exists()) {
                    correctPassword = settingsSnap.data().password || '0000';
                }
                
                if (entered !== correctPassword) {
                    changePasswordPin = '';
                    updateChangePinDisplay();
                    showCenteredAlert('Incorrect PIN', 'Current password is incorrect');
                    return;
                }
                
                // Password correct - move to step 2
                document.getElementById('change-password-step1-modal').classList.add('hidden');
                document.getElementById('change-password-step2-modal').classList.remove('hidden');
                changePasswordPin = '';
                
            } catch (error) {
                console.error('Error verifying password:', error);
                showCenteredAlert('Error', 'Could not verify password');
                changePasswordPin = '';
                updateChangePinDisplay();
            }
        }
        
        // Validate passwords match and show confirmation
        function validateAndConfirmPassword() {
            if (newPasswordValue !== confirmPasswordValue) {
                showCenteredAlert('Error', 'Passwords do not match');
                confirmPasswordValue = '';
                updateConfirmPasswordDisplay();
                return;
            }
            
            // Show confirmation modal
            document.getElementById('password-confirm-modal').classList.remove('hidden');
        }
        
        function closePasswordConfirmModal() {
            document.getElementById('password-confirm-modal').classList.add('hidden');
        }
        
        // Final step: Actually change the password
        async function finalizePasswordChange() {
            try {
                // Update password in Firebase
                const settingsRef = window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin');
                await window.setDoc(settingsRef, { password: newPasswordValue });
                
                // Close all modals
                closePasswordConfirmModal();
                closeChangePasswordFlow();
                
                showCenteredAlert('Success! ‚úÖ', 'Admin password has been changed');
            } catch (error) {
                console.error('Error changing password:', error);
                showCenteredAlert('Error', 'Could not change password');
            }
        }
        
        // Old functions - keeping for compatibility (can be removed if not used elsewhere)
        function showChangePasswordModal() {
            requestCurrentPasswordForChange();
        }
        
        function closeChangePasswordModal() {
            closeChangePasswordFlow();
        }
        
        async function verifyCurrentPassword() {
            await verifyCurrentPasswordForChange();
        }
        
        function confirmNewPassword() {
            validateAndConfirmPassword();
        }
        
        function confirmNewPasswordChange() {
            validateAndConfirmPassword();
        }

        // ‚îÄ‚îÄ‚îÄ Get upcoming Sundays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getUpcomingSundays(count) {
            const sundays = [];
            const today = new Date();
            let current = new Date(today);
            
            // Find next Sunday
            const dayOfWeek = current.getDay();
            const daysUntilSunday = dayOfWeek === 0 ? 7 : 7 - dayOfWeek;
            current.setDate(current.getDate() + daysUntilSunday);
            
            for (let i = 0; i < count; i++) {
                const month = String(current.getMonth() + 1).padStart(2, '0');
                const day = String(current.getDate()).padStart(2, '0');
                const year = current.getFullYear();
                sundays.push(`${month}/${day}/${year}`);
                current.setDate(current.getDate() + 7);
            }
            
            return sundays;
        }

        // ‚îÄ‚îÄ‚îÄ Admin volunteer schedule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDisplays() {
            // Update stats
            document.getElementById('stat-checked-in').textContent = checkIns.length;
            
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) {
                    slots.forEach(vol => uniqueVols.set(vol.phone, vol));
                }
            });
            (volunteers.all || []).forEach(vol => uniqueVols.set(vol.phone, vol));
            document.getElementById('stat-volunteers').textContent = uniqueVols.size;
            
            const sundays = getUpcomingSundays(13);
            let openings = 0;
            sundays.forEach(date => {
                // Use service-specific key
                const serviceKey = `${date}_${window.currentService}`;
                const slots = volunteers[serviceKey] || [];
                openings += (2 - slots.length);
            });
            document.getElementById('stat-upcoming').textContent = openings;

            // Render schedule table
            const schedBody = document.querySelector('#admin-schedule-table tbody');
            schedBody.innerHTML = '';
            
            sundays.forEach(date => {
                // Use service-specific key
                const serviceKey = `${date}_${window.currentService}`;
                const slots = volunteers[serviceKey] || [];
                const v1 = slots[0] || {
                    name: '‚Äî',
                    phone: '‚Äî'
                };
                const v2 = slots[1] || {
                    name: '‚Äî',
                    phone: '‚Äî'
                };
                const supervisor = scheduledSupervisors[serviceKey] || null;
                
                // Create supervisor dropdown
                let supervisorDropdown = '<select onchange="assignSupervisor(\'' + date + '\', this.value)" style="width: 100%; padding: 6px;">';
                supervisorDropdown += '<option value="">‚Äî Select Supervisor ‚Äî</option>';
                Object.entries(supervisorDatabase).forEach(([phone, sup]) => {
                    const selected = supervisor && supervisor.phone === phone ? 'selected' : '';
                    supervisorDropdown += `<option value="${phone}" ${selected}>${sup.firstName} ${sup.lastName} - ${formatPhoneDisplay(phone)}</option>`;
                });
                supervisorDropdown += '</select>';
                
                const status = slots.length === 0 ? 'Open ‚Äì need 2' :
                    slots.length === 1 ? '1/2 signed up' : 'Full';
                let tr = document.createElement('tr');
                tr.innerHTML = `
        <td><strong>${date}</strong><br><small style="color:#666;">${status}</small></td>
        <td>
          ${v1.name !== '‚Äî' ? `
            <div style="margin-bottom: 4px;">
              <strong>${v1.name}</strong><br>
              <small style="color:#666;">${v1.phone !== '‚Äî' ? formatPhoneDisplay(v1.phone) : ''}</small>
            </div>
          ` : '<span style="color:#bbb;">Empty slot</span>'}
        </td>
        <td>
          ${v2.name !== '‚Äî' ? `
            <div style="margin-bottom: 4px;">
              <strong>${v2.name}</strong><br>
              <small style="color:#666;">${v2.phone !== '‚Äî' ? formatPhoneDisplay(v2.phone) : ''}</small>
            </div>
          ` : '<span style="color:#bbb;">Empty slot</span>'}
        </td>
        <td>${supervisorDropdown}</td>
        <td>
          <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
            ${slots.length < 2 ? `<button class="btn-success btn-sm" onclick="toggleAddVolunteerForm('${date}')" style="white-space: nowrap;">+ Add</button>` : ''}
            ${v1.name !== '‚Äî' ? `<button class="btn-icon btn-delete" onclick="removeVolunteerFromDate('${date}', 0)" title="Remove ${v1.name}">üóëÔ∏è</button>` : ''}
            ${v2.name !== '‚Äî' ? `<button class="btn-icon btn-delete" onclick="removeVolunteerFromDate('${date}', 1)" title="Remove ${v2.name}">üóëÔ∏è</button>` : ''}
          </div>
        </td>
      `;
                schedBody.appendChild(tr);
                if (slots.length < 2) {
                    const formTr = document.createElement('tr');
                    formTr.id = `add-vol-form-row-${date}`;
                    formTr.className = 'hidden';
                    formTr.innerHTML = `
          <td colspan="4" style="padding:0;">
            <div class="add-vol-form">
              <label>Phone: <input type="tel" id="add-vol-phone-${date}" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14" oninput="formatPhone(this)" /></label><br>
              <label>First & Last: <input type="text" id="add-vol-name-${date}" placeholder="John Doe" /></label><br>
              <button class="btn-success btn-sm" onclick="addVolunteerToDate('${date}')">Save</button>
              <button class="btn-outline btn-sm" onclick="toggleAddVolunteerForm('${date}')">Cancel</button>
            </div>
          </td>
        `;
                    schedBody.appendChild(formTr);
                }
            });

            // Render volunteer database
            renderVolunteerDatabase();
            
            // Render family database
            renderFamilyDatabase();
            
            // Render supervisor database
            renderSupervisorDatabase();
            
            // Render reports
            renderReports();
        }

        function formatPhoneDisplay(phone) {
            if (phone.length === 10) {
                return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6)}`;
            }
            return phone;
        }

        function removeVolunteerFromDate(date, index) {
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            let slots = volunteers[serviceKey] || [];
            if (!slots[index]) return;
            
            const volName = slots[index].name;
            
            showConfirmModal(
                `Remove ${volName} from ${date}?`,
                'Confirm Delete',
                () => {
                    slots.splice(index, 1);
                    volunteers[serviceKey] = slots;
                    saveData();
                    updateDisplays();
                }
            );
        }

        function toggleAddVolunteerForm(date) {
            const formRow = document.getElementById(`add-vol-form-row-${date}`);
            if (formRow) {
                formRow.classList.toggle('hidden');
                // Setup numpad for phone input when form is shown
                if (!formRow.classList.contains('hidden')) {
                    setTimeout(setupPhoneInputs, 50);
                }
            }
        }

        function addVolunteerToDate(date) {
            const nameInput = document.getElementById(`add-vol-name-${date}`);
            const phoneInput = document.getElementById(`add-vol-phone-${date}`);
            const name = nameInput.value.trim();
            const phone = phoneInput.value.replace(/\D/g, '').trim();
            if (!name || phone.length !== 10) {
                showCenteredAlert("Please enter full name and valid 10-digit phone number.");
                return;
            }
            
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            
            // Check if already scheduled for this date
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                showCenteredAlert("This person is already scheduled for this date!");
                return;
            }
            
            if (volunteers[serviceKey].length >= 2) {
                showCenteredAlert("This date is already full.");
                return;
            }
            const vol = {
                name,
                phone,
                service: window.currentService
            };
            volunteers[serviceKey].push(vol);
            addToVolunteerAllIfNotExists(vol);
            saveData();
            nameInput.value = '';
            phoneInput.value = '';
            toggleAddVolunteerForm(date);
            updateDisplays();
        }

        function renderVolunteerDatabase() {
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) {
                    slots.forEach(vol => uniqueVols.set(vol.phone, vol));
                }
            });
            (volunteers.all || []).forEach(vol => uniqueVols.set(vol.phone, vol));
            
            const container = document.getElementById('volunteer-database-content');
            
            if (uniqueVols.size === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No volunteers in database yet</p>';
                return;
            }
            
            const sundays = getUpcomingSundays(13);
            let html = '';
            
            uniqueVols.forEach(vol => {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 12px; margin: 12px 0; border: 2px solid #d1e3ff; box-sizing: border-box; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 1.1rem; color: var(--text); word-break: break-word;">${vol.name}</strong><br>
                                <span style="color: var(--primary); font-size: 0.95rem; word-break: break-word;">${formatPhoneDisplay(vol.phone)}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; flex-shrink: 0;">
                                <div style="display: flex; flex-direction: column; gap: 4px; min-width: 120px;">
                                    <select id="assign-date-${vol.phone}" style="padding: 4px 6px; border-radius: 6px; border: 1px solid #d1e3ff; font-size: 0.75rem; width: 100%;">
                                        ${sundays.map(date => `<option value="${date}">${date}</option>`).join('')}
                                    </select>
                                    <button class="btn-primary" onclick="assignVolunteerToDate('${vol.phone}')" style="font-size: 0.7rem; padding: 4px 8px; white-space: nowrap; width: 100%;">Assign</button>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn-icon btn-edit" onclick="editVolunteerInfo('${vol.phone}')" title="Edit" style="font-size: 0.85rem; padding: 4px 8px;">‚úèÔ∏è</button>
                                    <button class="btn-icon btn-delete" onclick="deleteVolunteerFromDatabase('${vol.phone}')" title="Delete" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function editVolunteerName(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            const newName = prompt('Edit volunteer name:', vol.name);
            if (newName && newName.trim() && newName !== vol.name) {
                updateAllVolunteers(phone, 'name', newName.trim());
            }
        }

        function editVolunteerInfo(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            // Create custom edit modal
            const alertModal = document.getElementById('centered-alert');
            const alertContent = alertModal.querySelector('.centered-modal-content');
            const originalHTML = alertContent.innerHTML;
            
            alertContent.innerHTML = `
                <h3>Edit Volunteer</h3>
                <div style="margin: 20px 0;">
                    <input type="tel" id="edit-vol-phone" value="${formatPhoneDisplay(vol.phone)}" placeholder="(000) 000-0000" inputmode="numeric" oninput="formatPhone(this)" maxlength="14" style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                    <input type="text" id="edit-vol-name" value="${vol.name}" placeholder="Full Name" style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                </div>
                <button class="btn-success" id="save-vol-edit">Save</button>
                <button class="btn-outline" id="cancel-vol-edit">Cancel</button>
            `;
            
            alertModal.classList.remove('hidden');
            
            // Setup numpad for the phone input
            setTimeout(setupPhoneInputs, 50);
            
            document.getElementById('save-vol-edit').onclick = () => {
                const newName = document.getElementById('edit-vol-name').value.trim();
                const newPhone = document.getElementById('edit-vol-phone').value.replace(/\D/g, '');
                
                if (!newName || newPhone.length !== 10) {
                    alertContent.innerHTML = originalHTML;
                    alertModal.classList.add('hidden');
                    showCenteredAlert('Please enter valid name and 10-digit phone number');
                    return;
                }
                
                // Check if new phone already exists (and it's not the same volunteer)
                if (newPhone !== phone && getVolunteerByPhone(newPhone)) {
                    alertContent.innerHTML = originalHTML;
                    alertModal.classList.add('hidden');
                    showCenteredAlert('This phone number already exists in the database');
                    return;
                }
                
                // Update name if changed
                if (newName !== vol.name) {
                    updateAllVolunteers(phone, 'name', newName);
                }
                
                // Update phone if changed
                if (newPhone !== phone) {
                    updateAllVolunteers(phone, 'phone', newPhone);
                }
                
                alertContent.innerHTML = originalHTML;
                alertModal.classList.add('hidden');
                updateDisplays();
            };
            
            document.getElementById('cancel-vol-edit').onclick = () => {
                alertContent.innerHTML = originalHTML;
                alertModal.classList.add('hidden');
            };
        }

        function editVolunteerPhone(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            const newPhone = prompt('Edit phone number (10 digits):', formatPhoneDisplay(phone));
            if (newPhone) {
                const cleanPhone = newPhone.replace(/\D/g, '');
                if (cleanPhone.length === 10 && cleanPhone !== phone) {
                    // Check if new phone already exists
                    if (getVolunteerByPhone(cleanPhone)) {
                        showCenteredAlert('This phone number already exists in the database.');
                        return;
                    }
                    updateAllVolunteers(phone, 'phone', cleanPhone);
                }
            }
        }

        function deleteVolunteerFromDatabase(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            showConfirmModal(
                `Remove ${vol.name} from database and all schedules?`,
                'Confirm Delete',
                () => {
                    if (volunteers.all) {
                        volunteers.all = volunteers.all.filter(v => v.phone !== phone);
                    }
                    Object.keys(volunteers).forEach(date => {
                        if (Array.isArray(volunteers[date])) {
                            volunteers[date] = volunteers[date].filter(v => v.phone !== phone);
                        }
                    });
                    saveData();
                    updateDisplays();
                }
            );
        }

        function getVolunteerByPhone(phone) {
            let vol = volunteers.all?.find(v => v.phone === phone);
            if (vol) return vol;
            for (const slots of Object.values(volunteers)) {
                if (Array.isArray(slots)) {
                    vol = slots.find(v => v.phone === phone);
                    if (vol) return vol;
                }
            }
            return null;
        }

        function toggleAddToDatabaseForm() {
            document.getElementById('add-to-db-form').classList.toggle('hidden');
        }

        function addToVolunteerDatabase() {
            const name = document.getElementById('db-vol-name').value.trim();
            const phoneFormatted = document.getElementById('db-vol-phone').value;
            const phone = phoneFormatted.replace(/\D/g, '').trim();
            if (!name || phone.length !== 10) {
                showCenteredAlert("Please enter full name and valid 10-digit phone number.");
                return;
            }
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) {
                    slots.forEach(vol => uniqueVols.set(vol.phone, vol));
                }
            });
            (volunteers.all || []).forEach(vol => uniqueVols.set(vol.phone, vol));
            if (uniqueVols.has(phone)) {
                showCenteredAlert("Volunteer with this phone already exists.");
                return;
            }
            if (!volunteers.all) volunteers.all = [];
            volunteers.all.push({
                name,
                phone
            });
            saveData();
            document.getElementById('db-vol-name').value = '';
            document.getElementById('db-vol-phone').value = '';
            toggleAddToDatabaseForm();
            updateDisplays();
        }

        function updateAllVolunteers(phone, field, value) {
            if (volunteers.all) {
                volunteers.all = volunteers.all.map(v => v.phone === phone ? {
                    ...v,
                    [field]: value
                } : v);
            }
            Object.keys(volunteers).forEach(date => {
                if (Array.isArray(volunteers[date])) {
                    volunteers[date] = volunteers[date].map(v => v.phone === phone ? {
                        ...v,
                        [field]: value
                    } : v);
                }
            });
            saveData();
            updateDisplays();
        }

        function addToVolunteerAllIfNotExists(vol) {
            if (!volunteers.all) volunteers.all = [];
            const exists = volunteers.all.some(v => v.phone === vol.phone);
            if (!exists) {
                volunteers.all.push({
                    name: vol.name,
                    phone: vol.phone
                });
            }
        }

        function assignVolunteerToDate(phone) {
            const select = document.getElementById(`assign-date-${phone}`);
            const date = select.value;
            const vol = getVolunteerByPhone(phone);
            if (!vol) {
                showCenteredAlert("Volunteer not found.");
                return;
            }
            
            // Use service-specific key: "date_service" (e.g., "02/15/2026_russian")
            const serviceKey = `${date}_${window.currentService}`;
            
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                showCenteredAlert("This volunteer is already assigned to this date.");
                return;
            }
            if (volunteers[serviceKey].length >= 2) {
                showCenteredAlert("This date is already full (2 volunteers). Delete someone first.");
                return;
            }
            volunteers[serviceKey].push({
                name: vol.name,
                phone: vol.phone,
                service: window.currentService
            });
            saveData();
            showCenteredAlert(`Assigned ${vol.name} to ${date}!`, 'Success');
            updateDisplays();
        }

        // ‚îÄ‚îÄ‚îÄ Family Database Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showAddFamilyModal() {
            // Redirect to check-in with non-member option
            showScreen('checkin-screen');
            document.getElementById('nonmem-btn').click();
        }

        function renderFamilyDatabase() {
            const container = document.getElementById('family-database-content');
            
            if (Object.keys(familyDatabase).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No families in database yet</p>';
                return;
            }
            
            let html = '';
            Object.entries(familyDatabase).forEach(([phone, familyData]) => {
                const kids = familyData.kids || familyData; // Support old and new format
                const type = familyData.type || 'nonmember'; // Default to nonmember if not set
                const firstName = familyData.firstName || '';
                const lastName = familyData.lastName || '';
                const typeDisplay = type === 'member' ? 'Member' : 'Non-Member';
                const typeColor = type === 'member' ? '#1976d2' : '#f57c00';
                const kidsArray = Array.isArray(kids) ? kids : [];
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 12px; margin: 12px 0; border: 2px solid #d1e3ff; box-sizing: border-box; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="margin-bottom: 4px;">
                                    <strong style="font-size: 1.1rem; color: var(--text); word-break: break-word;">${firstName} ${lastName}</strong>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--primary); margin-bottom: 4px;">
                                    ${formatPhoneDisplay(phone)}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <span style="display: inline-block; padding: 3px 10px; background: ${type === 'member' ? '#e3f2fd' : '#fff3e0'}; color: ${typeColor}; border-radius: 10px; font-size: 0.8rem; font-weight: bold;">${typeDisplay}</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">`;
                
                kidsArray.forEach((kid, index) => {
                    html += `
                        <div style="padding: 4px 0; word-break: break-word;">
                            <strong>${kid.name}</strong> (${kid.age}) ${kid.allergies && kid.allergies !== 'None' ? `<span style="color: #d32f2f;">‚ö†Ô∏è ${kid.allergies}</span>` : ''}
                        </div>`;
                });
                
                html += `
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px; flex-shrink: 0;">
                                <button class="btn-icon btn-edit" onclick="editFamily('${phone}')" title="Edit" style="font-size: 0.85rem; padding: 4px 8px;">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteFamily('${phone}')" title="Delete Family" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        function toggleFamilyType(phone) {
            if (!familyDatabase[phone]) return;
            
            const familyData = familyDatabase[phone];
            const currentType = familyData.type || 'nonmember';
            const newType = currentType === 'member' ? 'nonmember' : 'member';
            
            showConfirmModal(
                `Change ${formatPhoneDisplay(phone)} to ${newType === 'member' ? 'Member' : 'Non-Member'}?`,
                'Confirm Change',
                () => {
                    // Update type
                    if (Array.isArray(familyData)) {
                        // Old format - convert to new format
                        familyDatabase[phone] = {
                            type: newType,
                            kids: familyData
                        };
                    } else {
                        // New format - just update type
                        familyDatabase[phone].type = newType;
                    }
                    saveData();
                    renderFamilyDatabase();
                }
            );
        }

        function editFamily(phone) {
            if (!familyDatabase[phone]) return;
            
            const family = familyDatabase[phone];
            const firstName = family.firstName || '';
            const lastName = family.lastName || '';
            const type = family.type || 'nonmember';
            const typeDisplay = type === 'member' ? 'Member' : 'Non-Member';
            const kids = family.kids || [];
            
            let kidsHTML = '';
            kids.forEach((kid, index) => {
                kidsHTML += `
                    <div style="background: #f8fbff; padding: 12px; margin: 8px 0; border-radius: 8px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label>Name: <input type="text" id="edit-kid-name-${index}" value="${kid.name}" style="width: 200px; padding: 6px;"></label>
                                <label style="margin-left: 12px;">Age: <input type="number" id="edit-kid-age-${index}" value="${kid.age}" min="1" max="18" style="width: 80px; padding: 6px;"></label>
                            </div>
                            <button class="btn-icon btn-delete" onclick="removeChildFromEditModal(${index})" title="Remove child" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                        </div>
                        <div>
                            <label>Allergies: <input type="text" id="edit-kid-allergies-${index}" value="${kid.allergies || 'None'}" style="width: 300px; padding: 6px;"></label>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h2>Edit Family</h2>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label>First Name: <input type="text" id="edit-first-name" value="${firstName}" style="width: 200px; padding: 8px;"></label>
                            <label style="margin-left: 12px;">Last Name: <input type="text" id="edit-last-name" value="${lastName}" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>Phone: <input type="tel" id="edit-phone" value="${formatPhoneDisplay(phone)}" inputmode="numeric" maxlength="14" style="width: 200px; padding: 8px;"></label>
                            <label style="margin-left: 12px;">Type: 
                                <select id="edit-type" style="width: 150px; padding: 8px;">
                                    <option value="member" ${type === 'member' ? 'selected' : ''}>Member</option>
                                    <option value="nonmember" ${type === 'nonmember' ? 'selected' : ''}>Non-Member</option>
                                </select>
                            </label>
                        </div>
                        <h3>Children:</h3>
                        <div id="edit-kids-list">${kidsHTML}</div>
                        <button class="btn-outline" onclick="addChildToFamily('${phone}')" style="margin-top: 12px; width: 100%;">‚ûï Add Child</button>
                    </div>
                    <button class="btn-success" onclick="saveEditFamily('${phone}')">Save Changes</button>
                    <button class="btn-outline" onclick="this.closest('.success-modal').remove()">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
        }

        function removeChildFromEditModal(index) {
            const kidsList = document.getElementById('edit-kids-list');
            const childDivs = kidsList.querySelectorAll('div[style*="background: #f8fbff"]');
            if (childDivs[index]) {
                childDivs[index].remove();
            }
        }

        function addChildToFamily(phone) {
            const kidsList = document.getElementById('edit-kids-list');
            const currentKidsCount = kidsList.querySelectorAll('div[style*="background: #f8fbff"]').length;
            const newIndex = currentKidsCount;
            
            const newKidHTML = `
                <div style="background: #f8fbff; padding: 12px; margin: 8px 0; border-radius: 8px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <label>Name: <input type="text" id="edit-kid-name-${newIndex}" value="" placeholder="Child Name" style="width: 200px; padding: 6px;"></label>
                            <label style="margin-left: 12px;">Age: <input type="number" id="edit-kid-age-${newIndex}" value="5" min="1" max="18" style="width: 80px; padding: 6px;"></label>
                        </div>
                        <button class="btn-icon btn-delete" onclick="removeChildFromEditModal(${newIndex})" title="Remove child" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                    </div>
                    <div>
                        <label>Allergies: <input type="text" id="edit-kid-allergies-${newIndex}" value="None" style="width: 300px; padding: 6px;"></label>
                    </div>
                </div>
            `;
            
            kidsList.insertAdjacentHTML('beforeend', newKidHTML);
        }

        function saveEditFamily(oldPhone) {
            const newFirstName = document.getElementById('edit-first-name').value.trim();
            const newLastName = document.getElementById('edit-last-name').value.trim();
            const newPhoneFormatted = document.getElementById('edit-phone').value;
            const newPhone = newPhoneFormatted.replace(/\D/g, '');
            const newType = document.getElementById('edit-type').value;
            
            if (!newFirstName || !newLastName || newPhone.length !== 10) {
                alert('Please enter valid first name, last name, and 10-digit phone number');
                return;
            }
            
            // Collect ALL kids from the form (including newly added ones)
            const updatedKids = [];
            const kidsList = document.getElementById('edit-kids-list');
            const kidDivs = kidsList.querySelectorAll('div[style*="background: #f8fbff"]');
            
            kidDivs.forEach((kidDiv, index) => {
                const nameInput = document.getElementById(`edit-kid-name-${index}`);
                const ageInput = document.getElementById(`edit-kid-age-${index}`);
                const allergiesInput = document.getElementById(`edit-kid-allergies-${index}`);
                
                if (nameInput && ageInput && allergiesInput && nameInput.value.trim()) {
                    updatedKids.push({
                        name: nameInput.value.trim(),
                        age: parseInt(ageInput.value),
                        allergies: allergiesInput.value.trim()
                    });
                }
            });
            
            // If phone changed, delete old entry and clear old auto-fill
            if (oldPhone !== newPhone) {
                delete familyDatabase[oldPhone];
                if (parents[oldPhone]) {
                    delete parents[oldPhone];
                }
            }
            
            // Save updated family
            familyDatabase[newPhone] = {
                type: newType,
                firstName: newFirstName,
                lastName: newLastName,
                kids: updatedKids
            };
            
            saveData();
            renderFamilyDatabase();
            document.querySelector('.success-modal').remove();
        }

        function deleteFamily(phone) {
            if (!familyDatabase[phone]) return;
            
            const family = familyDatabase[phone];
            const name = `${family.firstName || ''} ${family.lastName || ''}`.trim();
            
            showConfirmModal(
                `Delete entire family ${name} (${formatPhoneDisplay(phone)})?`,
                'Confirm Delete',
                () => {
                    delete familyDatabase[phone];
                    // Also clear auto-fill data for this phone number
                    if (parents[phone]) {
                        delete parents[phone];
                    }
                    saveData();
                    renderFamilyDatabase();
                }
            );
        }

        function deleteKidFromFamily(phone, kidIndex) {
            if (!familyDatabase[phone]) return;
            
            const familyData = familyDatabase[phone];
            const kids = familyData.kids || familyData;
            
            if (!kids[kidIndex]) return;
            
            const kid = kids[kidIndex];
            
            showConfirmModal(
                `Delete ${kid.name} from family ${formatPhoneDisplay(phone)}?`,
                'Confirm Delete',
                () => {
                    kids.splice(kidIndex, 1);
                    
                    // If no kids left, delete the family entry
                    if (kids.length === 0) {
                        delete familyDatabase[phone];
                    } else if (Array.isArray(familyData)) {
                        // Update old format
                        familyDatabase[phone] = kids;
                    }
                    
                    saveData();
                    updateDisplays();
                }
            );
        }

        // ‚îÄ‚îÄ‚îÄ Weekly Reports Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function getSundayKey(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day; // Get Sunday of this week
            const sunday = new Date(d.setDate(diff));
            return `${sunday.getFullYear()}-${String(sunday.getMonth() + 1).padStart(2, '0')}-${String(sunday.getDate()).padStart(2, '0')}`;
        }

        function isSunday() {
            return new Date().getDay() === 0;
        }

        function checkAndSaveWeeklyReport() {
            if (isSunday()) {
                const sundayKey = getSundayKey(new Date());
                const todayCount = checkIns.length;
                
                // Save/update today's Sunday report
                weeklyReports[sundayKey] = {
                    date: sundayKey,
                    count: todayCount,
                    checkins: checkIns
                };
                
                saveData();
            }
        }

        function renderReports() {
            const container = document.getElementById('reports-content');
            const todayKey = getTodayKey();
            const todayCount = checkIns.length;
            
            let html = '';
            
            // Today's report (always show)
            html += `
                <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; border-left: 4px solid var(--primary);">
                    <h3 style="margin-top: 0; color: var(--primary);">üìÖ Today (${todayKey})</h3>
                    <div style="font-size: 2rem; color: var(--success); font-weight: bold; margin: 8px 0;">${todayCount}</div>
                    <p style="color: #666;">children checked in</p>
                </div>
            `;
            
            // Past Sunday reports
            const sortedSundays = Object.keys(weeklyReports).sort().reverse();
            
            if (sortedSundays.length > 0) {
                html += '<h3 style="margin-top: 30px; color: var(--primary);">Previous Sundays</h3>';
                
                sortedSundays.forEach(sunday => {
                    const report = weeklyReports[sunday];
                    html += `
                        <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; border-left: 4px solid var(--primary);">
                            <h3 style="margin-top: 0; color: var(--primary);">üìÖ ${sunday} (Sunday)</h3>
                            <div style="font-size: 2rem; color: var(--success); font-weight: bold; margin: 8px 0;">${report.count}</div>
                            <p style="color: #666;">children checked in</p>
                        </div>
                    `;
                });
            } else {
                html += '<p style="text-align: center; color: #999; margin-top: 20px;">No Sunday reports yet</p>';
            }
            
            container.innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ Supervisor Management Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleAddSupervisorForm() {
            document.getElementById('add-supervisor-form').classList.toggle('hidden');
        }

        function addSupervisorToDatabase() {
            const firstName = document.getElementById('super-first-name').value.trim();
            const lastName = document.getElementById('super-last-name').value.trim();
            const phoneFormatted = document.getElementById('super-phone').value;
            const phone = phoneFormatted.replace(/\D/g, '');
            
            if (!firstName || !lastName || phone.length !== 10) {
                alert('Please enter first name, last name, and valid 10-digit phone number.');
                return;
            }
            
            if (supervisorDatabase[phone]) {
                alert('Supervisor with this phone already exists.');
                return;
            }
            
            supervisorDatabase[phone] = {
                firstName: firstName,
                lastName: lastName
            };
            
            saveData();
            document.getElementById('super-first-name').value = '';
            document.getElementById('super-last-name').value = '';
            document.getElementById('super-phone').value = '';
            toggleAddSupervisorForm();
            renderSupervisorDatabase();
            updateDisplays();
        }

        function renderSupervisorDatabase() {
            const container = document.getElementById('supervisor-database-content');
            
            if (Object.keys(supervisorDatabase).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No supervisors in database yet</p>';
                return;
            }
            
            let html = '';
            Object.entries(supervisorDatabase).forEach(([phone, supervisor]) => {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 12px; margin: 12px 0; border: 2px solid #d1e3ff; box-sizing: border-box; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 1.1rem; color: var(--text); word-break: break-word;">${supervisor.firstName} ${supervisor.lastName}</strong><br>
                                <span style="color: var(--primary); font-size: 0.95rem; word-break: break-word;">${formatPhoneDisplay(phone)}</span>
                            </div>
                            <div style="display: flex; gap: 4px; flex-shrink: 0;">
                                <button class="btn-icon btn-edit" onclick="editSupervisor('${phone}')" title="Edit" style="font-size: 0.85rem; padding: 4px 8px;">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteSupervisor('${phone}')" title="Delete" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function editSupervisor(phone) {
            if (!supervisorDatabase[phone]) return;
            
            const supervisor = supervisorDatabase[phone];
            
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-content">
                    <h2>Edit Supervisor</h2>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label>Phone: <input type="tel" id="edit-super-phone" value="${formatPhoneDisplay(phone)}" inputmode="numeric" maxlength="14" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>First Name: <input type="text" id="edit-super-first" value="${supervisor.firstName}" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>Last Name: <input type="text" id="edit-super-last" value="${supervisor.lastName}" style="width: 200px; padding: 8px;"></label>
                        </div>
                    </div>
                    <button class="btn-success" onclick="saveEditSupervisor('${phone}')">Save Changes</button>
                    <button class="btn-outline" onclick="this.closest('.success-modal').remove()">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
        }

        function saveEditSupervisor(oldPhone) {
            const newFirstName = document.getElementById('edit-super-first').value.trim();
            const newLastName = document.getElementById('edit-super-last').value.trim();
            const newPhoneFormatted = document.getElementById('edit-super-phone').value;
            const newPhone = newPhoneFormatted.replace(/\D/g, '');
            
            if (!newFirstName || !newLastName || newPhone.length !== 10) {
                alert('Please enter valid first name, last name, and 10-digit phone number');
                return;
            }
            
            // If phone changed, delete old entry
            if (oldPhone !== newPhone) {
                delete supervisorDatabase[oldPhone];
                
                // Update any scheduled supervisors
                Object.keys(scheduledSupervisors).forEach(date => {
                    if (scheduledSupervisors[date] && scheduledSupervisors[date].phone === oldPhone) {
                        scheduledSupervisors[date].phone = newPhone;
                    }
                });
            }
            
            // Save updated supervisor
            supervisorDatabase[newPhone] = {
                firstName: newFirstName,
                lastName: newLastName
            };
            
            saveData();
            renderSupervisorDatabase();
            updateDisplays();
            document.querySelector('.success-modal').remove();
        }

        function deleteSupervisor(phone) {
            if (!supervisorDatabase[phone]) return;
            
            const supervisor = supervisorDatabase[phone];
            
            showConfirmModal(
                `Delete supervisor ${supervisor.firstName} ${supervisor.lastName} (${formatPhoneDisplay(phone)})?`,
                'Confirm Delete',
                () => {
                    delete supervisorDatabase[phone];
                    
                    // Remove from any scheduled dates
                    Object.keys(scheduledSupervisors).forEach(date => {
                        if (scheduledSupervisors[date] && scheduledSupervisors[date].phone === phone) {
                            delete scheduledSupervisors[date];
                        }
                    });
                    
                    saveData();
                    renderSupervisorDatabase();
                    updateDisplays();
                }
            );
        }

        function assignSupervisor(date, phone) {
            // Use service-specific key: "date_service" (e.g., "02/15/2026_russian")
            const serviceKey = `${date}_${window.currentService}`;
            
            if (!phone) {
                // Remove supervisor assignment for this service
                delete scheduledSupervisors[serviceKey];
            } else {
                const supervisor = supervisorDatabase[phone];
                if (supervisor) {
                    scheduledSupervisors[serviceKey] = {
                        phone: phone,
                        firstName: supervisor.firstName,
                        lastName: supervisor.lastName,
                        service: window.currentService
                    };
                }
            }
            saveData();
            updateDisplays();
        }

        // ‚îÄ‚îÄ‚îÄ Phone formatting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function formatPhone(input) {
            let digits = input.value.replace(/\D/g, '').slice(0, 10);
            let formatted = '';
            if (digits.length > 0) formatted = '(' + digits.slice(0, 3);
            if (digits.length >= 4) formatted += ') ' + digits.slice(3, 6);
            if (digits.length >= 7) formatted += '-' + digits.slice(6, 10);
            input.value = formatted;
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        loadData();
        show('main-screen');

        // ‚îÄ‚îÄ‚îÄ Schedule View (Public) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showScheduleView() {
            const sundays = getUpcomingSundays(13); // 3 months of Sundays
            
            let scheduleHTML = '<h3 style="margin-top: 0; color: var(--primary);">Upcoming Schedule</h3>';
            
            sundays.forEach(date => {
                // Use service-specific key
                const serviceKey = `${date}_${window.currentService}`;
                const slots = volunteers[serviceKey] || [];
                const supervisor = scheduledSupervisors[serviceKey] || null;
                
                let volunteersText = '';
                if (slots.length === 0) {
                    volunteersText = '<p style="color: #999;">No volunteers scheduled yet</p>';
                } else {
                    volunteersText = '<p><strong>Volunteers:</strong></p>';
                    slots.forEach((vol, idx) => {
                        volunteersText += `<p>${idx + 1}. ${vol.name}</p>`;
                    });
                    if (slots.length < 2) {
                        volunteersText += '<p style="color: #ff6b6b;">Still need ' + (2 - slots.length) + ' more volunteer(s)</p>';
                    }
                }
                
                let supervisorText = '';
                if (supervisor) {
                    supervisorText = `<p><strong>Supervisor:</strong> ${supervisor.firstName} ${supervisor.lastName}</p>`;
                } else {
                    supervisorText = '<p style="color: #999;"><strong>Supervisor:</strong> Not assigned yet</p>';
                }
                
                // Add sign-up button if not full
                let signUpButton = '';
                if (slots.length < 2) {
                    signUpButton = `<button class="btn-success btn-sm" onclick="showScheduleSignUpForm('${date}')" style="margin-top: 8px;">Sign Up for This Date</button>`;
                }
                
                scheduleHTML += `
                    <div class="schedule-date-block">
                        <h4>${date}</h4>
                        ${volunteersText}
                        ${supervisorText}
                        ${signUpButton}
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.id = 'schedule-view-modal';
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div id="schedule-view-content">
                    <button class="card-close-btn" onclick="this.closest('.success-modal').remove()">‚úï</button>
                    ${scheduleHTML}
                    <button class="btn-primary" onclick="this.closest('.success-modal').remove()" style="margin-top: 20px;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‚îÄ‚îÄ‚îÄ Schedule Sign-Up Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showScheduleSignUpForm(date) {
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-content" style="max-width: 500px;">
                    <h2 style="color: var(--primary); margin-top: 0;">Sign Up for ${date}</h2>
                    <p>Enter your information to volunteer:</p>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        Phone Number:
                        <input type="tel" id="schedule-signup-phone" placeholder="(000) 000-0000" inputmode="numeric" maxlength="14"
                               oninput="formatPhone(this); onScheduleSignupPhoneInput()" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        First Name:
                        <input type="text" id="schedule-signup-first" placeholder="First name" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        Last Name:
                        <input type="text" id="schedule-signup-last" placeholder="Last name" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <div style="margin-top: 20px;">
                        <button class="btn-success" onclick="submitScheduleSignup('${date}')">Submit</button>
                        <button class="btn-outline" onclick="this.closest('.success-modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
            
            setTimeout(() => document.getElementById('schedule-signup-phone').focus(), 100);
        }

        // ‚îÄ‚îÄ‚îÄ Auto-fill names when phone is recognized ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onScheduleSignupPhoneInput() {
            const phoneInput = document.getElementById('schedule-signup-phone');
            const phone = phoneInput.value.replace(/\D/g, '');
            
            if (phone.length === 10) {
                // Check volunteers.all database FIRST (priority for volunteer signups)
                if (volunteers.all) {
                    const vol = volunteers.all.find(v => v.phone === phone);
                    if (vol) {
                        document.getElementById('schedule-signup-first').value = vol.firstName || '';
                        document.getElementById('schedule-signup-last').value = vol.lastName || '';
                        return;
                    }
                }
                
                // Check familyDatabase as fallback
                if (familyDatabase[phone]) {
                    const family = familyDatabase[phone];
                    document.getElementById('schedule-signup-first').value = family.firstName || '';
                    document.getElementById('schedule-signup-last').value = family.lastName || '';
                    return;
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ Submit schedule sign-up (DIRECT - NO ADMIN APPROVAL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function submitScheduleSignup(date) {
            const phone = document.getElementById('schedule-signup-phone').value.replace(/\D/g, '');
            const first = document.getElementById('schedule-signup-first').value.trim();
            const last = document.getElementById('schedule-signup-last').value.trim();
            
            if (!phone || phone.length !== 10) {
                showCenteredAlert('Please enter a valid 10-digit phone number');
                return;
            }
            
            if (!first || !last) {
                showCenteredAlert('Please enter both first and last name');
                return;
            }
            
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            
            // CHECK BEFORE SAVING
            // Initialize volunteers[serviceKey] if it doesn't exist
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            
            // Check if date is already full
            if (volunteers[serviceKey].length >= 2) {
                document.querySelector('.success-modal').remove();
                showCenteredAlert("This date is already full.");
                return;
            }
            
            // Check if this phone is already signed up for this date
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                document.querySelector('.success-modal').remove();
                showCenteredAlert("This phone number is already signed up for this date.");
                return;
            }
            
            // Close the sign-up form
            document.querySelector('.success-modal').remove();
            
            // DIRECT SIGNUP - NO ADMIN APPROVAL NEEDED
            const fullName = `${first} ${last}`;
            
            // Add to volunteers list for this date with service key
            volunteers[serviceKey].push({ 
                name: fullName, 
                phone: phone,
                service: window.currentService
            });
            
            // Save to volunteers.all database (volunteer database) - keyed by phone
            if (!volunteers.all) volunteers.all = [];
            
            // Check if volunteer already exists in database
            const existingVolIndex = volunteers.all.findIndex(v => v.phone === phone);
            
            if (existingVolIndex === -1) {
                // New volunteer - add to database
                volunteers.all.push({
                    phone: phone,
                    firstName: first,
                    lastName: last,
                    name: fullName,
                    signupDates: [date]
                });
            } else {
                // Existing volunteer - update their info and add date
                volunteers.all[existingVolIndex].firstName = first;
                volunteers.all[existingVolIndex].lastName = last;
                volunteers.all[existingVolIndex].name = fullName;
                
                if (!volunteers.all[existingVolIndex].signupDates) {
                    volunteers.all[existingVolIndex].signupDates = [];
                }
                if (!volunteers.all[existingVolIndex].signupDates.includes(date)) {
                    volunteers.all[existingVolIndex].signupDates.push(date);
                }
            }
            
            // Persist data
            saveData();
            
            // Close success alert after a moment and refresh schedule
            setTimeout(() => {
                // Remove any success alert
                const alerts = document.querySelectorAll('.success-modal');
                alerts.forEach(a => a.remove());
                
                // Refresh the schedule view
                showScheduleView();
            }, 1500);
            
            // Show success message
            showCenteredAlert(`‚úÖ ${fullName} signed up for ${date}!`);
        }

        // ‚îÄ‚îÄ‚îÄ Admin approval with numpad (DEPRECATED - NO LONGER USED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showAdminApprovalForSignup(date, phone, first, last) {
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-content" style="max-width: 95%; width: 420px;">
                    <h2 style="color: var(--primary); margin-top: 0; font-size: clamp(1.3rem, 4vw, 1.6rem);">Admin Approval Required</h2>
                    <p style="margin-bottom: 15px; font-size: clamp(0.95rem, 2.5vw, 1.1rem);">Enter admin PIN to approve sign-up for <strong>${first} ${last}</strong></p>
                    <div id="approval-pin-display" style="font-size: clamp(2rem, 6vw, 3rem); letter-spacing: clamp(10px, 3vw, 16px); margin: 20px 0; min-height: 60px; color: var(--text); font-weight: 700; text-align: center;"></div>
                    <div class="numpad">
                        <button class="numpad-btn" onclick="adminApprovalPinInput('1')">1</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('2')">2</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('3')">3</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('4')">4</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('5')">5</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('6')">6</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('7')">7</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('8')">8</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('9')">9</button>
                        <button class="numpad-btn small-btn" onclick="adminApprovalPinInput('clear')">Clear</button>
                        <button class="numpad-btn" onclick="adminApprovalPinInput('0')">0</button>
                        <button class="numpad-btn small-btn" onclick="checkAdminApprovalPin('${date}', '${phone}', '${first}', '${last}')">Enter</button>
                    </div>
                    <button class="btn-outline" onclick="this.closest('.success-modal').remove()" style="margin-top: 10px;">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentApprovalPin = '';
        }

        function adminApprovalPinInput(digit) {
            if (digit === 'clear') {
                window.currentApprovalPin = '';
            } else {
                window.currentApprovalPin = (window.currentApprovalPin || '') + digit;
            }
            // Show dots instead of actual PIN
            document.getElementById('approval-pin-display').textContent = '‚Ä¢'.repeat(window.currentApprovalPin.length);
        }

        function checkAdminApprovalPin(date, phone, first, last) {
            if (window.currentApprovalPin === ADMIN_PASSWORD) {
                // Approved! Now ask if member or non-member
                document.querySelector('.success-modal').remove();
                showMembershipQuestion(date, phone, first, last);
            } else {
                showCenteredAlert('Incorrect PIN');
                window.currentApprovalPin = '';
                document.getElementById('approval-pin-display').textContent = '';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Ask if member or non-member ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showMembershipQuestion(date, phone, first, last) {
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-content">
                    <h2 style="color: var(--primary); margin-top: 0;">Is ${first} ${last} a member?</h2>
                    <div style="margin-top: 20px;">
                        <button class="btn-success" onclick="completeScheduleSignup('${date}', '${phone}', '${first}', '${last}', true)" style="margin: 10px;">Yes, Member</button>
                        <button class="btn-primary" onclick="completeScheduleSignup('${date}', '${phone}', '${first}', '${last}', false)" style="margin: 10px;">No, Non-Member</button>
                    </div>
                    <button class="btn-outline" onclick="this.closest('.success-modal').remove()" style="margin-top: 20px;">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‚îÄ‚îÄ‚îÄ Complete sign-up and save to database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function completeScheduleSignup(date, phone, first, last, isMember) {
            const name = `${first} ${last}`;
            
            // Add to volunteers for this date
            if (!volunteers[date]) volunteers[date] = [];
            
            if (volunteers[date].length >= 2) {
                showCenteredAlert("This date is now full.");
                document.querySelector('.success-modal').remove();
                return;
            }
            
            if (volunteers[date].some(v => v.phone === phone)) {
                showCenteredAlert("This person is already signed up for this date.");
                document.querySelector('.success-modal').remove();
                return;
            }
            
            const vol = { name, phone };
            volunteers[date].push(vol);
            addToVolunteerAllIfNotExists(vol);
            
            // Save to familyDatabase if not already there
            if (!familyDatabase[phone]) {
                familyDatabase[phone] = {
                    firstName: first,
                    lastName: last,
                    isMember: isMember,
                    kids: []
                };
            }
            
            saveData();
            
            // Close all modals
            document.querySelectorAll('.success-modal').forEach(m => m.remove());
            if (document.getElementById('schedule-view-modal')) {
                document.getElementById('schedule-view-modal').remove();
            }
            
            // Show brief success message that auto-closes
            showCenteredAlert(`${name} successfully signed up for ${date}!`, 'Success');
            
            // Auto-close the alert and refresh schedule view
            setTimeout(() => {
                closeCenteredAlert();
                showScheduleView();
            }, 1500);
        }

        // ‚îÄ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => {
            const nonMemBtn = document.getElementById('continue-nonmember');
            const memBtn = document.getElementById('continue-member');

            if (nonMemBtn) {
                nonMemBtn.addEventListener('click', handleNonMemberPhone);
                document.getElementById('nonmem-phone')
                    .addEventListener('keydown', e => {
                        if (e.key === 'Enter') nonMemBtn.click();
                    });
            }

            if (memBtn) {
                memBtn.addEventListener('click', () => {
                    const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
                    if (phone.length !== 10) {
                        alert('Please enter a valid 10-digit phone number');
                        return;
                    }
                    
                    // Check if this phone is already scheduled in next 8 weeks
                    const upcomingSundays = getUpcomingSundays(8);
                    let isScheduled = false;
                    let scheduledName = '';
                    
                    for (const date of upcomingSundays) {
                        const slots = volunteers[date] || [];
                        const found = slots.find(v => v.phone === phone);
                        if (found) {
                            isScheduled = true;
                            scheduledName = found.name;
                            break;
                        }
                    }
                    
                    // If scheduled, skip directly to kids check-in
                    if (isScheduled && familyDatabase[phone]) {
                        const family = familyDatabase[phone];
                        isMemberPath = true;
                        memberPhone = document.getElementById('vol-phone-first').value;
                        memberFirst = family.firstName || '';
                        memberLast = family.lastName || '';
                        
                        // Go directly to child check-in
                        document.getElementById('phone').value = memberPhone;
                        document.getElementById('firstName').value = memberFirst;
                        document.getElementById('lastName').value = memberLast;
                        
                        // Prefill kids
                        if (family.kids && family.kids.length > 0) {
                            document.getElementById('children-list').innerHTML = '';
                            childCounter = 0;
                            family.kids.forEach(child => {
                                childCounter++;
                                const div = document.createElement('div');
                                div.className = 'child-entry';
                                const allergiesValue = child.allergies || '';
                                const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                                const otherText = isOther ? allergiesValue : '';
                                
                                div.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                            <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                <strong>Child:</strong>
                                                <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                            </label>
                                            <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                <strong>Age:</strong>
                                                <select class="child-age" style="width: 110px; color:#bbb;" required onchange="this.style.color='#000'">
                                                    <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                                    ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                                </select>
                                            </label>
                                            <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                <strong>Allergies:</strong>
                                                <select class="child-allergies" style="width: 140px; color:#bbb;" required onchange="this.style.color='#000'">
                                                    <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                                    <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                                    <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                                </select>
                                            </label>
                                            <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                                        </div>
                                        
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                            <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                                        </button>
                                    </div>
                                `;
                                document.getElementById('children-list').appendChild(div);
                                attachAllergyHandler(div);
                            });
                        } else {
                            document.getElementById('children-list').innerHTML = '';
                            addChildEntry();
                        }
                        
                        show('info-form');
                        return;
                    }
                    
                    // Not scheduled or no family data - show volunteer form
                    // Prefill names if this phone exists in familyDatabase
                    if (familyDatabase[phone]) {
                        const family = familyDatabase[phone];
                        document.getElementById('vol-first').value = family.firstName || '';
                        document.getElementById('vol-last').value = family.lastName || '';
                    } else {
                        // Clear fields for new user
                        document.getElementById('vol-first').value = '';
                        document.getElementById('vol-last').value = '';
                    }
                    
                    show('volunteer-form');
                });

                document.getElementById('vol-phone-first')
                    .addEventListener('keydown', e => {
                        if (e.key === 'Enter') memBtn.click();
                    });
            }
        });
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDchZXJyercgztvVv7I57Ol53NDoLFfEEk",
            authDomain: "bible-land-check-in.firebaseapp.com",
            projectId: "bible-land-check-in",
            storageBucket: "bible-land-check-in.firebasestorage.app",
            messagingSenderId: "839634881652",
            appId: "1:839634881652:web:80410e2b38965312b2d521"
        };

        const CHURCH_CODE = 'bibleland2025';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseDB = db;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.currentUserId = null;
        window.isSignupMode = false;

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                document.getElementById('user-email-display').textContent = user.email;
                // Set profile initial (first letter of email)
                const initial = user.email.charAt(0).toUpperCase();
                document.getElementById('user-initial').textContent = initial;
                
                // Show loading
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Load user profile to check service selection
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let selectedService = null;
                
                if (userDoc.exists()) {
                    selectedService = userDoc.data().selectedService;
                }
                
                // If no service selected, show service selection screen
                if (!selectedService) {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('service-selection-screen').classList.remove('hidden');
                    return;
                }
                
                // Store current service
                window.currentService = selectedService;
                updateServiceDisplay(selectedService);
                
                // Load data from Firestore
                await loadFromFirestore();
                
                // Hide loading, show main app
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');
                    show('main-screen');
                }, 1000);
                
                // Set up real-time sync listener
                setupRealtimeSync();
            } else {
                window.currentUserId = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app-container').classList.add('hidden');
            }
        });

        // Load data from Firestore
        async function loadFromFirestore() {
            try {
                updateSyncIndicator('syncing');
                // Use shared data location for the church
                const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
                const docSnap = await getDoc(sharedDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update global variables with shared data
                    if (data.parents) window.parents = data.parents;
                    if (data.checkIns) window.checkIns = data.checkIns;
                    if (data.usedBuzzers) window.usedBuzzers = new Set(data.usedBuzzers);
                    if (data.volunteers) window.volunteers = data.volunteers;
                    if (data.familyDatabase) window.familyDatabase = data.familyDatabase;
                    if (data.weeklyReports) window.weeklyReports = data.weeklyReports;
                    if (data.supervisorDatabase) window.supervisorDatabase = data.supervisorDatabase;
                    if (data.scheduledSupervisors) window.scheduledSupervisors = data.scheduledSupervisors;
                    
                    // Also save to localStorage for backup
                    originalSaveData();
                    
                    console.log('‚úÖ Shared data loaded from cloud');
                } else {
                    // Document doesn't exist - initialize with empty data structures
                    console.log('üìù No shared data found - initializing fresh');
                    window.parents = window.parents || {};
                    window.checkIns = window.checkIns || [];
                    window.usedBuzzers = window.usedBuzzers || new Set();
                    window.volunteers = window.volunteers || {};
                    window.familyDatabase = window.familyDatabase || {};
                    window.weeklyReports = window.weeklyReports || {};
                    window.supervisorDatabase = window.supervisorDatabase || {};
                    window.scheduledSupervisors = window.scheduledSupervisors || {};
                    
                    // Create the document with empty structures
                    await window.saveData();
                }
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                // Initialize with empty data on error
                window.parents = window.parents || {};
                window.checkIns = window.checkIns || [];
                window.usedBuzzers = window.usedBuzzers || new Set();
                window.volunteers = window.volunteers || {};
                window.familyDatabase = window.familyDatabase || {};
                window.weeklyReports = window.weeklyReports || {};
                window.supervisorDatabase = window.supervisorDatabase || {};
                window.scheduledSupervisors = window.scheduledSupervisors || {};
                updateSyncIndicator('synced');
            }
        }

        // Save data to Firestore (override the original saveData)
        const originalSaveData = window.saveData;
        window.saveData = async function() {
            // Save to localStorage first (backup)
            originalSaveData();
            
            // Save to Firestore shared location
            if (!window.currentUserId) {
                console.log('‚ö†Ô∏è Not saving to cloud - no user ID');
                return;
            }
            
            try {
                updateSyncIndicator('syncing');
                isLocalUpdate = true; // Mark this as a local update
                
                // Use shared data location for the church
                const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
                
                console.log('üíæ Saving to cloud...');
                console.log('   Check-ins:', window.checkIns?.length || 0);
                console.log('   Families:', Object.keys(window.familyDatabase || {}).length);
                console.log('   Supervisors:', Object.keys(window.supervisorDatabase || {}).length);
                console.log('   Volunteers (all):', window.volunteers?.all?.length || 0);
                
                // Use setDoc WITHOUT merge to replace entire document
                // This ensures deletions are properly synced
                await setDoc(sharedDocRef, {
                    parents: window.parents || {},
                    checkIns: window.checkIns || [],
                    usedBuzzers: [...(window.usedBuzzers || [])],
                    volunteers: window.volunteers || {},
                    familyDatabase: window.familyDatabase || {},
                    weeklyReports: window.weeklyReports || {},
                    supervisorDatabase: window.supervisorDatabase || {},
                    scheduledSupervisors: window.scheduledSupervisors || {},
                    lastUpdated: new Date().toISOString(),
                    lastUpdatedBy: window.currentUserId
                });
                
                console.log('‚úÖ Saved to shared cloud data successfully!');
                updateSyncIndicator('synced');
                
                // Reset flag after 2 seconds
                setTimeout(() => {
                    isLocalUpdate = false;
                }, 2000);
            } catch (error) {
                console.error('‚ùå Error saving to Firestore:', error);
                console.error('   Error code:', error.code);
                console.error('   Error message:', error.message);
                updateSyncIndicator('synced');
                isLocalUpdate = false;
            }
        };

        // Real-time sync listener
        let lastUpdateBy = null;
        let lastUpdateTime = null;
        let isLocalUpdate = false;
        let isInitialLoad = true;
        
        function setupRealtimeSync() {
            if (!window.currentUserId) return;
            
            try {
                // Listen to shared data location
                const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
                
                console.log('üì° Setting up real-time sync listener...');
                
                const unsubscribe = onSnapshot(sharedDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        
                        // Skip initial load from listener (we already loaded in loadFromFirestore)
                        if (isInitialLoad) {
                            console.log('‚è≠Ô∏è Skipping initial listener load');
                            lastUpdateBy = data.lastUpdatedBy;
                            lastUpdateTime = data.lastUpdated;
                            isInitialLoad = false;
                            return;
                        }
                        
                        // Skip if this is a local update (within 2 seconds of our own save)
                        if (data.lastUpdatedBy === window.currentUserId && isLocalUpdate) {
                            console.log('‚è≠Ô∏è Skipping self-triggered update');
                            return;
                        }
                        
                        // Skip if this is the exact same update we just processed
                        if (data.lastUpdatedBy === lastUpdateBy && data.lastUpdated === lastUpdateTime) {
                            console.log('‚è≠Ô∏è Skipping duplicate update');
                            return;
                        }
                        
                        lastUpdateBy = data.lastUpdatedBy;
                        lastUpdateTime = data.lastUpdated;
                        
                        console.log('üîÑ Real-time update received from cloud');
                        console.log('   Check-ins:', data.checkIns?.length || 0);
                        console.log('   Families:', Object.keys(data.familyDatabase || {}).length);
                        
                        // Update local data with cloud changes
                        if (data.parents) window.parents = data.parents;
                        if (data.checkIns) window.checkIns = data.checkIns;
                        if (data.usedBuzzers) window.usedBuzzers = new Set(data.usedBuzzers);
                        if (data.volunteers) window.volunteers = data.volunteers;
                        if (data.familyDatabase) window.familyDatabase = data.familyDatabase;
                        if (data.weeklyReports) window.weeklyReports = data.weeklyReports;
                        if (data.supervisorDatabase) window.supervisorDatabase = data.supervisorDatabase;
                        if (data.scheduledSupervisors) window.scheduledSupervisors = data.scheduledSupervisors;
                        
                        // Save to localStorage as backup
                        originalSaveData();
                        
                        // Refresh current view if needed
                        const currentView = document.querySelector('.card:not(.hidden)');
                        if (currentView) {
                            if (currentView.id === 'view-checkins') {
                                renderCheckInTable();
                            }
                            if (currentView.id === 'admin-area') {
                                // Refresh family database if visible
                                const familyDbView = document.getElementById('family-db-view');
                                if (familyDbView && !familyDbView.classList.contains('hidden')) {
                                    renderFamilyDatabase();
                                }
                                // Refresh supervisor database if visible
                                const supervisorDbView = document.getElementById('supervisor-db-view');
                                if (supervisorDbView && !supervisorDbView.classList.contains('hidden')) {
                                    renderSupervisorDatabase();
                                }
                            }
                        }
                    } else {
                        console.log('üì≠ No shared data exists yet - will be created on first save');
                    }
                }, (error) => {
                    console.error('‚ùå Real-time sync error:', error);
                });
                
                // Store unsubscribe function
                window.realtimeSyncUnsubscribe = unsubscribe;
                
            } catch (error) {
                console.error('‚ùå Error setting up real-time sync:', error);
            }
        }

        // Update sync indicator
        function updateSyncIndicator(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            
            if (!dot || !text) return;
            
            if (status === 'syncing') {
                dot.className = 'sync-dot syncing';
                text.textContent = 'Syncing...';
            } else {
                dot.className = 'sync-dot';
                text.textContent = 'Synced';
            }
        }

        // Handle login/signup
        window.handleLogin = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (window.isSignupMode) {
                const churchCode = document.getElementById('church-code').value.trim();
                
                if (churchCode !== CHURCH_CODE) {
                    errorDiv.textContent = 'Invalid church code. Please contact your administrator.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
            }
            
            try {
                if (window.isSignupMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    successDiv.textContent = '‚úÖ Account created! Loading...';
                    successDiv.classList.remove('hidden');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let message = 'An error occurred. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'This email is already registered. Try signing in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                } else if (error.code === 'auth/user-not-found') {
                    message = 'No account found with this email';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password';
                } else if (error.code === 'auth/invalid-credential') {
                    message = 'Invalid email or password';
                }
                
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        };

        // Toggle between login and signup
        window.toggleAuthMode = function() {
            window.isSignupMode = !window.isSignupMode;
            const btnLogin = document.getElementById('btn-login');
            const toggleText = document.getElementById('toggle-text');
            const toggleLink = document.getElementById('toggle-link');
            const churchCodeField = document.getElementById('church-code-field');
            
            if (window.isSignupMode) {
                btnLogin.textContent = 'Create Account';
                toggleText.textContent = 'Already have an account? ';
                toggleLink.textContent = 'Sign in';
                churchCodeField.classList.remove('hidden');
            } else {
                btnLogin.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account? ";
                toggleLink.textContent = 'Create one';
                churchCodeField.classList.add('hidden');
            }
            
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
        };

        // Toggle profile dropdown
        window.toggleProfileDropdown = function() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('show');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && !userInfo.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Handle logout
        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                await signOut(auth);
            }
        };

        // Service selection functions
        window.selectService = async function(service) {
            if (!window.currentUserId) return;
            
            try {
                // Save service preference to user profile
                await setDoc(doc(db, 'users', window.currentUserId), {
                    selectedService: service,
                    email: auth.currentUser.email
                }, { merge: true });
                
                window.currentService = service;
                updateServiceDisplay(service);
                
                // Hide service selection, show loading
                document.getElementById('service-selection-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Load data from Firestore
                await loadFromFirestore();
                
                // Show main app
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');
                    show('main-screen');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving service selection:', error);
                alert('Failed to save service selection. Please try again.');
            }
        };

        window.updateServiceDisplay = function(service) {
            const serviceName = service === 'russian' ? 'üá∑üá∫ Russian Service (9:00 AM)' : 'üá∫üá∏ English Service (12:00 PM)';
            const serviceColor = service === 'russian' ? '#ff6b6b' : '#4a90e2';
            
            const mainDisplay = document.getElementById('current-service-display');
            const profileDisplay = document.getElementById('profile-service-display');
            
            if (mainDisplay) {
                mainDisplay.textContent = serviceName;
                mainDisplay.style.background = service === 'russian' ? '#ffe6e6' : '#e3f2fd';
                mainDisplay.style.color = serviceColor;
            }
            
            if (profileDisplay) {
                profileDisplay.textContent = serviceName;
                profileDisplay.style.color = serviceColor;
            }
        };

        window.showServiceSwitchModal = function() {
            document.getElementById('service-switch-modal').classList.remove('hidden');
        };

        window.closeServiceSwitchModal = function() {
            document.getElementById('service-switch-modal').classList.add('hidden');
        };

        window.confirmServiceSwitch = async function(service) {
            if (service === window.currentService) {
                alert('You are already on this service.');
                closeServiceSwitchModal();
                return;
            }
            
            if (confirm(`Switch to ${service === 'russian' ? 'Russian (9 AM)' : 'English (12 PM)'} service?`)) {
                try {
                    await setDoc(doc(db, 'users', window.currentUserId), {
                        selectedService: service
                    }, { merge: true });
                    
                    window.currentService = service;
                    updateServiceDisplay(service);
                    closeServiceSwitchModal();
                    
                    // Refresh current view to show data for new service
                    const currentView = document.querySelector('.card:not(.hidden)');
                    if (currentView && currentView.id === 'view-checkins') {
                        renderCheckInTable();
                    }
                    
                    alert('Service switched successfully!');
                } catch (error) {
                    console.error('Error switching service:', error);
                    alert('Failed to switch service. Please try again.');
                }
            } else {
                closeServiceSwitchModal();
            }
        };

        // Enter key support for login
        document.getElementById('auth-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('auth-password').focus();
        });
        
        document.getElementById('auth-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (window.isSignupMode) {
                    document.getElementById('church-code').focus();
                } else {
                    handleLogin();
                }
            }
        });
        
        document.getElementById('church-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        console.log('üî• Firebase initialized');
        console.log('‚úÖ Cloud database connected');
        console.log('üîê Church code: ' + CHURCH_CODE);
    </script>

    </div><!-- End main-app-container -->
</body></html>
