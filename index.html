<!DOCTYPE html>
<!-- saved from url=(0055)file:///C:/Users/Alpine/Desktop/test%20no%20sunday.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Content Security Policy: only allow scripts/connections from trusted domains -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com;
        connect-src 'self'
            https://*.googleapis.com
            https://*.firebaseio.com
            https://*.firebaseapp.com
            https://identitytoolkit.googleapis.com
            https://securetoken.googleapis.com
            https://firestore.googleapis.com
            https://www.googleapis.com
            https://firebase.googleapis.com
            https://www.gstatic.com
            https://*.gstatic.com
            https://www.google.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        img-src 'self' data: https://www.gstatic.com;
        font-src 'self' data: https://fonts.gstatic.com;
        frame-src https://bible-land-check-in.firebaseapp.com;
        object-src 'none';
    ">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Bible Land Check-In ‚òÅÔ∏è üåü</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kids Check-In">
    <style>
        /* Prevent double-tap zoom globally */
        * {
            touch-action: manipulation;
            box-sizing: border-box;
        }
        
        /* Allow inputs to be focusable, especially in PWA mode */
        input, textarea, select {
            touch-action: auto;
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Prevent text overflow */
        body, div, p, span, td, th {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        :root {
            --primary: #4a90e2;
            --primary-light: #a3d0ff;
            --success: #50c878;
            --warning: #ffaa33;
            --bg: #f0f7ff;
            --card: #ffffff;
            --text: #2c3e50;
            --shadow: 0 8px 25px rgba(74, 144, 226, 0.18);
        }

        body {
            font-family: "Segoe UI", system-ui, sans-serif;
            background: linear-gradient(135deg, #e0f2ff, #f0f7ff);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        h1,
        h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 0.6em;
        }

        .card {
            background: var(--card);
            border-radius: 24px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin: 20px 0;
            position: relative;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        #login-screen {
            max-width: 520px;
            margin: 40px auto;
            padding: 40px 32px;
        }

        #login-screen h1 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
                border-radius: 16px;
                margin: 10px 0;
            }

            #login-screen {
                margin: 20px auto;
                padding: 24px 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.2rem;
            }
        }

        .main-buttons {
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
            margin: 60px 0 40px;
        }

        .main-buttons button {
            font-size: 1.5rem;
            padding: 24px 48px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            max-width: 420px;
            color: white;
            transition: all 0.2s;
        }

        .main-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        #btn-checkin {
            background: var(--success);
        }

        #btn-view {
            background: var(--primary);
        }

        #btn-schedule {
            background: #9b59b6;
        }

        #btn-admin {
            background: #7f8c8d;
        }

        .hidden {
            display: none !important;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
        }
        
        .modal-overlay:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        
        .modal-overlay-high {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
        }
        
        .modal-overlay-high:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }

        input[type="tel"],
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="email"],
        select {
            font-size: 16px; /* iOS requires 16px minimum to prevent auto-zoom and ensure keyboard appears */
            padding: 14px 18px;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            width: 100%;
            max-width: 340px;
            margin: 10px 0;
            box-sizing: border-box;
            /* Ensure inputs are interactive on iOS/iPad PWA */
            -webkit-appearance: none;
            -webkit-tap-highlight-color: rgba(74, 144, 226, 0.2);
            pointer-events: auto;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
        }
        
        /* Ensure inputs are large enough on all devices for iOS PWA */
        @media (max-width: 768px) {
            input[type="tel"],
            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="email"],
            select {
                font-size: 16px; /* Must be 16px or larger on iOS to trigger keyboard properly */
                padding: 12px 14px;
                max-width: 100%;
            }
        }

        button:not(.main-buttons button, .numpad-btn, .db-btn) {
            font-size: 1.15rem;
            padding: 14px 28px;
            border-radius: 16px;
            margin: 10px 6px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            button:not(.main-buttons button, .numpad-btn, .db-btn) {
                font-size: 1rem;
                padding: 12px 20px;
                margin: 8px 4px;
            }
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
        }

        /* Card close button (X) ‚Äî consistent red on every page */
        .card-close-btn {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 40px;
            height: 40px;
            border: none;
            background: #ef4444;
            border-radius: 50%;
            font-size: 1.3rem;
            line-height: 1;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            padding: 0;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.35);
            font-weight: 600;
        }

        .card-close-btn:hover {
            background: #dc2626;
            transform: scale(1.08);
            box-shadow: 0 5px 14px rgba(239, 68, 68, 0.5);
        }

        .card-close-btn:active {
            transform: scale(0.95);
        }

        /* Make sure cards have relative positioning for absolute close button */
        .card {
            position: relative;
        }



        /* Custom confirmation modal */
        #confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #confirm-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #confirm-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 360px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #confirm-content h3 {
            margin-top: 0;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            #confirm-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #confirm-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        #confirm-content .modal-buttons {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            #confirm-content .modal-buttons {
                gap: 10px;
            }
            
            #confirm-content .modal-buttons button {
                min-width: 100px;
            }
        }

        /* Success modal styles */
        .success-modal,
        .checkin-success-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .success-modal:not(.hidden),
        .checkin-success-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .success-modal:not(.hidden),
            .checkin-success-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            .success-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        .success-content h2 {
            color: var(--success);
            margin-top: 0;
        }

        /* Schedule view modal */
        #schedule-view-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #schedule-view-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #schedule-view-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 700px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            margin: 20px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            #schedule-view-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #schedule-view-content {
                padding: 24px 16px;
                margin: 10px;
                max-height: 85vh;
            }
        }

        #schedule-view-content .card-close-btn {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 10001;
            width: 50px;
            height: 50px;
            font-size: 1.4rem;
        }

        #schedule-view-content .card-close-btn:hover {
            background: #dc2626;
            transform: scale(1.08);
        }

        .schedule-date-block {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary);
        }

        .schedule-date-block h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
        }

        .schedule-date-block p {
            margin: 4px 0;
            color: var(--text);
        }

        /* Admin password modal ‚Äî see newer block below */

        /* Validation modal */
        #validation-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #validation-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #validation-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        #validation-content h3 {
            margin-top: 0;
            color: #ef4444;
        }

        #validation-content p {
            font-size: 1.1rem;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            #validation-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            #validation-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
            
            #validation-content p {
                font-size: 1rem;
            }
        }

        .child-name-group {
            display: block;
            margin-bottom: 8px;
        }

        .child-allergies::placeholder {
            color: #555;
        }

        /* Age & Allergies dropdowns ‚Äî same look as name field, never grey */
        select.child-age,
        select.child-allergies {
            color: #2c3e50 !important;
            background: #ffffff;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            font-weight: 500;
        }
        select.child-age option[value=""],
        select.child-allergies option[value=""] {
            color: #888;
        }

        .child-entry {
            background: #f8fbff;
            border: 2px dashed #c3daff;
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .child-entry {
                padding: 12px;
                margin: 12px 0;
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            min-width: 600px;
        }

        @media (max-width: 768px) {
            table {
                min-width: 100%;
                font-size: 0.85rem;
                border-spacing: 0 6px;
            }
            
            th, td {
                padding: 6px 3px;
                font-size: 0.8rem;
            }
            
            th {
                padding: 6px 4px;
            }
        }
        
        @media (max-width: 480px) {
            table {
                font-size: 0.75rem;
                border-spacing: 0 4px;
            }
            
            th, td {
                padding: 4px 2px;
                font-size: 0.7rem;
            }
            
            /* Abbreviate column headers on very small screens */
            th {
                font-size: 0.65rem;
                padding: 4px 2px;
            }
            
            /* Extra small buttons in tables */
            table .btn-sm,
            table button {
                font-size: 0.6rem;
                padding: 3px 6px;
                border-radius: 4px;
            }
            
            /* Make action emojis smaller */
            .volunteer-actions {
                font-size: 1.2rem;
            }
        }

        th {
            background: var(--primary);
            color: white;
            padding: 8px;
            border-radius: 12px 12px 0 0;
        }

        td {
            background: white;
            padding: 8px;
            border-radius: 12px;
        }

        .phone-cell {
            display: table-cell;
            cursor: default;
        }

        .phone-revealed .phone-cell {
            cursor: default;
        }

        .volunteer-name,
        .volunteer-phone {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .volunteer-name:hover,
        .volunteer-phone:hover {
            background: #e8f0fe;
            text-decoration: underline;
        }

        .volunteer-actions {
            font-size: 1.4rem;
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            opacity: 0.7;
        }

        .volunteer-actions:hover {
            opacity: 1;
            transform: scale(1.15);
        }

        .inline-edit {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .inline-edit input {
            font-size: 1rem;
            padding: 4px 8px;
            width: 140px;
            border: 1px solid #a3d0ff;
            border-radius: 6px;
        }

        .add-vol-form {
            margin-top: 12px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 12px;
            border: 1px solid #d1e3ff;
        }

        #buzzer-grid {
            display: grid;
            /* auto-fill with minmax: fits as many 70px+ columns as space allows.
               On desktop this yields 8 columns; on smaller screens it shrinks
               gracefully ‚Äî never clips, never overflows. */
            grid-template-columns: repeat(auto-fill, minmax(clamp(44px, 10vw, 72px), 1fr));
            gap: clamp(5px, 1.2vw, 12px);
            width: 100%;
            max-width: 700px;
            margin: 20px auto;
            padding: 0 12px;
            box-sizing: border-box;
            overflow: visible;
        }

        .buzzer-btn {
            font-size: clamp(0.75rem, 2vw, 1.2rem);
            padding: 0;
            border-radius: 10px;
            border: 2px solid #d1e3ff;
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            box-sizing: border-box;
        }

        .buzzer-btn:hover:not(.unavailable) {
            background: var(--primary-light);
            transform: scale(1.08);
        }

        .buzzer-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.3);
        }

        .buzzer-btn.unavailable {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .buzzer-btn.available {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        /* TABLET */
        @media (max-width: 768px) {
            #buzzer-grid {
                max-width: 100%;
                padding: 0 8px;
                gap: clamp(4px, 1.5vw, 10px);
                grid-template-columns: repeat(auto-fill, minmax(clamp(44px, 11vw, 70px), 1fr));
            }
        }

        /* MOBILE PORTRAIT */
        @media (max-width: 480px) {
            #buzzer-grid {
                padding: 0 6px;
                gap: 5px;
                grid-template-columns: repeat(auto-fill, minmax(clamp(44px, 13vw, 60px), 1fr));
            }
        }

        /* MOBILE LANDSCAPE ‚Äî tighter rows, same column logic */
        @media (max-height: 500px) and (orientation: landscape) {
            #buzzer-grid {
                grid-template-columns: repeat(auto-fill, minmax(clamp(40px, 8vw, 58px), 1fr));
                gap: 4px;
                margin: 10px auto;
            }
            .buzzer-btn {
                min-height: 40px;
            }
        }

        .membership-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .schedule-list {
            margin: 20px 0;
        }

        .schedule-item {
            background: #f8fbff;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .schedule-item {
                padding: 10px 12px;
                gap: 6px;
            }
        }

        .schedule-item.open {
            background: #e6ffe6;
            border-color: #b3ffb3;
        }

        .volunteer-form {
            background: var(--card);
            border-radius: 24px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin: 20px 0;
        }

        /* Clock and date display */
        .datetime-display {
            text-align: center;
            margin: 20px 0 30px;
        }

        .current-date {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(74, 144, 226, 0.2);
        }

        .current-time {
            font-size: clamp(2rem, 8vw, 3.2rem);
            color: var(--success);
            font-weight: 700;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: clamp(1px, 0.5vw, 2px);
            text-shadow: 3px 3px 6px rgba(80, 200, 120, 0.3);
        }

        .day-name {
            font-size: 1.3rem;
            color: #7f8c8d;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Modern Admin Styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3f2fd;
        }

/* Fixed close buttons for full-page sections */
#admin-content .card-close-btn,
#view-checkins .card-close-btn {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 10001;
    width: 50px;
    height: 50px;
    font-size: 1.4rem;
}

#admin-content.hidden .card-close-btn,
#view-checkins.hidden .card-close-btn {
    display: none;
}

/* Admin card: fixed height with inner scroll so page doesn't scroll */
#admin-content {
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* Currently Checked In card: same scroll treatment as admin */
#view-checkins {
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}




        .admin-section {
            background: #fff;
            border-radius: 10px;
            padding: 14px 16px 10px;
            margin: 12px 0;
            border: 1.5px solid #deeaff;
            box-sizing: border-box;
            max-width: 100%;
        }

        /* Each section scrolls independently, max 320px tall */
        .admin-section .db-table-wrap,
        .admin-section .admin-scroll {
            max-height: 320px;
            overflow-y: auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 6px;
        }

        .admin-section h2 {
            color: var(--primary);
            font-size: 1rem;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        @media (max-width: 768px) {
            .admin-section {
                padding: 12px;
                margin: 10px 0;
            }
            
            .admin-section h2 {
                font-size: 1.1rem;
            }
        }
        
        /* ‚îÄ‚îÄ Compact Database Tables ‚îÄ‚îÄ */
        .db-search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .db-search-bar input {
            flex: 1;
            padding: 7px 12px;
            border: 1.5px solid #d1e3ff;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text);
            max-width: 100%;
        }
        .db-search-bar input:focus { outline: none; border-color: var(--primary); }
        .db-count { font-size: 0.78rem; color: #888; white-space: nowrap; }

        /* ‚îÄ‚îÄ Compact Database Tables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        /* Override ALL global table/td/th bleed so db-table looks clean */
        .db-table {
            width: auto;
            border-collapse: collapse;
            border-spacing: 0;
            font-size: 0.82rem;
            table-layout: auto;
        }
        .db-table thead th {
            background: #f0f6ff;
            color: #5580aa;
            font-weight: 600;
            font-size: 0.7rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            padding: 6px 10px;
            border-bottom: 2px solid #deeaff;
            border-radius: 0;
            text-align: left;
            white-space: nowrap;
            position: sticky; top: 0; z-index: 1;
        }
        .db-table tbody tr {
            border-bottom: 1px solid #eef3ff;
            transition: background 0.12s;
        }
        .db-table tbody tr:last-child { border-bottom: none; }
        .db-table tbody tr:hover { background: #f0f7ff; }
        /* Reset all global td bleed ‚Äî border-radius, background, padding */
        .db-table td {
            padding: 7px 10px;
            vertical-align: middle;
            color: var(--text);
            overflow: hidden;
            background: transparent;
            border-radius: 0;
        }
        .db-table td.name-cell {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            width: 130px;
        }
        .db-table td.phone-cell-db {
            color: #4a90e2;
            font-size: 0.75rem;
            white-space: nowrap;
            width: 110px;
        }
        /* badge-cell ‚Äî shrink to content */
        .db-table td.badge-cell { white-space: nowrap; width: 1px; padding: 7px 6px; }
        /* kids cell ‚Äî one line, truncate with ellipsis */
        .db-kids-cell {
            font-size: 0.74rem;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            width: 1px;
            padding-right: 10px;
        }
        /* actions cell ‚Äî shrink to buttons, no stretch */
        .db-table td.actions-cell {
            text-align: right;
            white-space: nowrap;
            width: 1px;
            padding: 4px 8px 4px 4px;
            overflow: visible;
        }
        .db-table td.actions-cell > .db-btn + .db-btn { margin-left: 4px; }

        .db-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 0.67rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        .db-badge.member    { background: #e3f2fd; color: #1565c0; }
        .db-badge.nonmember { background: #fff3e0; color: #e65100; }
        .db-badge.allergy   { background: #ffebee; color: #c62828; font-size: 0.65rem; margin-left: 3px; }

        .db-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.72rem;
            line-height: 1;
            transition: background 0.15s, transform 0.1s;
            vertical-align: middle;
        }
        .db-btn:active { transform: scale(0.92); }
        .db-btn.edit  { background: #ddeeff; color: #1565c0; }
        .db-btn.edit:hover  { background: #b3d4f7; }
        .db-btn.del   { background: #fde8e8; color: #b71c1c; }
        .db-btn.del:hover   { background: #fac5c5; }
        .db-btn.assign { background: #e8f5e9; color: #2e7d32; }
        .db-btn.assign:hover { background: #c8e6c9; }
        .db-btn.view-contract-btn { background: #ddeeff; color: #1565c0; }
        .db-btn.view-contract-btn:hover { background: #b3d4f7; }

        /* High-specificity override ‚Äî beats button:not(...) at (0,1,2) */
        .db-table .db-btn {
            width: 24px; height: 24px;
            padding: 0; margin: 0;
            font-size: 0.72rem;
            border-radius: 5px;
            line-height: 1;
            vertical-align: middle;
        }

        .db-assign-select {
            font-size: 0.72rem; padding: 3px 4px;
            border: 1px solid #d1e3ff; border-radius: 6px;
            max-width: 110px; color: var(--text);
        }
        .db-empty { text-align: center; color: #aaa; font-size: 0.85rem; padding: 20px 0; }

        /* ‚îÄ‚îÄ Responsive overrides ‚îÄ‚îÄ */
        @media (max-width: 480px) {
            .db-table td.name-cell { max-width: 90px; width: 80px; font-size: 0.72rem; }
            .db-table td.phone-cell-db { font-size: 0.68rem; width: 80px; }
            .db-table td, .db-table th { padding: 5px 4px; font-size: 0.72rem; }
            .db-btn { width: 22px; height: 22px; font-size: 0.65rem; }
            /* Hide Type column on tiny screens */
            .db-table td.badge-cell,
            .db-table th:nth-child(3) { display: none; }
            .db-kids-cell { max-width: 100px; font-size: 0.68rem; }
        }

        /* Landscape phone ‚Äî restore all columns */
        @media (max-width: 812px) and (orientation: landscape) {
            .db-table td.name-cell { max-width: 120px; font-size: 0.75rem; }
            .db-table td.badge-cell,
            .db-table th:nth-child(3) { display: table-cell; }
        }
        
        /* Single-column stacked layout for admin sections */
        .admin-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 12px 0;
        }
        .admin-grid .admin-section { margin: 0; }
        .admin-section.full-width  { width: 100%; }
        .section-icon { font-size: 1rem; }

        @media (max-width: 768px) {
            .admin-section { padding: 10px 12px 8px; margin: 8px 0; }
            .admin-section h2 { font-size: 0.9rem; }
            .admin-section .db-table-wrap,
            .admin-section .admin-scroll { max-height: 260px; }
        }

        /* Schedule table ‚Äî same visual language as db-table */
        .sched-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .sched-table thead th {
            background: #f0f6ff;
            color: #5580aa;
            font-weight: 600;
            font-size: 0.72rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            padding: 7px 10px;
            border-bottom: 2px solid #deeaff;
            text-align: left;
            white-space: nowrap;
            position: sticky; top: 0; z-index: 1;
        }
        .sched-table tbody tr { border-bottom: 1px solid #eef3ff; transition: background 0.12s; }
        .sched-table tbody tr:last-child { border-bottom: none; }
        .sched-table tbody tr:hover { background: #f7fbff; }
        .sched-table td { padding: 7px 10px; vertical-align: middle; font-size: 0.82rem; }
        .sched-table td.date-cell { font-weight: 700; color: var(--text); white-space: nowrap; min-width: 90px; }
        .sched-table td.vol-cell { min-width: 130px; }
        .sched-table td.sup-cell { min-width: 150px; }
        .sched-table .vol-name { font-weight: 600; font-size: 0.82rem; }
        .sched-table .vol-phone { font-size: 0.74rem; color: #888; }
        .sched-table .slot-empty { color: #ccc; font-size: 0.78rem; font-style: italic; }
        .sched-table .status-pill {
            display: inline-block; padding: 2px 7px; border-radius: 8px;
            font-size: 0.68rem; font-weight: 600; margin-top: 3px;
        }
        .sched-table .status-full  { background: #e8f5e9; color: #2e7d32; }
        .sched-table .status-open  { background: #fff3e0; color: #e65100; }
        .sched-table .status-part  { background: #e3f2fd; color: #1565c0; }
        .sched-table select.sched-select {
            font-size: 0.75rem; padding: 3px 5px; border: 1.5px solid #d1e3ff;
            border-radius: 6px; width: 100%; color: var(--text); background: #fff;
            margin-bottom: 4px;
        }
        .sched-table select.sched-select:focus { outline: none; border-color: var(--primary); }
        .sched-add-form { padding: 10px 14px; background: #f8fbff; border-top: 1px solid #eef3ff; }
        .sched-add-form label { font-size: 0.82rem; margin-right: 10px; }
        .sched-add-form input { font-size: 0.82rem; padding: 5px 8px; border: 1.5px solid #d1e3ff; border-radius: 6px; }

        /* Keep old admin-table as fallback (won't be used) */
        .admin-table { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            padding: 0;
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-edit:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 8px 12px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-width: 70px;
            height: auto;
            font-size: 0.7rem;
            line-height: 1.2;
            white-space: nowrap;
        }

        .btn-delete:hover {
            background: #dc2626;
            color: white;
            transform: scale(1.05);
        }
        
        .btn-delete .icon {
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .btn-delete .text {
            font-size: 0.65rem;
            line-height: 1.1;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .btn-delete {
                padding: 6px 8px;
                min-width: 60px;
                font-size: 0.65rem;
                gap: 1px;
            }
            
            .btn-delete .icon {
                font-size: 1rem;
            }
            
            .btn-delete .text {
                font-size: 0.55rem;
            }
        }
        
        @media (max-width: 480px) {
            .btn-delete {
                padding: 5px 6px;
                min-width: 55px;
                font-size: 0.6rem;
            }
            
            .btn-delete .icon {
                font-size: 0.9rem;
            }
            
            .btn-delete .text {
                font-size: 0.5rem;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .editable-field {
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-block;
            min-width: 100px;
        }

        .editable-field:hover {
            background: #e3f2fd;
        }

        .edit-input {
            padding: 6px 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 1rem;
            width: 150px;
        }

        /* ‚îÄ‚îÄ Password / PIN numpad ‚îÄ‚îÄ */
        /*
         * Responsive sizing strategy:
         *   Mobile portrait  : card ‚â§ 320px  ‚Üí btn ‚â§ 72px
         *   Mobile landscape : card ‚â§ 260px  ‚Üí btn ‚â§ 58px  (height-constrained)
         *   Tablet portrait  : card ‚â§ 380px  ‚Üí btn ‚â§ 88px
         *   Tablet landscape : card ‚â§ 360px  ‚Üí btn ‚â§ 84px
         *   Desktop          : card ‚â§ 420px  ‚Üí btn ‚â§ 96px
         */
        :root {
            /* ‚îÄ‚îÄ Phone portrait defaults ‚îÄ‚îÄ */
            --pw-gap: 8px;
            --pw-card-inner: min(320px, calc(100vw - 32px));
            --pw-numpad-inner: calc(var(--pw-card-inner) - 24px);
            --pw-btn: min(72px, calc((var(--pw-numpad-inner) - 2 * var(--pw-gap)) / 3));
        }

        /* Phone landscape ‚Äî shrink to prevent vertical overflow */
        @media (orientation: landscape) and (max-width: 900px) {
            :root {
                --pw-gap: 6px;
                --pw-card-inner: min(260px, calc(100vw - 32px));
                --pw-numpad-inner: calc(var(--pw-card-inner) - 20px);
                --pw-btn: min(58px, calc((var(--pw-numpad-inner) - 2 * var(--pw-gap)) / 3));
            }
        }

        /* Tablet portrait */
        @media (min-width: 768px) and (orientation: portrait) {
            :root {
                --pw-gap: 10px;
                --pw-card-inner: min(380px, calc(100vw - 48px));
                --pw-numpad-inner: calc(var(--pw-card-inner) - 28px);
                --pw-btn: min(88px, calc((var(--pw-numpad-inner) - 2 * var(--pw-gap)) / 3));
            }
        }

        /* Tablet landscape */
        @media (min-width: 768px) and (orientation: landscape) and (min-height: 600px) {
            :root {
                --pw-gap: 10px;
                --pw-card-inner: min(360px, calc(100vw - 48px));
                --pw-numpad-inner: calc(var(--pw-card-inner) - 28px);
                --pw-btn: min(84px, calc((var(--pw-numpad-inner) - 2 * var(--pw-gap)) / 3));
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            :root {
                --pw-gap: 12px;
                --pw-card-inner: min(420px, calc(100vw - 48px));
                --pw-numpad-inner: calc(var(--pw-card-inner) - 32px);
                --pw-btn: min(96px, calc((var(--pw-numpad-inner) - 2 * var(--pw-gap)) / 3));
            }
        }

        /* Password modal ‚Äî fixed size, never scrolls, never resizes */
        #admin-password-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        #admin-password-modal:not(.hidden) {
            display: flex;
        }

        #password-content,
        .password-content {
            background: #f8faff;
            border-radius: 20px;
            padding: 20px;
            width: calc(var(--pw-card-inner) + 40px);
            max-width: min(calc(100vw - 32px), calc(100dvw - 32px));
            /* Prevent vertical overflow in landscape ‚Äî allow internal scroll if needed */
            max-height: calc(100dvh - 32px);
            overflow-y: auto;
            overscroll-behavior: contain;
            text-align: center;
            box-shadow: 0 16px 50px rgba(0,0,0,0.22);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #password-content h2 {
            margin: 0;
            color: var(--text);
            font-size: clamp(1rem, 2.5vh, 1.3rem);
            white-space: nowrap;
        }

        /* Pin display ‚Äî always same height whether empty or filled */
        #pin-display,
        .pin-display-fixed {
            font-size: clamp(1.2rem, calc(var(--pw-btn, 60px) * 0.38), 2rem);
            font-weight: 300;
            text-align: center;
            padding: 10px 12px;
            background: #eef2f9;
            border: 2px solid #d0daea;
            border-radius: 12px;
            margin: 0;
            letter-spacing: clamp(8px, 2vw, 20px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            height: clamp(40px, calc(var(--pw-btn, 60px) * 0.7), 68px);
            min-height: clamp(40px, calc(var(--pw-btn, 60px) * 0.7), 68px);
            max-height: clamp(40px, calc(var(--pw-btn, 60px) * 0.7), 68px);
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* The numpad grid ‚Äî fixed column/row sizes, no stretching */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, var(--pw-btn));
            grid-template-rows: repeat(4, var(--pw-btn));
            gap: var(--pw-gap);
            align-items: center;
            justify-items: center;
            background: #eef2f9;
            border-radius: 16px;
            padding: 12px;
            box-sizing: border-box;
            margin: 0 auto;
            /* Lock the numpad to its exact computed size ‚Äî never changes based on content */
            width: calc(3 * var(--pw-btn) + 2 * var(--pw-gap) + 24px);
            max-width: 100%;
            flex-shrink: 0;
        }

        /* Number buttons ‚Äî white circles */
        .numpad .numpad-btn {
            width: var(--pw-btn);
            height: var(--pw-btn);
            min-width: 44px;
            min-height: 44px !important;
            aspect-ratio: 1 / 1;
            font-size: clamp(0.9rem, calc(var(--pw-btn) * 0.28), 1.6rem);
            font-weight: 500;
            border: 1.5px solid #d0daea;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            color: #2c3e50;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            user-select: none;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .numpad .numpad-btn:active {
            background: #ddeeff;
            transform: scale(0.91);
            -webkit-tap-highlight-color: transparent;
            color: var(--primary);
        }
        .numpad .numpad-btn:focus { outline: none; }
        .numpad .numpad-btn:focus:not(:active) { background: #ffffff; }

        @media (hover: hover) {
            .numpad .numpad-btn:hover {
                background: #f0f5ff;
                border-color: #a8c4e8;
            }
        }

        /* ‚å´ and CLR buttons ‚Äî red tinted circles, same size */
        .numpad .numpad-btn.small-btn {
            font-size: clamp(0.7rem, calc(var(--pw-btn) * 0.22), 1rem);
            font-weight: 700;
            background: #fff0f0;
            color: #c0392b;
            border-color: #f5c6c6;
        }

        @media (hover: hover) {
            .numpad .numpad-btn.small-btn:hover {
                background: #ffe0e0;
                border-color: #f0a0a0;
            }
        }

        .numpad .numpad-btn.small-btn:active {
            background: #ffcccc;
            transform: scale(0.91);
            -webkit-tap-highlight-color: transparent;
        }

        /* Cancel/Back buttons row inside any password-content card ‚Äî
           must stay within the card width, no margin overflow */
        #password-content > div:last-child {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 0;
        }

        #password-content > div:last-child button {
            margin: 0;
            flex: 1;
            min-width: 80px;
            max-width: 140px;
        }

        /* Centered alert modal */
        .centered-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .centered-modal:not(.hidden) {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .centered-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .centered-modal-content h3 {
            margin-top: 0;
            color: var(--text);
        }
        
        @media (max-width: 768px) {
            .centered-modal:not(.hidden) {
                align-items: flex-start;
                padding: 10px;
            }
            
            .centered-modal-content {
                padding: 24px 20px;
                margin-top: 20px;
            }
        }

        /* Login Screen Styles */
        #login-screen {
            max-width: 450px;
            margin: 100px auto;
        }

        #login-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .login-form {
            margin: 30px auto;
            max-width: 400px;
            width: 100%;
        }

        #church-code-field {
            margin: 0;
        }

        #church-code-field label {
            display: block;
            margin: 20px 0 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin: 20px 0 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            text-align: left;
        }

        .login-form input[type="email"],
        .login-form input[type="password"],
        .login-form input[type="text"] {
            width: 100% !important;
            max-width: 100% !important;
            padding: 14px 16px;
            border: 2px solid #d1e3ff;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            margin: 0;
            /* Critical for iOS PWA keyboard to appear */
            -webkit-user-select: text;
            user-select: text;
            pointer-events: auto !important;
            touch-action: auto !important;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 28px;
            transition: all 0.2s;
        }

        .btn-login:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }

        .login-toggle {
            text-align: center;
            margin-top: 24px;
            color: #666;
            font-size: 0.95rem;
        }

        .login-toggle a {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .user-info {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: flex-end;
            padding: 10px 20px;
            pointer-events: none;
        }

        .user-info.main-screen-visible {
            display: flex;
        }

        .profile-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 50px;
            padding: 8px 16px 8px 8px;
            box-shadow: 0 4px 16px rgba(74, 144, 226, 0.18);
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
            border: 1.5px solid #d1e3ff;
        }

        .profile-pill:hover {
            box-shadow: 0 6px 22px rgba(74, 144, 226, 0.28);
            transform: translateY(-1px);
        }

        .profile-avatar {
            width: 34px;
            height: 34px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .profile-name-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profile-chevron {
            font-size: 0.65rem;
            color: #999;
            margin-left: 2px;
        }

        /* Old circle hidden ‚Äî using pill now */
        .profile-circle {
            display: none;
        }

        .profile-dropdown {
            position: absolute;
            top: 56px;
            right: 0;
            background: white;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(74,144,226,0.18);
            min-width: 240px;
            display: none;
            border: 1.5px solid #d1e3ff;
            pointer-events: auto;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown strong {
            color: var(--primary);
            display: block;
            margin-bottom: 12px;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        .loading-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success-message {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        /* Cloud sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }

        /* ‚îÄ‚îÄ Phone Numpad Overlay ‚îÄ‚îÄ */
        .numpad-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            padding: clamp(8px, 2vmin, 16px);
            overflow: auto;
            overscroll-behavior: contain;
        }

        .numpad-overlay.show {
            display: flex;
        }

        .numpad-container {
            background: linear-gradient(160deg, #1e2340 0%, #2d235a 55%, #1e1d44 100%);
            border-radius: 24px;
            padding: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.07);
            box-sizing: border-box;
            overflow: hidden;
            display: inline-flex;
            flex-direction: column;
            gap: 10px;
            /* Responsive container: never wider than the computed grid, never overflows screen */
            width: calc(3 * var(--np-btn) + 2 * var(--np-gap) + 32px);
            max-width: min(var(--np-container-max), calc(100vw - 32px));
            /* Vertical safety: in landscape the keypad must not overflow the viewport */
            max-height: calc(100dvh - 32px);
        }

        .numpad-label {
            color: rgba(255,255,255,0.6);
            font-size: clamp(0.65rem, calc(var(--np-btn) * 0.12), 0.8rem);
            text-align: center;
            margin: 0;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .numpad-display {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: clamp(0.95rem, calc(var(--np-btn) * 0.28), 1.5rem);
            text-align: center;
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-weight: 500;
            letter-spacing: 2px;
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            /* Display stretches to fill grid width */
            width: 100%;
            /* Height mirrors button size for visual balance */
            min-height: clamp(40px, calc(var(--np-btn) * 0.7), 56px);
            flex-shrink: 0;
        }

        /*
         * Phone-number numpad responsive button sizing:
         *   Phone portrait   : btn ‚â§ 72px  (default)
         *   Phone landscape  : btn ‚â§ 56px  (height-constrained ‚Äî fits 4 rows + display)
         *   Tablet portrait  : btn ‚â§ 88px
         *   Tablet landscape : btn ‚â§ 84px
         *   Desktop          : btn ‚â§ 100px
         *
         * Formula: fill exactly 3 columns inside the overlay padding (40px each side ‚Üí 80px total).
         * Gap scales proportionally so everything breathes at every size.
         */
        :root {
            /* Phone portrait defaults */
            --np-btn: min(72px, calc((100vw - 80px) / 3));
            --np-gap: min(10px, calc((100vw - 80px) / 30));
            --np-container-max: 320px;
        }

        /* Phone landscape ‚Äì shrink aggressively so nothing overflows vertically */
        @media (orientation: landscape) and (max-width: 900px) {
            :root {
                --np-btn: min(56px, calc((100vh - 100px) / 4));
                --np-gap: min(7px, calc((100vh - 100px) / 60));
                --np-container-max: 280px;
            }
        }

        /* Tablet portrait */
        @media (min-width: 768px) and (orientation: portrait) {
            :root {
                --np-btn: min(88px, calc((100vw - 120px) / 4));
                --np-gap: 12px;
                --np-container-max: 380px;
            }
        }

        /* Tablet landscape (full tablet, not phone landscape) */
        @media (min-width: 768px) and (orientation: landscape) and (min-height: 600px) {
            :root {
                --np-btn: min(84px, calc((100vh - 120px) / 5));
                --np-gap: 11px;
                --np-container-max: 360px;
            }
        }

        /* Desktop & large screens */
        @media (min-width: 1024px) {
            :root {
                --np-btn: min(100px, calc((100vw - 200px) / 6));
                --np-gap: 14px;
                --np-container-max: 440px;
            }
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, var(--np-btn));
            grid-template-rows: repeat(4, var(--np-btn));
            gap: var(--np-gap);
            /* Lock grid to exact computed size ‚Äî never stretches, never overflows */
            width: calc(3 * var(--np-btn) + 2 * var(--np-gap));
            align-items: center;
            justify-items: center;
            flex-shrink: 0;
        }

        .numpad-btn {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.28);
            border-radius: 50%;
            font-size: clamp(0.9rem, calc(var(--np-btn) * 0.28), 1.5rem);
            font-weight: 500;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            user-select: none;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--np-btn);
            height: var(--np-btn);
            min-width: 44px;
            min-height: 44px !important;
            padding: 0;
            box-sizing: border-box;
        }

        .numpad-btn:hover { background: rgba(255, 255, 255, 0.26); }
        .numpad-btn:active {
            background: rgba(74, 144, 226, 0.7);
            transform: scale(0.91);
            -webkit-tap-highlight-color: transparent;
        }
        .numpad-btn:focus { outline: none; }
        .numpad-btn:focus:not(:active) { background: rgba(255, 255, 255, 0.15); }

        .numpad-backspace {
            background: rgba(220, 60, 60, 0.6);
            color: #ffffff;
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 50%;
            font-size: clamp(1rem, calc(var(--np-btn) * 0.35), 1.5rem);
            font-weight: 400;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            touch-action: manipulation;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--np-btn);
            height: var(--np-btn);
            min-width: 44px;
            min-height: 44px !important;
            padding: 0;
            box-sizing: border-box;
        }
        .numpad-backspace:hover { background: rgba(220, 60, 60, 0.8); }
        .numpad-backspace:active {
            background: rgba(220, 60, 60, 1);
            transform: scale(0.91);
            -webkit-tap-highlight-color: transparent;
        }

        .numpad-ok {
            background: rgba(50, 180, 100, 0.65);
            color: #ffffff;
            border: 1px solid rgba(80, 220, 130, 0.5);
            border-radius: 50%;
            font-size: clamp(0.75rem, calc(var(--np-btn) * 0.22), 1.1rem);
            font-weight: 700;
            cursor: pointer;
            transition: background 0.1s, transform 0.1s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--np-btn);
            height: var(--np-btn);
            min-width: 44px;
            min-height: 44px !important;
            padding: 0;
            box-sizing: border-box;
        }
        .numpad-ok:hover { background: rgba(50, 180, 100, 0.85); }
        .numpad-ok:active {
            background: rgba(50, 180, 100, 1);
            transform: scale(0.91);
            -webkit-tap-highlight-color: transparent;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #50c878;
            transition: background 0.3s;
        }

        .sync-dot.syncing {
            background: #ffaa33;
            animation: pulse 1s infinite;
        }

        .sync-dot.offline {
            background: #ef4444;
            animation: pulse 1s infinite;
        }

        .sync-dot.pending {
            background: #f97316;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========================================
           MOBILE & TABLET OPTIMIZATIONS
           Optimized for both landscape and portrait
           ======================================== */
        
        /* Universal mobile improvements */
        * {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        /* Touch-friendly minimum sizes for all interactive elements */
        button, a, input, select, .clickable, .kid-card, .btn-icon {
            min-height: 44px; /* Apple's recommended touch target */
        }

        /* Prevent text selection on interactive elements */
        button, .numpad .numpad-btn, .kid-card {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Better scrolling everywhere */
        .table-container, .modal-overlay, .modal-content, .card {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Better touch feedback */
        button:active, .kid-card:active, .numpad .numpad-btn:active {
            opacity: 0.9;
            -webkit-tap-highlight-color: transparent;
        }

        /* TABLET (iPad & larger tablets) */
        @media (max-width: 1024px) {
            body {
                padding: 12px;
            }
            
            h1 {
                font-size: clamp(1.6rem, 4vw, 2rem);
            }
            
            h2 {
                font-size: clamp(1.3rem, 3.5vw, 1.7rem);
            }
            
            .card {
                padding: 20px;
            }
            
            .main-buttons button {
                font-size: 1.3rem;
                padding: 20px 40px;
                max-width: 100%;
            }
            
            /* Forms - prevent iOS zoom */
            input[type="text"],
            input[type="tel"],
            input[type="number"],
            input[type="password"],
            input[type="email"],
            select {
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px;
            }
            
            /* Modal adjustments */
            .modal-content,
            .centered-modal-content {
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Admin grid for tablets */
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            /* Stats responsive */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-number {
                font-size: 2.2rem;
            }
            
            /* Numpad for tablets ‚Äî sizing now fully handled by --np-btn / --pw-btn CSS variables */
        }
        
        /* MOBILE PHONES (portrait and landscape) */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .card {
                padding: 16px;
                border-radius: 16px;
                margin: 12px 0;
            }
            
            h1, h2 {
                font-size: clamp(1.3rem, 5vw, 1.6rem);
                margin-bottom: 0.5em;
            }
            
            h3 {
                font-size: clamp(1.1rem, 4vw, 1.3rem);
            }
            
            /* Main buttons mobile */
            .main-buttons {
                margin: 25px 0 20px;
                gap: 14px;
            }
            
            .main-buttons button {
                padding: 16px 32px;
                font-size: clamp(1.1rem, 3vw, 1.3rem);
                border-radius: 16px;
            }
            
            /* Standard buttons mobile */
            button:not(.main-buttons button, .numpad-btn, .db-btn) {
                font-size: 1rem;
                padding: 11px 22px;
                margin: 8px 4px;
            }
            
            .btn-sm {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            /* Make table buttons extra small on mobile */
            table .btn-sm,
            table button {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            /* Forms mobile - CRITICAL for iOS */
            input[type="tel"],
            input[type="text"],
            input[type="password"],
            input[type="email"],
            input[type="number"],
            select {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 12px 14px;
                -webkit-appearance: none;
                /* Ensure inputs work in PWA mode */
                pointer-events: auto !important;
                touch-action: auto !important;
                -webkit-user-select: text;
                user-select: text;
            }
            
            /* Password numpad handled by --pw-btn CSS variable */
            /* Phone numpad sizing handled by --np-btn CSS variable */
            
            /* Tables mobile - horizontal scroll */
            .table-container {
                overflow-x: auto;
                margin: 15px -8px; /* Extend to edges */
            }
            
            table {
                font-size: 0.85rem;
                min-width: 600px; /* Force horizontal scroll */
            }
            
            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            .admin-table th {
                font-size: 0.75rem;
                padding: 7px 5px;
            }
            
            .admin-table td {
                padding: 7px 5px;
                font-size: 0.85rem;
            }
            
            /* Kids grid mobile */
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 10px;
                margin: 15px 0;
            }
            
            .kid-card {
                padding: 12px;
                border-radius: 10px;
            }
            
            .kid-card h3 {
                font-size: 1rem;
                margin: 6px 0;
            }
            
            .kid-card p {
                font-size: 0.85rem;
            }
            
            /* Modals mobile */
            #confirm-content,
            .success-content,
            .centered-modal-content {
                padding: 22px;
                width: 92%;
                max-width: 92vw;
            }
            
            #confirm-content h3,
            .success-content h2 {
                font-size: 1.25rem;
            }
            
            #confirm-content .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            #confirm-content button {
                width: 100%;
                margin: 0;
            }
            
            .success-icon {
                font-size: 3.5rem;
            }
            
            /* Login screen mobile */
            #login-screen {
                margin: 25px auto;
                padding: 0 8px;
                max-width: 100%;
            }
            
            #login-screen h1 {
                font-size: 1.9rem;
                margin-bottom: 8px;
            }
            
            .login-form input {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 13px;
            }
            
            .btn-login {
                padding: 15px;
                font-size: 1.1rem;
                margin-top: 32px;
            }

            .login-form {
                padding-bottom: 20px;
            }
            
            /* User profile mobile */
            .user-info {
                top: 8px;
                right: 8px;
            }
            
            .profile-circle {
                width: 42px;
                height: 42px;
                font-size: 1.1rem;
            }
            
            .profile-dropdown {
                top: 54px;
                min-width: 190px;
                font-size: 0.9rem;
                padding: 12px 16px;
            }
            
            .profile-dropdown button {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
            
            /* Sync indicator mobile */
            .sync-indicator {
                bottom: 8px;
                right: 8px;
                padding: 7px 11px;
                font-size: 0.8rem;
            }
            
            .sync-dot {
                width: 7px;
                height: 7px;
            }
            
            /* Admin sections mobile */
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .admin-section {
                padding: 14px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            /* Action buttons mobile */
            .action-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .btn-icon {
                width: 36px;
                height: 36px;
                font-size: 1.05rem;
            }
        }
        
        /* LANDSCAPE mode optimizations (phones in landscape) */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 5px;
            }
            
            .card {
                padding: 10px;
                margin: 8px 0;
            }
            
            h1, h2 {
                font-size: 1.3rem;
                margin-bottom: 0.3em;
            }
            
            .main-buttons {
                margin: 12px 0 8px;
                gap: 10px;
            }
            
            .main-buttons button {
                padding: 12px 28px;
                font-size: 1.1rem;
            }
            
            #login-screen {
                margin: 15px auto;
            }
            
            #login-screen h1 {
                font-size: 1.5rem;
            }
            
            .login-form input {
                padding: 10px;
            }
            
            /* numpad layout fully handled by --np-btn / --pw-btn CSS variables */
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
            
            .kid-card {
                padding: 8px;
            }
        }
        
        /* SMALL PHONES (iPhone SE, etc) */
        @media (max-width: 375px) {
            body {
                padding: 6px;
            }
            
            .card {
                padding: 12px;
                margin: 10px 0;
            }
            
            h1, h2 {
                font-size: 1.3rem;
            }
            
            .main-buttons button {
                padding: 14px 24px;
                font-size: 1.1rem;
            }
            
            /* small phone numpad handled by clamp */
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
                gap: 8px;
            }
            
            table {
                font-size: 0.75rem;
                min-width: 500px;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 0.95rem;
            }
        }
        
        /* TABLET LANDSCAPE (iPad in landscape, etc) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            }
            
            /* numpad handled by --pw-btn */
        }
        
        /* TABLET PORTRAIT (iPad in portrait) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kids-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
        
        /* iOS SAFE AREA support (iPhone X and newer) */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: max(8px, env(safe-area-inset-top));
                padding-bottom: max(8px, env(safe-area-inset-bottom));
                padding-left: max(8px, env(safe-area-inset-left));
                padding-right: max(8px, env(safe-area-inset-right));
            }
            
            .user-info {
                top: max(8px, env(safe-area-inset-top));
                right: max(8px, env(safe-area-inset-right));
            }
            
            .sync-indicator {
                bottom: max(8px, env(safe-area-inset-bottom));
                right: max(8px, env(safe-area-inset-right));
            }
        }
        
        /* ‚îÄ‚îÄ Parental Contract Modal ‚îÄ‚îÄ */
        .contract-modal-inner {
            background: white;
            border-radius: 24px;
            padding: 32px 28px;
            width: 520px;
            max-width: 96vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 60px rgba(0,0,0,0.28);
            box-sizing: border-box;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 480px) {
            .contract-modal-inner {
                padding: 20px 16px;
                border-radius: 18px;
                max-height: 92vh;
            }

            .contract-modal-inner ol {
                padding-left: 16px;
            }

            .contract-modal-inner h2 {
                font-size: 1.2rem !important;
            }

            #contract-submit-btn {
                padding: 13px 20px !important;
                font-size: 0.95rem !important;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .contract-modal-inner {
                padding: 14px 16px;
                max-height: 88vh;
                border-radius: 16px;
            }
        }

        /* Fix 7: Prevent db-table from inheriting global table rules */
        .db-table {
            border-spacing: 0;
            border-collapse: collapse;
        }
        /* Prevent global td { background: white; border-radius: 12px; padding: 8px } from bleeding in */
        .db-table td, .db-table th {
            background: transparent;
            border-radius: 0;
        }

        /* Fix 8: Login screen top margin ‚Äî tablet portrait gets excessive gap */
        @media (min-width: 769px) and (max-width: 1024px) {
            #login-screen {
                margin: 40px auto;
            }
        }

        /* ‚îÄ‚îÄ Body scroll lock (applied when any modal is open) ‚îÄ‚îÄ */
        body.modal-open {
            overflow: hidden;
            /* iOS Safari: prevent momentum scrolling of background */
            position: fixed;
            width: 100%;
        }

        /* ‚îÄ‚îÄ End responsive fixes ‚îÄ‚îÄ */
        @media (hover: none) and (pointer: coarse) {
            .numpad .numpad-btn:hover,
            .main-buttons button:hover,
            .btn-icon:hover,
            .kid-card:hover,
            button:hover {
                transform: none;
            }
            
            /* Keep active state working - don't disable it! */
            .numpad .numpad-btn:active,
            button:active {
                opacity: 0.8;
            }
        }
    </style>
</head>

<body>
    <!-- Custom Numpad Overlay -->
    <div class="numpad-overlay" id="numpad-overlay">
        <div class="numpad-container">
            <p class="numpad-label">Phone Number</p>
            <div class="numpad-display" id="numpad-display">(000) 000-0000</div>
            <div class="numpad-grid">
                <button class="numpad-btn" onclick="numpadPress('1')">1</button>
                <button class="numpad-btn" onclick="numpadPress('2')">2</button>
                <button class="numpad-btn" onclick="numpadPress('3')">3</button>
                <button class="numpad-btn" onclick="numpadPress('4')">4</button>
                <button class="numpad-btn" onclick="numpadPress('5')">5</button>
                <button class="numpad-btn" onclick="numpadPress('6')">6</button>
                <button class="numpad-btn" onclick="numpadPress('7')">7</button>
                <button class="numpad-btn" onclick="numpadPress('8')">8</button>
                <button class="numpad-btn" onclick="numpadPress('9')">9</button>
                <button class="numpad-backspace" onclick="numpadBackspace()">‚å´</button>
                <button class="numpad-btn" onclick="numpadPress('0')">0</button>
                <button class="numpad-ok" onclick="numpadOK()">OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Login/Signup Screen -->
        <div id="login-screen" class="card">
            <h1>‚òÅÔ∏è Bible Land Check-In</h1>
            
            <div id="login-error" class="error-message hidden"></div>
            <div id="login-success" class="success-message hidden"></div>
            
            <div class="login-form">
                <label>Email</label>
                <input type="email" id="auth-email" placeholder="your@email.com" autocomplete="email" inputmode="email">
                
                <label>Password</label>
                <input type="password" id="auth-password" placeholder="Enter password (min 6 characters)" autocomplete="current-password">
                
                <div id="church-code-field" class="hidden">
                    <label>Church Code (required for signup)</label>
                    <input type="text" id="church-code" placeholder="Enter church code" inputmode="text">
                </div>
                
                <button class="btn-login" id="btn-login" type="button" onclick="handleLogin()">Sign In</button>
            </div>
            
            <div class="login-toggle">
                <span id="toggle-text">Don't have an account? </span>
                <a onclick="toggleAuthMode()" id="toggle-link">Create one</a>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="card hidden">
            <div class="loading-screen">
                <div class="spinner"></div>
                <p style="font-size: 1.2rem; color: var(--primary);">Loading your data from the cloud...</p>
            </div>
        </div>

        <!-- Service Selection Screen (shown after login if no service selected) -->
        <div id="service-selection-screen" class="card hidden">
            <h1>Select Your Service</h1>
            <p style="text-align: center; color: #666; margin-bottom: 40px;">Choose which service you'll be checking in for today</p>
            <div class="main-buttons">
                <button style="background: #ff6b6b; font-size: 1.4rem;" onclick="selectService('russian')">
                    üá∑üá∫ Russian Service<br>
                    <span style="font-size: 0.9rem; opacity: 0.9;">9:00 AM</span>
                </button>
                <button style="background: #4a90e2; font-size: 1.4rem;" onclick="selectService('english')">
                    üá∫üá∏ English Service<br>
                    <span style="font-size: 0.9rem; opacity: 0.9;">12:00 PM</span>
                </button>
            </div>
        </div>

        <!-- Main App Container (shown after login) -->
        <div id="main-app-container" class="hidden">
            <!-- User Info Display ‚Äî only visible on main screen -->
            <div class="user-info" id="user-info-bar">
                <div style="position: relative;">
                    <div class="profile-pill" onclick="toggleProfileDropdown()">
                        <div class="profile-avatar">
                            <span id="user-initial">U</span>
                        </div>
                        <span class="profile-name-text" id="user-email-display-short">Account</span>
                        <span class="profile-chevron">‚ñº</span>
                    </div>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <strong id="user-email-display"></strong>
                        <div style="margin: 10px 0; padding: 8px; background: #f0f7ff; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">Current Service:</div>
                            <div id="profile-service-display" style="font-weight: 600; color: #1976d2; font-size: 0.9rem;">Loading...</div>
                            <button onclick="showServiceSwitchModal(); toggleProfileDropdown();" 
                                    style="margin-top: 8px; padding: 6px 12px; font-size: 0.8rem; background: #4a90e2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Switch Service
                            </button>
                        </div>
                        <a id="change-pin-link" href="#" onclick="event.preventDefault(); requestCurrentPasswordForChange(); toggleProfileDropdown();" 
                           style="font-size: 0.85rem; color: #4a90e2; text-decoration: none; display: none; margin: 8px 0; padding: 4px 0;">
                            Change Admin Password
                        </a>
                        <button class="btn-primary" onclick="showAdminPasswordModal(); toggleProfileDropdown();" style="width: 100%; margin-bottom: 8px;">Admin</button>
                        <button class="btn-logout" onclick="handleLogout()">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Sync Indicator -->
            <div class="sync-indicator">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-text">Synced</span>
            </div>

        <!-- MAIN MENU -->
        <div id="main-screen" class="card">
            <h1>Bible Land Check-In </h1>
            <div style="text-align: center; margin: -10px 0 10px 0;">
                <span id="current-service-display" style="display: inline-block; background: #e3f2fd; color: #1976d2; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1rem;">
                    <!-- Service will be displayed here -->
                </span>
            </div>
            <div class="datetime-display">
                <div class="current-date" id="current-date">February 5, 2026</div>
                <div class="current-time" id="current-time">22:01:39</div>
                <div class="day-name" id="day-name">Thursday</div>
            </div>
            <div class="main-buttons">
                <button id="btn-checkin" onclick="showMembership()">Check In Child(ren)</button>
                <button id="btn-view" onclick="showViewCheckInsPasswordModal()">View Current Check-Ins</button>
                <button id="btn-schedule" onclick="showScheduleView()">View Schedule</button>
            </div>
        </div>
        <!-- Membership -->
        <div id="membership-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Are you a member? üë™</h1>
            <div class="membership-buttons">
                <button class="btn-primary" onclick="selectMembership(&#39;member&#39;)">Yes, Member</button>
                <button class="btn-outline" onclick="selectMembership(&#39;non-member&#39;)">No, Non-Member</button>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-outline" onclick="backToMain()">‚Üê Back</button>
            </div>
        </div>
        <!-- Non-member phone entry -->
        <div id="nonmem-phone-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Parent Phone Number</h1>
            <p style="text-align:center; color:#555;">Enter phone to load existing family info or add new</p>
            <label>Phone: <input type="tel" id="nonmem-phone" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this); onNonMemberPhoneInput()"></label><br><br>
            <button class="btn-primary" id="continue-nonmember">Continue</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer phone first -->
        <div id="volunteer-phone-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Volunteer Sign-Up</h1>
            <h2>Step 1: Your Phone Number</h2>
            <label>Phone: <input type="tel" id="vol-phone-first" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this); onVolunteerPhoneInput()"></label><br><br>
            <button class="btn-primary" id="continue-member">Continue</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer name -->
        <div id="volunteer-form" class="volunteer-form hidden" style="position: relative;">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h2>Step 2: Your Name</h2>
            <label>First Name: <input type="text" id="vol-first" placeholder="First name"></label><br>
            <label>Last Name: <input type="text" id="vol-last" placeholder="Last name"></label><br><br>
            <button class="btn-success" onclick="showVolunteerScheduleAfterName()">Continue to Schedule</button>
            <button class="btn-outline" onclick="backToMain()">Cancel</button>
        </div>
        <!-- Volunteer schedule -->
        <div id="volunteer-screen" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Volunteer Schedule</h1>
            <div id="volunteer-schedule">
                <h2>Upcoming Sundays (2 spots each)</h2>
                <div id="schedule-list" class="schedule-list"></div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-outline" onclick="skipVolunteerSchedule()">Skip</button>
            </div>
        </div>
        <!-- Buzzer selection -->
        <div id="buzzer-screen" class="card hidden" style="overflow-x: hidden;">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Choose Buzzer Number üîî</h1>
            <p style="text-align:center; color:#555;">Green = available ¬∑ Red = in use</p>
            <div id="buzzer-grid"></div>
            <div style="text-align:center; margin-top:30px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                <button class="btn-outline" onclick="backFromBuzzerToInfo()">‚Üê Back to Info</button>
                <button class="btn-outline" onclick="backToMain()">Cancel</button>
            </div>
        </div>
        <!-- Parent + children info -->
        <div id="info-form" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Parent &amp; Children üòä</h1>
            <label>Phone: <input type="tel" id="phone" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this); onPhoneInput()"></label><br>
            <label>First name: <input type="text" id="firstName" placeholder="Parent first name"></label><br>
            <label>Last name: <input type="text" id="lastName" placeholder="Parent last name"></label><br>
            <h2>Children</h2>
            <div id="children-list"></div>
            <button class="btn-primary" onclick="addChildEntry()">+ Add child</button>
            <div style="margin-top:40px; text-align:center;">
                <button class="btn-success" onclick="finishCheckIn()">Check In Now</button>
                <button class="btn-outline" onclick="backToMain()">Cancel</button>
            </div>
        </div>
        <!-- Success modal -->
        <div id="success-modal" class="checkin-success-modal hidden">
            <div class="success-content">
                            <h2>Success! üéâ</h2>
                <p id="success-text"></p>
                <button class="btn-success" onclick="document.getElementById('success-modal').classList.add('hidden'); backToMain();">OK</button>
            </div>
        </div>
        <!-- View current check-ins -->
        <div id="view-checkins" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <h1>Currently Checked In üéâ</h1>
            
            <!-- Service Filter -->
            <div style="text-align: center; margin: 15px 0;">
                <label style="font-weight: 600; margin-right: 10px;">Filter by Service:</label>
                <select id="checkin-service-filter" onchange="renderCheckInTable()" 
                        style="padding: 8px 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                    <option value="all">All Services</option>
                    <option value="russian">üá∑üá∫ Russian (9 AM)</option>
                    <option value="english">üá∫üá∏ English (12 PM)</option>
                </select>
            </div>
            
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 20px 0;">
            <table id="checkin-table">
                <thead>
                    <tr>
                        <th>Buzzer</th>
                        <th>Child</th>
                        <th>Age</th>
                        <th>Allergies</th>
                        <th>Family</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
            <div style="margin-top:30px; text-align:center;">
                <button class="btn-outline" onclick="backToMain()">Back to Menu</button>
            </div>
        </div>
        <!-- Admin Area -->
        <div id="admin-content" class="card hidden">
            <button class="card-close-btn" onclick="backToMain()" title="Close">√ó</button>
            <div class="admin-header">
                <h1 style="margin: 0;">Admin Dashboard üîß</h1>
                <button class="btn-outline" onclick="backToMain()">‚Üê Back to Menu</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-checked-in">0</div>
                    <div class="stat-label">Currently Checked In</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="stat-volunteers">0</div>
                    <div class="stat-label">Total Volunteers</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="stat-upcoming">0</div>
                    <div class="stat-label">Upcoming Openings</div>
                </div>
            </div>

            <!-- Volunteer Schedule - Full Width -->
            <div class="admin-section full-width">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                    <h2 style="margin:0;font-size:1rem;"><span class="section-icon">üìÖ</span> Volunteer Schedule</h2>
                    <span id="sched-service-label" style="font-size:0.78rem;color:#888;"></span>
                </div>
                <div class="admin-scroll">
                    <table id="admin-schedule-table" class="sched-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Volunteer 1</th>
                                <th>Volunteer 2</th>
                                <th>Volunteer 3</th>
                                <th>Supervisor</th>
                                <th>Helper</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Two-Column Grid for Databases -->
            <div class="admin-grid">
                <div class="admin-section">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                        <h2 style="margin:0;font-size:1rem;"><span class="section-icon">üë•</span> Volunteers</h2>
                        <button class="btn-success btn-sm" onclick="toggleAddToDatabaseForm()" style="font-size:0.8rem;padding:5px 10px;">+ Add</button>
                    </div>
                    <div id="add-to-db-form" class="hidden add-vol-form">
                        <label>Phone: <input type="tel" id="db-vol-phone" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this)"></label><br>
                        <label>First &amp; Last: <input type="text" id="db-vol-name" placeholder="John Doe"></label><br>
                        <button class="btn-success btn-sm" onclick="addToVolunteerDatabase()">Save</button>
                        <button class="btn-outline btn-sm" onclick="toggleAddToDatabaseForm()">Cancel</button>
                    </div>
                    <div id="volunteer-database-content">
                        <div class="db-search-bar">
                            <input type="text" id="vol-search" placeholder="üîç Search name or phone‚Ä¶" oninput="renderVolunteerDatabase(this.value)">
                            <span class="db-count" id="vol-db-count"></span>
                        </div>
                        <div class="db-table-wrap"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                        <h2 style="margin:0;font-size:1rem;"><span class="section-icon">üëî</span> Supervisors</h2>
                        <button class="btn-success btn-sm" onclick="toggleAddSupervisorForm()" style="font-size:0.8rem;padding:5px 10px;">+ Add</button>
                    </div>
                    <div id="add-supervisor-form" class="hidden add-vol-form">
                        <label>Phone: <input type="tel" id="super-phone" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this)"></label><br>
                        <label>First Name: <input type="text" id="super-first-name" placeholder="John"></label><br>
                        <label>Last Name: <input type="text" id="super-last-name" placeholder="Doe"></label><br>
                        <button class="btn-success btn-sm" onclick="addSupervisorToDatabase()">Save</button>
                        <button class="btn-outline btn-sm" onclick="toggleAddSupervisorForm()">Cancel</button>
                    </div>
                    <div id="supervisor-database-content">
                        <div class="db-search-bar">
                            <input type="text" id="sup-search" placeholder="üîç Search name or phone‚Ä¶" oninput="renderSupervisorDatabase(this.value)">
                            <span class="db-count" id="sup-db-count"></span>
                        </div>
                        <div class="db-table-wrap" style="overflow-x:auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Family Database - Full Width -->
            <div class="admin-section full-width">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                    <h2 style="margin:0;font-size:1rem;"><span class="section-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Families</h2>
                    <button class="btn-success btn-sm" onclick="showAddFamilyModal()" style="font-size:0.8rem;padding:5px 10px;">+ Add</button>
                </div>
                <div id="family-database-content">
                    <div class="db-search-bar">
                        <input type="text" id="fam-search" placeholder="üîç Search name or phone‚Ä¶" oninput="renderFamilyDatabase(this.value)">
                        <span class="db-count" id="fam-db-count"></span>
                    </div>
                    <div class="db-table-wrap" style="overflow-x:auto;"></div>
                </div>
            </div>

            <!-- Weekly Reports - Full Width -->
            <div class="admin-section full-width">
                <h2><span class="section-icon">üìä</span> Weekly Reports</h2>
                <div id="reports-content"></div>
            </div>

            <!-- Parental Contracts - Full Width -->
            <div class="admin-section full-width">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                    <h2 style="margin:0;font-size:1rem;"><span class="section-icon">üìú</span> Parental Contracts</h2>
                    <span class="db-count" id="contracts-db-count"></span>
                </div>
                <div class="db-search-bar">
                    <input type="text" id="contracts-search" placeholder="üîç Search name or phone‚Ä¶" oninput="renderContractsTable(this.value)">
                </div>
                <div id="contracts-table-wrap" class="db-table-wrap" style="margin-top:8px;"></div>
            </div>
        </div>
        <!-- Custom checkout confirmation modal -->
        <div id="confirm-modal" class="hidden">
            <div id="confirm-content">
                <h3>Are you sure?</h3>
                <p>This will check out the selected child.</p>
                <div class="modal-buttons">
                    <button class="btn-danger" onclick="confirmCheckout()">OK</button>
                    <button class="btn-outline" onclick="closeConfirmModal()">Cancel</button>
                </div>
            </div>
        </div>
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             Bible Land Parental Contract Modal
             Shows for church members who haven't signed (or signed > 1 year ago)
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="contract-modal" class="modal-overlay hidden">
            <div class="contract-modal-inner">

                <!-- Header -->
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:2.4rem;margin-bottom:6px;">üìú</div>
                    <h2 id="contract-title" style="margin:0 0 4px;color:#4a90e2;font-size:1.5rem;">Bible Land Parental Contract</h2>
                    <p id="contract-subtitle" style="margin:0;color:#666;font-size:0.88rem;">Please read and agree to the following before checking in</p>
                    <!-- Language toggle -->
                    <div id="contract-lang-toggle" style="display:flex;justify-content:center;gap:10px;margin-top:14px;">
                        <button id="contract-lang-ru" onclick="switchContractLang('russian')"
                                style="padding:8px 22px;border-radius:20px;border:2px solid #e74c3c;font-size:0.95rem;font-weight:700;cursor:pointer;background:transparent;color:#e74c3c;transition:all 0.2s;">
                            üá∑üá∫ RU
                        </button>
                        <button id="contract-lang-en" onclick="switchContractLang('english')"
                                style="padding:8px 22px;border-radius:20px;border:2px solid #4a90e2;font-size:0.95rem;font-weight:700;cursor:pointer;background:transparent;color:#4a90e2;transition:all 0.2s;">
                            üá∫üá∏ EN
                        </button>
                    </div>
                </div>

                <!-- Parent info display -->
                <div style="background:#f0f7ff;border-radius:12px;padding:14px 18px;margin-bottom:20px;border-left:4px solid #4a90e2;">
                    <div id="contract-guardian-label" style="font-size:0.8rem;color:#888;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.05em;">Parent / Guardian</div>
                    <div id="contract-parent-name" style="font-size:1.15rem;font-weight:700;color:#2c3e50;"></div>
                    <div id="contract-parent-phone" style="font-size:0.9rem;color:#555;margin-top:2px;"></div>
                </div>

                <!-- Intro text -->
                <p id="contract-intro" style="font-size:0.9rem;color:#444;margin:0 0 14px;line-height:1.5;">
                    By enrolling my child in <strong>Bible Land</strong>, I agree to participate and help Bible Land staff
                    in any request needed to keep Bible Land premises clean and safe. I also agree to the following:
                </p>

                <!-- Rules -->
                <ol id="contract-rules" style="margin:0 0 20px;padding-left:20px;color:#2c3e50;font-size:0.92rem;line-height:1.7;">
                    <li>Serve as a volunteer <strong>at least once every 12 weeks</strong>.</li>
                    <li>When serving, be ready to <strong>greet kids 15 minutes before service</strong>.</li>
                    <li>Serve at <strong>1 holiday service or special event</strong> per year.</li>
                    <li>Attend <strong>cleaning day once per year</strong>.</li>
                    <li>Pick up my child <strong>within 5 minutes after service ends</strong>.</li>
                </ol>

                <!-- Date auto-filled -->
                <div style="font-size:0.85rem;color:#888;margin-bottom:16px;">
                    <span id="contract-date-label">Date:</span> <span id="contract-date-display" style="font-weight:600;color:#444;"></span>
                </div>

                <!-- Checkbox agreement -->
                <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;margin-bottom:22px;
                              background:#f8fff8;border:2px solid #50c878;border-radius:12px;padding:14px;
                              line-height:1.4;">
                    <input type="checkbox" id="contract-agree-checkbox"
                           style="width:22px;height:22px;margin-top:2px;flex-shrink:0;accent-color:#50c878;cursor:pointer;">
                    <span id="contract-agree-text" style="font-size:0.93rem;color:#2c3e50;">
                        I have read and agree to the <strong>Bible Land Parental Contract</strong> listed above.
                        I understand this agreement is renewed annually.
                    </span>
                </label>

                <!-- Buttons -->
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button id="contract-submit-btn" type="button" onclick="submitContract()"
                            style="background:#50c878;color:white;border:none;border-radius:14px;
                                   padding:14px 36px;font-size:1.05rem;font-weight:600;cursor:pointer;
                                   opacity:0.45;pointer-events:none;transition:all 0.2s;">
                        ‚úÖ I Agree ‚Äî Continue Check-In
                    </button>
                    <button type="button" onclick="closeContractModal()"
                            style="background:transparent;border:2px solid #ccc;color:#666;border-radius:14px;
                                   padding:14px 24px;font-size:1rem;cursor:pointer;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin password modal -->
        <div id="admin-password-modal" class="hidden">
            <div id="password-content">
                <h2>Enter Admin PIN</h2>
                <div id="pin-display"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addPinDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addPinDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addPinDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addPinDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addPinDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addPinDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addPinDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addPinDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addPinDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deletePinDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addPinDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearPin()" title="Clear All">CLR</button>
                </div>
                <div>
                    <button class="btn-outline" onclick="closeAdminPasswordModal()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Admin Password Modal - Step 1: Current Password -->
        <div id="change-password-step1-modal" class="hidden modal-overlay">
            <div class="password-content" style="position: relative;">
                <h2 style="margin-top: 0; color: var(--primary);">Enter Current Admin PIN</h2>
                <div id="change-pin-display" class="pin-display-fixed"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addChangePinDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteChangePinDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addChangePinDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearChangePin()" title="Clear All">CLR</button>
                </div>
                <div>
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Change Admin Password Modal - Step 2: New Password Entry -->
        <div id="change-password-step2-modal" class="hidden modal-overlay">
            <div class="password-content">
                <h2>Enter New Admin PIN</h2>
                <p style="color: #50c878; margin: 0 0 8px; font-size:0.9rem;">‚úì Current password verified</p>
                <div id="new-password-display" class="pin-display-fixed"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addNewPasswordDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteNewPasswordDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addNewPasswordDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearNewPassword()" title="Clear All">CLR</button>
                </div>
                
                <div>
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Report Edit Modal -->
        <div id="report-edit-modal" class="hidden modal-overlay">
            <div style="background:white;border-radius:20px;padding:28px 24px;width:340px;max-width:95%;text-align:left;box-shadow:0 16px 50px rgba(0,0,0,0.22);box-sizing:border-box;">
                <h2 style="margin:0 0 4px;color:var(--primary);font-size:1.2rem;">‚úèÔ∏è Edit Sunday Report</h2>
                <p id="report-edit-date-label" style="margin:0 0 18px;color:#666;font-size:0.9rem;"></p>
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">üá∑üá∫ 9:00 AM (Russian)</label>
                <input id="edit-russian-count" type="number" min="0"
                    style="width:100%;padding:12px;border:2px solid #d1e3ff;border-radius:10px;font-size:1.1rem;box-sizing:border-box;margin-bottom:16px;">
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">üá∫üá∏ 12:00 PM (English)</label>
                <input id="edit-english-count" type="number" min="0"
                    style="width:100%;padding:12px;border:2px solid #d1e3ff;border-radius:10px;font-size:1.1rem;box-sizing:border-box;margin-bottom:22px;">
                <div style="display:flex;gap:10px;">
                    <button onclick="saveReportEdit()" class="btn-primary" style="flex:1;padding:12px;font-size:1rem;">Save</button>
                    <button onclick="closeModal('report-edit-modal')" class="btn-outline" style="flex:1;padding:12px;font-size:1rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Change Admin Password Modal - Step 3: Confirm Password Entry -->
        <div id="change-password-step3-modal" class="hidden modal-overlay">
            <div class="password-content">
                <h2>Confirm New PIN</h2>
                <p style="color: #666; margin: 0 0 8px; font-size:0.9rem;">Enter the password again</p>
                <div id="confirm-password-display" class="pin-display-fixed"></div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('1')">1</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('2')">2</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('3')">3</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('4')">4</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('5')">5</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('6')">6</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('7')">7</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('8')">8</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('9')">9</button>
                    <button class="numpad-btn small-btn" onclick="deleteConfirmPasswordDigit()" title="Erase">‚å´</button>
                    <button class="numpad-btn" onclick="addConfirmPasswordDigit('0')">0</button>
                    <button class="numpad-btn small-btn" onclick="clearConfirmPassword()" title="Clear All">CLR</button>
                </div>
                
                <div>
                    <button class="btn-outline" onclick="backToNewPassword()">‚Üê Back</button>
                    <button class="btn-outline" onclick="closeChangePasswordFlow()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Modal for Password Change -->
        <div id="password-confirm-modal" class="hidden modal-overlay-high">
            <div style="background: white; border-radius: 16px; padding: 24px; width: 95%; max-width: 380px; text-align: center; position: relative;">
                <h3 style="margin-top: 0; color: var(--text); font-size: clamp(1.2rem, 3.5vw, 1.4rem);">Are you sure?</h3>
                <p style="font-size: clamp(1rem, 2.5vw, 1.1rem); margin: 15px 0;">Do you want to change the admin password?</p>
                <div style="display: flex; gap: 10px; margin-top: 24px; justify-content: center;">
                    <button class="btn-success" onclick="finalizePasswordChange()" style="padding: 12px 24px;">
                        Yes, Change It
                    </button>
                    <button class="btn-outline" onclick="closePasswordConfirmModal()" style="padding: 12px 24px;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Validation modal -->
        <div id="validation-modal" class="hidden">
            <div id="validation-content">
                <h3>‚ö†Ô∏è Required Information</h3>
                <p id="validation-message"></p>
                <button class="btn-primary" onclick="closeValidationModal()">OK</button>
            </div>
        </div>
        <!-- Centered Alert Modal -->
        <div id="centered-alert" class="centered-modal hidden">
            <div class="centered-modal-content">
                <h3 id="alert-title">Alert</h3>
                <p id="alert-message" style="font-size: 1.1rem; margin: 20px 0;"></p>
                <button class="btn-primary" onclick="closeCenteredAlert()">OK</button>
            </div>
        </div>
        
        <!-- Service Switch Modal -->
        <div id="service-switch-modal" class="hidden modal-overlay-high">
            <div style="background: white; border-radius: 20px; padding: 32px; width: 95%; max-width: 450px; text-align: center;">
                <h2 style="margin-top: 0; color: var(--primary);">Switch Service</h2>
                <p style="color: #666; margin-bottom: 30px;">Select which service you want to check in for</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="confirmServiceSwitch('russian')" 
                            style="padding: 20px; font-size: 1.2rem; background: #ff6b6b; color: white; border: none; border-radius: 12px; cursor: pointer;">
                        üá∑üá∫ Russian Service<br>
                        <span style="font-size: 0.85rem; opacity: 0.9;">9:00 AM</span>
                    </button>
                    <button onclick="confirmServiceSwitch('english')" 
                            style="padding: 20px; font-size: 1.2rem; background: #4a90e2; color: white; border: none; border-radius: 12px; cursor: pointer;">
                        üá∫üá∏ English Service<br>
                        <span style="font-size: 0.85rem; opacity: 0.9;">12:00 PM</span>
                    </button>
                </div>
                <button class="btn-outline" onclick="closeServiceSwitchModal()" style="margin-top: 20px; width: 100%;">Cancel</button>
            </div>
        </div>
        
        <!-- Add Child to Buzzer Modal -->
        <div id="add-child-modal" class="hidden modal-overlay">
            <div style="background: white; border-radius: 16px; padding: 32px; width: 450px; max-width: 90%; position: relative;">
                <h2 style="margin-top: 0; color: var(--primary);">Add Child to Buzzer <span id="add-child-buzzer-num"></span></h2>
                <p style="color: #666; margin-bottom: 20px;">For: <strong id="add-child-parent-name"></strong></p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Child's Name:</label>
                    <input type="text" id="add-child-name" placeholder="Enter child's name"
                           style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Age (1-6):</label>
                    <select id="add-child-age"
                            style="width: 100%; padding: 12px; border: 2px solid #4a90e2; border-radius: 8px; font-size: 1rem; color:#2c3e50; font-weight:500;" required>
                        <option value="" disabled selected>Select</option>
                        <option value="1" style="color:#000;">1</option>
                        <option value="2" style="color:#000;">2</option>
                        <option value="3" style="color:#000;">3</option>
                        <option value="4" style="color:#000;">4</option>
                        <option value="5" style="color:#000;">5</option>
                        <option value="6" style="color:#000;">6</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Allergies:</label>
                    <select id="add-child-allergies" onchange="toggleAddChildOtherAllergy(); this.style.color='#000'"
                            style="width: 100%; padding: 12px; border: 2px solid #4a90e2; border-radius: 8px; font-size: 1rem; color:#2c3e50; font-weight:500;" required>
                        <option value="" disabled selected>Select</option>
                        <option value="None" style="color:#000;">None</option>
                        <option value="Other" style="color:#000;">Other</option>
                    </select>
                    <input type="text" id="add-child-allergies-other" placeholder="Specify allergy" class="hidden"
                           style="width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; margin-top: 10px;">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-success" onclick="submitAddChild()" style="flex: 1;">
                        Add Child
                    </button>
                    <button class="btn-outline" onclick="closeAddChildModal()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ‚îÄ‚îÄ‚îÄ XSS-safe HTML escaping ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const d = document.createElement('div');
            d.textContent = String(str);
            return d.innerHTML;
        }

        // Admin password is now stored in Firebase
        const storageKeys = {
            parents: 'kids_checkin_parents',
            checkIns: 'kids_checkin_list',
            usedBuzzers: 'kids_checkin_used_buzzers',
            volunteers: 'kids_checkin_volunteers',
            familyDatabase: 'kids_checkin_family_database',
            weeklyReports: 'kids_checkin_weekly_reports',
            supervisors: 'kids_checkin_supervisors',
            scheduledSupervisors: 'kids_checkin_scheduled_supervisors',
            scheduledSupervisorHelpers: 'kids_checkin_scheduled_supervisor_helpers'
        };
        // Initialize on window so Firebase can sync
        var checkIns = window.checkIns = window.checkIns || [];
        var parents = window.parents = window.parents || {};
        var usedBuzzers = window.usedBuzzers = window.usedBuzzers || new Set();
        var volunteers = window.volunteers = window.volunteers || {};
        var familyDatabase = window.familyDatabase = window.familyDatabase || {};
        var supervisorDatabase = window.supervisorDatabase = window.supervisorDatabase || {};
        var scheduledSupervisors = window.scheduledSupervisors = window.scheduledSupervisors || {};
        var scheduledSupervisorHelpers = window.scheduledSupervisorHelpers = window.scheduledSupervisorHelpers || {};
        var weeklyReports = window.weeklyReports = window.weeklyReports || {};
        let currentBuzzer = null;
        let childCounter = 0;
        let pendingAction = null;
        let isMemberPath = false;
        let memberPhone = null;
        let memberFirst = null;

        let memberLast = null;
        let pendingCheckoutIndex = null;
        let checkoutPasswordAttempts = 0;

        // ‚îÄ‚îÄ‚îÄ Custom Numpad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let numpadCurrentInput = null;
        let numpadValue = '';
        let numpadProcessing = false; // Prevent rapid clicks

        function showNumpad(inputElement) {
            numpadCurrentInput = inputElement;
            numpadValue = inputElement.value.replace(/\D/g, ''); // Get just digits
            numpadProcessing = false; // Reset processing flag
            updateNumpadDisplay();
            document.getElementById('numpad-overlay').classList.add('show');
        }

        function hideNumpad() {
            document.getElementById('numpad-overlay').classList.remove('show');
            numpadCurrentInput = null;
            numpadValue = '';
            numpadProcessing = false; // Reset processing flag
        }

        function updateNumpadDisplay() {
            const display = document.getElementById('numpad-display');
            if (numpadValue.length === 0) {
                display.textContent = '(000) 000-0000';
                display.style.color = 'rgba(255,255,255,0.35)';
            } else {
                const formatted = formatPhoneForDisplay(numpadValue);
                display.textContent = formatted;
                display.style.color = '#ffffff';
            }
        }

        function formatPhoneForDisplay(digits) {
            if (digits.length <= 3) {
                return `(${digits}`;
            } else if (digits.length <= 6) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            } else {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
            }
        }

        // Helper function to generate age dropdown HTML
        function getAgeDropdownHTML(className, selectedAge = '', style = '') {
            const ages = [1, 2, 3, 4, 5, 6];
            let options = '<option value="">Age</option>';
            ages.forEach(age => {
                const selected = selectedAge == age ? 'selected' : '';
                options += `<option value="${age}" ${selected}>${age}</option>`;
            });
            return `<select class="${className}" style="${style}" required>${options}</select>`;
        }

        function numpadPress(digit) {
            // Prevent rapid multiple clicks
            if (numpadProcessing) {
                return;
            }
            
            if (numpadValue.length < 10) {
                numpadProcessing = true;
                numpadValue += digit;
                updateNumpadDisplay();
                
                // Reset processing flag after short delay
                setTimeout(() => {
                    numpadProcessing = false;
                }, 100);
                
                // Auto-close and apply when 10 digits entered
                if (numpadValue.length === 10) {
                    setTimeout(() => {
                        if (numpadCurrentInput) {
                            const formatted = formatPhoneForDisplay(numpadValue);
                            numpadCurrentInput.value = formatted;
                            
                            // Trigger the oninput event manually
                            const event = new Event('input', { bubbles: true });
                            numpadCurrentInput.dispatchEvent(event);
                        }
                        hideNumpad();
                    }, 300); // Small delay so user sees the complete number
                }
            }
        }

        function numpadBackspace() {
            if (numpadProcessing) return;
            
            if (numpadValue.length > 0) {
                numpadProcessing = true;
                numpadValue = numpadValue.slice(0, -1);
                updateNumpadDisplay();
                setTimeout(() => {
                    numpadProcessing = false;
                }, 100);
            }
        }

        function numpadOK() {
            if (numpadCurrentInput) {
                const formatted = formatPhoneForDisplay(numpadValue);
                numpadCurrentInput.value = formatted;
                
                // Trigger the oninput event manually
                const event = new Event('input', { bubbles: true });
                numpadCurrentInput.dispatchEvent(event);
            }
            hideNumpad();
        }

        // Add click listeners to all phone inputs
        function setupPhoneInputs() {
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                // Always suppress the native keyboard on mobile/tablet.
                // readonly stops iOS/Android from focusing the field natively;
                // inputmode="none" is the modern hint to never show a keyboard.
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('inputmode', 'none');

                // Attach listeners only once
                if (!input.dataset.numpadSetup) {
                    input.dataset.numpadSetup = 'true';

                    // touchstart: preventDefault stops iOS/Android from showing the
                    // native keyboard before the custom numpad can open.
                    input.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        showNumpad(this);
                    }, { passive: false });

                    input.addEventListener('click', function(e) {
                        e.preventDefault();
                        showNumpad(this);
                    });

                    // Some devices fire focus without a tap; blur immediately so
                    // the native keyboard never appears, then open the numpad.
                    input.addEventListener('focus', function() {
                        this.blur();
                        showNumpad(this);
                    });
                }
            });
        }

        // Setup phone inputs after a short delay to ensure DOM is ready
        setTimeout(setupPhoneInputs, 500);

        // ‚îÄ‚îÄ‚îÄ Clock and Date Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDateTime() {
            const now = new Date();
            
            // Update time
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
            
            // Update date
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = days[now.getDay()];
            const monthName = months[now.getMonth()];
            const date = now.getDate();
            const year = now.getFullYear();
            
            document.getElementById('current-date').textContent = `${monthName} ${date}, ${year}`;
            document.getElementById('day-name').textContent = dayName;
        }

        // Update clock every second
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Initial call

        // ‚îÄ‚îÄ‚îÄ Load / Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadData() {
            const loadedParents = JSON.parse(localStorage.getItem(storageKeys.parents)) || {};
            const loadedCheckIns = JSON.parse(localStorage.getItem(storageKeys.checkIns)) || [];
            const loadedUsedBuzzers = new Set(JSON.parse(localStorage.getItem(storageKeys.usedBuzzers)) || []);
            const loadedVolunteers = JSON.parse(localStorage.getItem(storageKeys.volunteers)) || {};
            const loadedFamilyDatabase = JSON.parse(localStorage.getItem(storageKeys.familyDatabase)) || {};
            const loadedWeeklyReports = JSON.parse(localStorage.getItem(storageKeys.weeklyReports)) || {};
            const loadedSupervisorDatabase = JSON.parse(localStorage.getItem(storageKeys.supervisors)) || {};
            const loadedScheduledSupervisors = JSON.parse(localStorage.getItem(storageKeys.scheduledSupervisors)) || {};
            const loadedScheduledSupervisorHelpers = JSON.parse(localStorage.getItem(storageKeys.scheduledSupervisorHelpers)) || {};
            
            // Replace arrays/objects (don't append)
            Object.keys(parents).forEach(k => delete parents[k]);
            Object.assign(parents, loadedParents);
            
            checkIns.length = 0; // Clear array
            checkIns.push(...loadedCheckIns);
            
            usedBuzzers.clear(); // Clear set
            loadedUsedBuzzers.forEach(b => usedBuzzers.add(b));
            
            Object.keys(volunteers).forEach(k => delete volunteers[k]);
            Object.assign(volunteers, loadedVolunteers);
            
            Object.keys(familyDatabase).forEach(k => delete familyDatabase[k]);
            Object.assign(familyDatabase, loadedFamilyDatabase);
            
            Object.keys(weeklyReports).forEach(k => delete weeklyReports[k]);
            Object.assign(weeklyReports, loadedWeeklyReports);
            
            Object.keys(supervisorDatabase).forEach(k => delete supervisorDatabase[k]);
            Object.assign(supervisorDatabase, loadedSupervisorDatabase);
            
            Object.keys(scheduledSupervisors).forEach(k => delete scheduledSupervisors[k]);
            Object.assign(scheduledSupervisors, loadedScheduledSupervisors);
            
            Object.keys(scheduledSupervisorHelpers).forEach(k => delete scheduledSupervisorHelpers[k]);
            Object.assign(scheduledSupervisorHelpers, loadedScheduledSupervisorHelpers);
            
            if (!volunteers.all) volunteers.all = [];
            // Weekly reports are updated on each check-in event, not on load
        }

        window.saveData = function() {
            localStorage.setItem(storageKeys.parents, JSON.stringify(parents));
            localStorage.setItem(storageKeys.checkIns, JSON.stringify(checkIns));
            localStorage.setItem(storageKeys.usedBuzzers, JSON.stringify([...usedBuzzers]));
            localStorage.setItem(storageKeys.volunteers, JSON.stringify(volunteers));
            localStorage.setItem(storageKeys.familyDatabase, JSON.stringify(familyDatabase));
            localStorage.setItem(storageKeys.weeklyReports, JSON.stringify(weeklyReports));
            localStorage.setItem(storageKeys.supervisors, JSON.stringify(supervisorDatabase));
            localStorage.setItem(storageKeys.scheduledSupervisors, JSON.stringify(scheduledSupervisors));
            localStorage.setItem(storageKeys.scheduledSupervisorHelpers, JSON.stringify(scheduledSupervisorHelpers));
        }
        // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function hideAll() {
            document.querySelectorAll('.card, .volunteer-form').forEach(c => c.classList.add('hidden'));
        }

        function show(id) {
            hideAll();
            document.getElementById(id).classList.remove('hidden');
            // Show profile pill only on main screen
            const bar = document.getElementById('user-info-bar');
            if (bar) {
                if (id === 'main-screen') {
                    bar.classList.add('main-screen-visible');
                } else {
                    bar.classList.remove('main-screen-visible');
                }
            }
            // Re-attach numpad to any new phone inputs
            setTimeout(setupPhoneInputs, 100);
        }

        function backToMain() {
            document.querySelectorAll('.buzzer-btn.selected').forEach(b => b.classList.remove('selected'));
            currentBuzzer = null;
            childCounter = 0;
            isMemberPath = false;
            memberPhone = null;
            memberFirst = null;
            memberLast = null;
            window._resumingCheckin = false; // allow auth to show main-screen normally from now on
            document.getElementById('children-list').innerHTML = '';
            show('main-screen');
        }

        function backFromBuzzerToInfo() {
            currentBuzzer = null;
            show('info-form');
        }
        // ‚îÄ‚îÄ‚îÄ Check-in flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showMembership() {
            show('membership-screen');
        }

        function selectMembership(type) {
            isMemberPath = (type === 'member');

            if (isMemberPath) {
                document.getElementById('vol-phone-first').value = '';
                show('volunteer-phone-screen');
                document.getElementById('vol-phone-first').focus();
            } else {
                document.getElementById('nonmem-phone').value = '';
                show('nonmem-phone-screen');
                document.getElementById('nonmem-phone').focus();
            }
        }

        // ‚îÄ‚îÄ‚îÄ Non-member phone pre-fill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onNonMemberPhoneInput() {
            const raw = document.getElementById('nonmem-phone').value;
            const phone = raw.replace(/\D/g, '');
            
            if (phone.length === 10) {
                // Check familyDatabase first, then parents
                if (familyDatabase[phone]) {
                    const family = familyDatabase[phone];
                    document.getElementById('firstName').value = family.firstName || '';
                    document.getElementById('lastName').value = family.lastName || '';
                } else if (parents[phone]) {
                    const p = parents[phone];
                    document.getElementById('firstName').value = p.firstName || '';
                    document.getElementById('lastName').value = p.lastName || '';
                } else {
                    // Unknown phone number - clear the autofilled fields
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                }
            } else if (phone.length < 10) {
                // Phone number incomplete - clear the autofilled fields
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
            }
        }

        function handleNonMemberPhone() {
            const input = document.getElementById('nonmem-phone');
            const phoneClean = input.value.replace(/\D/g, '').trim();

            if (phoneClean.length !== 10) {
                showCenteredAlert("Please enter a valid 10-digit phone number");
                input.focus();
                return;
            }

            // Set phone in info form
            document.getElementById('phone').value = input.value;

            // Check familyDatabase first for saved kids
            if (familyDatabase[phoneClean] && familyDatabase[phoneClean].kids && familyDatabase[phoneClean].kids.length > 0) {
                // Prefill from family database
                const family = familyDatabase[phoneClean];
                document.getElementById('firstName').value = family.firstName || '';
                document.getElementById('lastName').value = family.lastName || '';
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                
                familyDatabase[phoneClean].kids.forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
              <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Child:</strong>
                      <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Age:</strong>
                      <select class="child-age" style="width: 110px;" required>
                          <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                          ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                      </select>
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Allergies:</strong>
                      <select class="child-allergies" style="width: 140px;" required>
                          <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                          <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                          <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                      </select>
                  </label>
                  <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
              </div>
              
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                  <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
              </button>
          </div>
        `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else if (parents[phoneClean]) {
                const p = parents[phoneClean];
                document.getElementById('firstName').value = p.firstName || '';
                document.getElementById('lastName').value = p.lastName || '';
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                (p.children || []).forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
              <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Child:</strong>
                      <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Age:</strong>
                      <select class="child-age" style="width: 110px;" required>
                          <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                          ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                      </select>
                  </label>
                  <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                      <strong>Allergies:</strong>
                      <select class="child-allergies" style="width: 140px;" required>
                          <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                          <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                          <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                      </select>
                  </label>
                  <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
              </div>
              
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                  <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
              </button>
          </div>
        `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else {
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('children-list').innerHTML = '';
                addChildEntry();
            }

            show('info-form');
        }

        // ‚îÄ‚îÄ‚îÄ Centered Alert Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showCenteredAlert(message, title = 'Alert') {
            // Close numpad first to prevent overlay issues
            hideNumpad();
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const modal = document.getElementById('centered-alert');
            // Reset OK button
            const okBtn = modal.querySelector('.btn-primary');
            okBtn.textContent = 'OK';
            okBtn.onclick = closeCenteredAlert;
            // Hide any lingering No button
            const noBtn = modal.querySelector('.btn-cancel-temp');
            if (noBtn) noBtn.style.display = 'none';
            openModal(modal);
        }

        function closeCenteredAlert() {
            closeModal('centered-alert');
        }

        function showConfirmModal(message, title, onYes, onNo) {
            // Close numpad first to prevent overlay issues
            hideNumpad();
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const modal = document.getElementById('centered-alert');
            const okBtn = modal.querySelector('.btn-primary');
            
            // Change OK button to Yes/No buttons
            okBtn.textContent = 'Yes';
            okBtn.onclick = () => {
                closeModal(modal);
                okBtn.textContent = 'OK';
                okBtn.onclick = closeCenteredAlert;
                if (onYes) onYes();
            };
            
            // Add No button if not exists
            let noBtn = modal.querySelector('.btn-cancel-temp');
            if (!noBtn) {
                noBtn = document.createElement('button');
                noBtn.className = 'btn-outline btn-cancel-temp';
                noBtn.textContent = 'No';
                modal.querySelector('.centered-modal-content').appendChild(noBtn);
            }
            noBtn.style.display = 'inline-block';
            noBtn.onclick = () => {
                closeModal(modal);
                okBtn.textContent = 'OK';
                okBtn.onclick = closeCenteredAlert;
                noBtn.style.display = 'none';
                if (onNo) onNo();
            };
            
            openModal(modal);
        }

        // ‚îÄ‚îÄ Centralized Modal Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Tracks how many modals are open so scroll lock only clears when ALL are closed.
        let _modalOpenCount = 0;
        let _savedScrollY  = 0;

        function openModal(el) {
            if (typeof el === 'string') el = document.getElementById(el);
            if (!el) return;
            if (_modalOpenCount === 0) {
                _savedScrollY = window.scrollY || window.pageYOffset;
                document.body.classList.add('modal-open');
                document.body.style.top = `-${_savedScrollY}px`;
            }
            _modalOpenCount++;
            el.classList.remove('hidden');
        }

        function closeModal(el) {
            if (typeof el === 'string') el = document.getElementById(el);
            if (!el) return;
            el.classList.add('hidden');
            _modalOpenCount = Math.max(0, _modalOpenCount - 1);
            if (_modalOpenCount === 0) {
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, _savedScrollY);
            }
        }

        function removeDynamicModal(el) {
            if (!el) return;
            el.remove();
            _modalOpenCount = Math.max(0, _modalOpenCount - 1);
            if (_modalOpenCount === 0) {
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, _savedScrollY);
            }
        }

        // Called from inline onclick on dynamic modal cancel/close buttons
        window.closeDynamicModal = function(triggerEl) {
            const modal = triggerEl.closest('.dynamic-modal');
            if (modal) removeDynamicModal(modal);
        };

        // ‚îÄ‚îÄ End Modal Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // ‚îÄ‚îÄ‚îÄ Volunteer phone input ‚Äî autofill name from database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onVolunteerPhoneInput() {
            const raw = document.getElementById('vol-phone-first').value;
            const phone = raw.replace(/\D/g, '');
            if (phone.length === 10) {
                // Check supervisor DB first to auto-fill name
                if (supervisorDatabase[phone]) {
                    const sup = supervisorDatabase[phone];
                    document.getElementById('vol-first').value = sup.firstName || '';
                    document.getElementById('vol-last').value = sup.lastName || '';
                } else {
                    const known = getVolunteerByPhone(phone);
                    if (known && known.name) {
                        const parts = known.name.trim().split(' ');
                        document.getElementById('vol-first').value = parts[0] || '';
                        document.getElementById('vol-last').value = parts.slice(1).join(' ') || '';
                    }
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ Show volunteer schedule after name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showVolunteerScheduleAfterName() {
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();
            const phoneRaw = document.getElementById('vol-phone-first').value;
            const phone = phoneRaw.replace(/\D/g, '');

            if (!first || !last) {
                showCenteredAlert("Please enter both first and last name");
                return;
            }

            if (phone.length !== 10) {
                showCenteredAlert("Please enter a valid 10-digit phone number");
                return;
            }

            // Store for later use
            memberPhone = phoneRaw;
            memberFirst = first;
            memberLast = last;

            // ‚îÄ‚îÄ Check contract first, then proceed with routing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function _proceedAfterContract() {
                // ‚îÄ‚îÄ Supervisor: skip straight to child check-in, never touch volunteer DB ‚îÄ‚îÄ
                if (supervisorDatabase[phone]) {
                    skipVolunteerSchedule();
                    return;
                }

                // Non-supervisor: add or update in volunteer DB
                const fullName = `${first} ${last}`;
                const existingVol = getVolunteerByPhone(phone);
                if (existingVol) {
                    if (existingVol.name !== fullName) {
                        updateAllVolunteers(phone, 'name', fullName);
                    }
                } else {
                    // New number on member path ‚Üí add to volunteer DB
                    if (!volunteers.all) volunteers.all = [];
                    volunteers.all.push({ name: fullName, phone: phone });
                    saveData();
                }

                // Check if already scheduled within the next 12 weeks
                const next3Months = getUpcomingSundays(12);
                let isAlreadyScheduled = false;
                for (const date of next3Months) {
                    const serviceKey = `${date}_${window.currentService}`;
                    const slots = volunteers[serviceKey] || [];
                    if (slots.some(v => v.phone === phone)) {
                        isAlreadyScheduled = true;
                        break;
                    }
                }
                if (isAlreadyScheduled) {
                    skipVolunteerSchedule();
                    return;
                }

                // Not yet signed up ‚Äî redirect to volunteer-signup page
                // Store personal data in sessionStorage only ‚Äî never in the URL
                localStorage.setItem('pendingVolunteerCheckin', JSON.stringify({
                    phone: phoneRaw,
                    firstName: first,
                    lastName: last
                }));
                sessionStorage.setItem('volunteerHandoff', JSON.stringify({
                    phone: phone,
                    fname: first,
                    lname: last,
                    service: window.currentService || 'russian'
                }));
                window.location.href = '/volunteer?return=true';
            }

            // Show contract if not yet signed (or expired). On agree, continue flow.
            if (!window.isContractValid(phone)) {
                window.showContractModal(first, last, phone, _proceedAfterContract);
            } else {
                _proceedAfterContract();
            }
        }

        // ‚îÄ‚îÄ‚îÄ Render volunteer schedule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderVolunteerSchedule() {
            const schedList = document.getElementById('schedule-list');
            schedList.innerHTML = '';
            const sundays = getUpcomingSundays(13);
            const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();

            sundays.forEach(date => {
                const slots = volunteers[date] || [];
                const isFull = slots.length >= 3;
                const alreadySignedUp = slots.some(v => v.phone === phone);
                
                const div = document.createElement('div');
                div.className = 'schedule-item' + (isFull || alreadySignedUp ? '' : ' open');
                
                let statusText = '';
                if (alreadySignedUp) {
                    statusText = '‚úì You are signed up';
                } else if (isFull) {
                    statusText = 'Full (3/3)';
                } else if (slots.length === 2) {
                    statusText = 'Need 1 more (2/3)';
                } else if (slots.length === 1) {
                    statusText = 'Need 2 more (1/3)';
                } else {
                    statusText = 'Open (0/3)';
                }

                div.innerHTML = `
                    <span><strong>${date}</strong> - ${statusText}</span>
                    ${!isFull && !alreadySignedUp ? 
                        `<button class="btn-success btn-sm" onclick="signUpForDate('${date}')">Sign Up</button>` : 
                        ''}
                `;
                schedList.appendChild(div);
            });
        }

        // ‚îÄ‚îÄ‚îÄ Sign up for volunteer date ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function signUpForDate(date) {
            const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
            const first = document.getElementById('vol-first').value.trim();
            const last = document.getElementById('vol-last').value.trim();
            const name = `${first} ${last}`;

            if (!volunteers[date]) volunteers[date] = [];
            
            if (volunteers[date].length >= 2) {
                showCenteredAlert("This date is already full.");
                return;
            }

            if (volunteers[date].some(v => v.phone === phone)) {
                showCenteredAlert("You are already signed up for this date.");
                return;
            }

            const vol = { name, phone };
            volunteers[date].push(vol);
            addToVolunteerAllIfNotExists(vol);
            saveData();
            
            // Volunteer signed up ‚Äî proceed to child check-in
            skipVolunteerSchedule();
        }

        // ‚îÄ‚îÄ‚îÄ Skip volunteer schedule and go to child check-in ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Contract has already been checked before reaching here.
        function skipVolunteerSchedule() {
            // Transfer volunteer info to parent info
            document.getElementById('phone').value = memberPhone;
            document.getElementById('firstName').value = memberFirst;
            document.getElementById('lastName').value = memberLast;

            // Check if they have existing children in familyDatabase
            const phoneClean = memberPhone.replace(/\D/g, '');
            if (familyDatabase[phoneClean] && familyDatabase[phoneClean].kids && familyDatabase[phoneClean].kids.length > 0) {
                document.getElementById('children-list').innerHTML = '';
                childCounter = 0;
                familyDatabase[phoneClean].kids.forEach(child => {
                    childCounter++;
                    const div = document.createElement('div');
                    div.className = 'child-entry';
                    const allergiesValue = child.allergies || '';
                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                    const otherText = isOther ? allergiesValue : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Child:</strong>
                                    <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                </label>
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Age:</strong>
                                    <select class="child-age" style="width: 110px;" required>
                                        <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                        ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                    </select>
                                </label>
                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                    <strong>Allergies:</strong>
                                    <select class="child-allergies" style="width: 140px;" required>
                                        <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                        <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                        <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                    </select>
                                </label>
                                <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                            </div>
                            
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                            </button>
                        </div>
                    `;
                    document.getElementById('children-list').appendChild(div);
                    attachAllergyHandler(div);
                });
            } else {
                document.getElementById('children-list').innerHTML = '';
                addChildEntry();
            }

            show('info-form');
        }

        // ‚îÄ‚îÄ‚îÄ Add child entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function addChildEntry() {
            childCounter++;
            const div = document.createElement('div');
            div.className = 'child-entry';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Child:</strong>
                            <input type="text" class="child-name" placeholder="Name" required style="width: 140px;" />
                        </label>
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Age:</strong>
                            <select class="child-age" style="width: 110px;" required>
                                <option value="" disabled selected>Select</option>
                                ${[1,2,3,4,5,6].map(age => `<option value="${age}" style="color:#000;">${age}</option>`).join('')}
                            </select>
                        </label>
                        <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                            <strong>Allergies:</strong>
                            <select class="child-allergies" style="width: 140px;" required>
                                <option value="" disabled selected>Select</option>
                                <option value="None" style="color:#000;">None</option>
                                <option value="Other" style="color:#000;">Other</option>
                            </select>
                        </label>
                        <input type="text" class="child-allergies-other" style="width: 140px; display:none;" placeholder="Specify allergy" />
                    </div>
                    
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                        <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                    </button>
                </div>
            `;
            document.getElementById('children-list').appendChild(div);
            attachAllergyHandler(div);
        }

        // ‚îÄ‚îÄ‚îÄ Attach allergy handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function attachAllergyHandler(div) {
            const select = div.querySelector('.child-allergies');
            const otherInput = div.querySelector('.child-allergies-other');
            select.addEventListener('change', function() {
                if (this.value === 'Other') {
                    otherInput.style.display = 'inline';
                } else {
                    otherInput.style.display = 'none';
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ Renumber children ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renumberChildren() {
            childCounter = 0;
            document.querySelectorAll('.child-entry').forEach(entry => {
                childCounter++;
                entry.querySelector('strong').textContent = `Child ${childCounter}`;
            });
        }

        // ‚îÄ‚îÄ‚îÄ Phone input handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onPhoneInput() {
            const raw = document.getElementById('phone').value;
            const phone = raw.replace(/\D/g, '');
            if (phone.length === 10 && parents[phone]) {
                const p = parents[phone];
                document.getElementById('firstName').value = p.firstName || '';
                document.getElementById('lastName').value = p.lastName || '';
            }
            
            // Prefill ALL kids from family database if exists
            if (phone.length === 10 && familyDatabase[phone]) {
                const family = familyDatabase[phone];
                if (family.kids && family.kids.length > 0) {
                    document.getElementById('children-list').innerHTML = '';
                    childCounter = 0;
                    family.kids.forEach(child => {
                        childCounter++;
                        const div = document.createElement('div');
                        div.className = 'child-entry';
                        const allergiesValue = child.allergies || '';
                        const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                        const otherText = isOther ? allergiesValue : '';
                        
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Child:</strong>
                                        <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                    </label>
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Age:</strong>
                                        <select class="child-age" style="width: 110px;" required>
                                            <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                            ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                        </select>
                                    </label>
                                    <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                        <strong>Allergies:</strong>
                                        <select class="child-allergies" style="width: 140px;" required>
                                            <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                            <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                            <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                        </select>
                                    </label>
                                    <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                                </div>
                                
              <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                    <span class="icon">üóëÔ∏è</span>
                  <span class="text">Remove<br>Child</span>
                                </button>
                            </div>
                        `;
                        document.getElementById('children-list').appendChild(div);
                        attachAllergyHandler(div);
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ Close validation modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function closeValidationModal() {
            closeModal('validation-modal');
        }

        // ‚îÄ‚îÄ‚îÄ Show validation modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showValidationModal(message) {
            document.getElementById('validation-message').textContent = message;
            openModal('validation-modal');
        }

        // ‚îÄ‚îÄ‚îÄ Finish check-in ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let isProcessingCheckIn = false; // Guard to prevent duplicate submissions
        
        function resetCheckInButton() {
            const checkInBtn = document.querySelector('button[onclick="finishCheckIn()"]');
            if (checkInBtn) {
                checkInBtn.disabled = false;
                checkInBtn.style.opacity = '1';
            }
        }
        
        function finishCheckIn() {
            // Prevent multiple simultaneous calls
            if (isProcessingCheckIn) {
                console.log('‚ö†Ô∏è Check-in already in progress, ignoring duplicate call');
                return;
            }
            
            isProcessingCheckIn = true;
            
            // Disable the check-in button to prevent double-clicks
            const checkInBtn = document.querySelector('button[onclick="finishCheckIn()"]');
            if (checkInBtn) {
                checkInBtn.disabled = true;
                checkInBtn.style.opacity = '0.5';
            }
            
            const phone = document.getElementById('phone').value.replace(/\D/g, '').trim();
            const first = document.getElementById('firstName').value.trim();
            const last = document.getElementById('lastName').value.trim();
            
            if (phone.length !== 10) {
                showValidationModal("Please enter a valid 10-digit phone number");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            if (!first || !last) {
                showValidationModal("Please fill in parent first and last name");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            // Check if this phone number already checked in today
            const today = new Date().toDateString();
            const alreadyCheckedIn = checkIns.some(entry => {
                const entryDate = new Date(entry.timestamp || Date.now()).toDateString();
                const entryPhone = entry.phone.replace(/\D/g, '');
                return entryDate === today && entryPhone === phone;
            });
            
            if (alreadyCheckedIn) {
                showCenteredAlert("This phone number is already checked in today!", "Duplicate Check-In");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            let added = 0;
            let hasError = false;
            let errorMessage = '';
            const currentChildren = [];
            
            document.querySelectorAll('.child-entry').forEach((row, index) => {
                const name = row.querySelector('.child-name').value.trim();
                const ageInput = row.querySelector('.child-age');
                const age = ageInput.value.trim();
                const allergiesSelect = row.querySelector('.child-allergies');
                let allergies = allergiesSelect.value;
                const otherInput = row.querySelector('.child-allergies-other');
                
                if (!name) {
                    errorMessage = `Child ${index + 1}: Please enter a name`;
                    hasError = true;
                    return;
                }
                
                if (!age || age < 1 || age > 6) {
                    errorMessage = `Child ${index + 1} (${name}): Please enter a valid age between 1 and 6`;
                    hasError = true;
                    return;
                }
                
                if (!allergies || allergies === '') {
                    errorMessage = `Child ${index + 1} (${name}): Please select an allergy option (select "None" if no allergies)`;
                    hasError = true;
                    return;
                }
                
                if (allergies === 'Other') {
                    const otherValue = otherInput.value.trim();
                    if (!otherValue) {
                        errorMessage = `Child ${index + 1} (${name}): Please specify the allergy or select "None"`;
                        hasError = true;
                        return;
                    }
                    allergies = otherValue;
                }
                
                currentChildren.push({
                    name,
                    age,
                    allergies
                });
                added++;
            });
            
            if (hasError) {
                showValidationModal(errorMessage);
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }
            
            if (added === 0) {
                showValidationModal("Please add at least one child");
                resetCheckInButton();
                isProcessingCheckIn = false;
                return;
            }

            if (!currentBuzzer) {
                memberPhone = document.getElementById('phone').value;
                memberFirst = first;
                memberLast = last;
                showBuzzerScreen();
                resetCheckInButton();
                isProcessingCheckIn = false; // Reset because we're not done yet, just going to buzzer screen
                return;
            }
            
            const formattedPhone = document.getElementById('phone').value;
            currentChildren.forEach(child => {
                checkIns.push({
                    buzzer: currentBuzzer,
                    childName: child.name,
                    age: child.age || '‚Äî',
                    allergies: child.allergies || 'None',
                    phone: formattedPhone,
                    parentName: `${first} ${last}`,
                    timestamp: Date.now(),
                    service: window.currentService || 'english' // Tag with current service
                });
            });
            
            if (!parents[phone]) parents[phone] = {};
            parents[phone].firstName = first;
            parents[phone].lastName = last;
            parents[phone].children = currentChildren;
            
            // Update family database - only add NEW children, don't remove existing ones
            if (!familyDatabase[phone]) {
                // First time for this phone - create new entry
                familyDatabase[phone] = {
                    type: isMemberPath ? 'member' : 'nonmember',
                    firstName: first,
                    lastName: last,
                    kids: currentChildren.map(child => ({
                        name: child.name,
                        age: child.age,
                        allergies: child.allergies
                    }))
                };
            } else {
                // Phone exists - only add NEW children
                const existingKids = familyDatabase[phone].kids || [];
                const existingKidNames = existingKids.map(k => k.name.toLowerCase());
                
                // Add new children that don't exist yet
                currentChildren.forEach(child => {
                    if (!existingKidNames.includes(child.name.toLowerCase())) {
                        existingKids.push({
                            name: child.name,
                            age: child.age,
                            allergies: child.allergies
                        });
                    }
                });
                
                // Update the family database with merged list
                familyDatabase[phone].kids = existingKids;
                // Update parent names in case they changed
                familyDatabase[phone].firstName = first;
                familyDatabase[phone].lastName = last;
            }
            
            usedBuzzers.add(currentBuzzer);
            saveData();
            checkAndSaveWeeklyReport(); // Update Sunday report if today is Sunday
            
            // Create child names list
            const childNames = currentChildren.map(c => c.name).join(', ');
            document.getElementById('success-text').textContent = `Checked in ${childNames} with buzzer #${currentBuzzer}`;
            document.getElementById('success-modal').classList.remove('hidden');
            
            // Reset the guard and button after successful check-in
            resetCheckInButton();
            isProcessingCheckIn = false;
        }

        // ‚îÄ‚îÄ‚îÄ Show buzzer screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showBuzzerScreen() {
            renderBuzzerGrid();
            show('buzzer-screen');
        }

        // ‚îÄ‚îÄ‚îÄ Render buzzer grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderBuzzerGrid() {
            const grid = document.getElementById('buzzer-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 48; i++) {
                const btn = document.createElement('button');
                btn.className = 'buzzer-btn';
                btn.textContent = i;
                
                if (usedBuzzers.has(i)) {
                    btn.classList.add('unavailable');
                } else {
                    btn.classList.add('available');
                    btn.onclick = () => selectBuzzer(i);
                }
                
                grid.appendChild(btn);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Select buzzer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function selectBuzzer(num) {
            document.querySelectorAll('.buzzer-btn.selected').forEach(b => b.classList.remove('selected'));
            const btn = Array.from(document.querySelectorAll('.buzzer-btn')).find(b => b.textContent == num);
            if (btn) {
                btn.classList.add('selected');
                currentBuzzer = num;
                
                // Auto-proceed to finish check-in
                setTimeout(() => {
                    finishCheckIn();
                }, 500);
            }
        }

        // ‚îÄ‚îÄ‚îÄ View Current Check-Ins ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // Store temporary data for adding child
        let pendingAddChild = null;
        
        function requestAddChildToBuzzer(buzzerNum, phone, parentName) {
            // Store the data
            pendingAddChild = { buzzerNum, phone, parentName };
            
            // Request admin password first
            pendingAction = { action: 'add-child-to-buzzer' };
            showAdminPasswordModal();
        }
        
        function showAddChildForm() {
            if (!pendingAddChild) return;
            
            document.getElementById('add-child-buzzer-num').textContent = '#' + pendingAddChild.buzzerNum;
            document.getElementById('add-child-parent-name').textContent = pendingAddChild.parentName;
            document.getElementById('add-child-name').value = '';
            document.getElementById('add-child-age').value = '';
            document.getElementById('add-child-allergies').value = '';
            document.getElementById('add-child-allergies-other').value = '';
            document.getElementById('add-child-allergies-other').classList.add('hidden');
            
            openModal('add-child-modal');
        }
        
        function closeAddChildModal() {
            closeModal('add-child-modal');
            // Clear form fields
            document.getElementById('add-child-name').value = '';
            document.getElementById('add-child-age').value = '';
            document.getElementById('add-child-allergies').value = '';
            document.getElementById('add-child-allergies-other').value = '';
            document.getElementById('add-child-allergies-other').classList.add('hidden');
            pendingAddChild = null;
        }
        
        function toggleAddChildOtherAllergy() {
            const select = document.getElementById('add-child-allergies');
            const otherInput = document.getElementById('add-child-allergies-other');
            
            if (select.value === 'Other') {
                otherInput.classList.remove('hidden');
            } else {
                otherInput.classList.add('hidden');
            }
        }
        
        function submitAddChild() {
            if (!pendingAddChild) return;
            
            const name = document.getElementById('add-child-name').value.trim();
            const age = document.getElementById('add-child-age').value.trim();
            let allergies = document.getElementById('add-child-allergies').value;
            const otherAllergy = document.getElementById('add-child-allergies-other').value.trim();
            
            // Validation
            if (!name) {
                showCenteredAlert('Required', 'Please enter the child\'s name');
                return;
            }
            
            if (!age) {
                showCenteredAlert('Required', 'Please select the child\'s age (1-6)');
                return;
            }
            
            if (!allergies) {
                showCenteredAlert('Required', 'Please select an allergy option (select "None" if no allergies)');
                return;
            }
            
            if (allergies === 'Other') {
                if (!otherAllergy) {
                    showCenteredAlert('Required', 'Please specify the allergy or select "None"');
                    return;
                }
                allergies = otherAllergy;
            }
            
            // Add child to check-ins
            const phone = pendingAddChild.phone;
            const buzzer = pendingAddChild.buzzerNum;
            const parentName = pendingAddChild.parentName;
            
            checkIns.push({
                buzzer: buzzer,
                childName: name,
                age: age,
                allergies: allergies,
                phone: phone,
                parentName: parentName,
                timestamp: Date.now(),
                service: window.currentService || 'english' // Tag with current service
            });
            
            // Update family database
            const cleanPhone = phone.replace(/\D/g, '');
            if (familyDatabase[cleanPhone]) {
                const existingKids = familyDatabase[cleanPhone].kids || [];
                const existingKid = existingKids.find(k => k.name.toLowerCase() === name.toLowerCase());
                
                if (existingKid) {
                    // Update age if different
                    if (existingKid.age != age) {
                        existingKid.age = age;
                    }
                } else {
                    // Add new child
                    existingKids.push({
                        name: name,
                        age: age,
                        allergies: allergies
                    });
                    familyDatabase[cleanPhone].kids = existingKids;
                }
            }
            
            saveData();
            closeAddChildModal();
            renderCheckInTable();
            showCenteredAlert('Success! ‚úÖ', `${name} has been added to buzzer #${buzzer}`);
        }
        
        function showViewCheckInsPasswordModal() {
            window.pendingViewCheckIns = true;
            showAdminPasswordModal();
        }
        
        function showViewCheckIns() {
            show('view-checkins');
            renderCheckInTable();
        }

        function renderCheckInTable() {
            const tbody = document.querySelector('#checkin-table tbody');
            tbody.innerHTML = '';
            
            // Get service filter
            const filterSelect = document.getElementById('checkin-service-filter');
            const serviceFilter = filterSelect ? filterSelect.value : 'all';
            
            // Filter check-ins by service
            let filteredCheckIns = checkIns;
            if (serviceFilter !== 'all') {
                filteredCheckIns = checkIns.filter(ci => ci.service === serviceFilter);
            }
            
            // Group check-ins by buzzer
            const buzzerGroups = {};
            filteredCheckIns.forEach((ci, idx) => {
                // Find original index in checkIns array
                const originalIndex = checkIns.indexOf(ci);
                if (!buzzerGroups[ci.buzzer]) {
                    buzzerGroups[ci.buzzer] = [];
                }
                buzzerGroups[ci.buzzer].push({...ci, originalIndex: originalIndex});
            });
            
            // Render grouped by buzzer
            Object.keys(buzzerGroups).sort((a, b) => a - b).forEach(buzzerNum => {
                const group = buzzerGroups[buzzerNum];
                const firstChild = group[0];
                
                // First row shows buzzer, first child, and checkout button with rowspan
                let tr = document.createElement('tr');
                let allergiesStyle = (firstChild.allergies && firstChild.allergies !== 'None' && firstChild.allergies.trim() !== '') ?
                    ' style="color: red; font-weight: bold;"' : '';
                
                tr.innerHTML = `
                    <td rowspan="${group.length}">#${escapeHtml(buzzerNum)}</td>
                    <td>${escapeHtml(firstChild.childName)}</td>
                    <td>${escapeHtml(firstChild.age)}</td>
                    <td${allergiesStyle}>${escapeHtml(firstChild.allergies)}</td>
                    <td rowspan="${group.length}">${escapeHtml(firstChild.parentName)}</td>
                    <td rowspan="${group.length}" class="phone-cell" onclick="requestAdminAction('show-phone', ${firstChild.originalIndex})">${escapeHtml(firstChild.phone)}</td>
                    <td rowspan="${group.length}">
                        <button class="btn-danger btn-sm" onclick="requestCheckoutByBuzzer(${buzzerNum})" style="display: block; margin: 4px auto;">Check Out</button>
                        <button class="btn-primary btn-sm" onclick="requestAddChildToBuzzer(${buzzerNum}, '${escapeHtml(firstChild.phone)}', '${escapeHtml(firstChild.parentName)}')" style="display: block; margin: 4px auto;">+ Add Child</button>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Additional rows for siblings (only show child info)
                for (let i = 1; i < group.length; i++) {
                    const child = group[i];
                    let siblingTr = document.createElement('tr');
                    let siblingAllergiesStyle = (child.allergies && child.allergies !== 'None' && child.allergies.trim() !== '') ?
                        ' style="color: red; font-weight: bold;"' : '';
                    
                    siblingTr.innerHTML = `
                        <td>${escapeHtml(child.childName)}</td>
                        <td>${escapeHtml(child.age)}</td>
                        <td${siblingAllergiesStyle}>${escapeHtml(child.allergies)}</td>
                    `;
                    tbody.appendChild(siblingTr);
                }
            });
        }
        function requestCheckout(index) {
            pendingCheckoutIndex = index;
            openModal('confirm-modal');
        }

        function requestCheckoutByBuzzer(buzzerNum) {
            pendingCheckoutIndex = buzzerNum;
            const children = checkIns.filter(ci => ci.buzzer === buzzerNum);
            const childNames = children.map(c => c.childName).join(', ');
            document.querySelector('#confirm-content p').textContent = 
                `This will check out ${childNames} with buzzer #${buzzerNum}.`;
            openModal('confirm-modal');
        }

        function closeConfirmModal() {
            closeModal('confirm-modal');
            pendingCheckoutIndex = null;
        }

        function confirmCheckout() {
            closeModal('confirm-modal');
            finalizeCheckout();
        }

        function finalizeCheckout() {
            if (pendingCheckoutIndex === null) return;
            
            // pendingCheckoutIndex now holds the buzzer number
            const buzzerNum = pendingCheckoutIndex;
            
            // Remove all check-ins with this buzzer number
            checkIns = checkIns.filter(ci => ci.buzzer !== buzzerNum);
            
            // Remove buzzer from used set
            usedBuzzers.delete(buzzerNum);
            
            saveData();
            renderCheckInTable();
            pendingCheckoutIndex = null;
            
            // Reset confirmation modal text
            document.querySelector('#confirm-content p').textContent = 
                'This will check out the selected child.';
        }

        // ‚îÄ‚îÄ‚îÄ Admin actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function requestAdminAction(action, index) {
            pendingAction = {
                action,
                index
            };
            showAdminPasswordModal();
        }

        let adminPin = '';

        // ‚îÄ‚îÄ Secure PIN hashing (SHA-256 via Web Crypto API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // The real PIN never travels over the network ‚Äî only its hash is stored
        // and only the hash of what's typed is compared.
        // hashPin uses a per-installation random salt stored in Firestore (never in source).
        // The salt is read alongside passwordHash on every verify/change operation.
        async function hashPin(pin, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Generate a cryptographically random salt (32 bytes = 64 hex chars)
        function generateSalt() {
            const arr = new Uint8Array(32);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ‚îÄ‚îÄ PIN brute-force lockout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Lockout is tracked SERVER-SIDE in Firestore so incognito/DevTools cannot reset it.
        // localStorage is only used as a UI cache to avoid a Firestore round-trip on every
        // button press; the authoritative check always happens server-side in checkAdminPassword.
        const PIN_MAX_ATTEMPTS = 5;
        const PIN_LOCKOUT_MS   = 5 * 60 * 1000; // 5 minutes

        async function getPinLockoutState() {
            try {
                const lockoutRef = window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'pinLockout');
                const snap = await window.getDoc(lockoutRef);
                if (!snap.exists()) return { attempts: 0, lockedUntil: 0 };
                const d = snap.data();
                return { attempts: d.attempts || 0, lockedUntil: d.lockedUntil || 0 };
            } catch (e) {
                // If we can't read it, allow through (avoids locking out on network error)
                return { attempts: 0, lockedUntil: 0 };
            }
        }

        async function incrementPinAttempts() {
            try {
                const lockoutRef = window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'pinLockout');
                const snap = await window.getDoc(lockoutRef);
                const current = snap.exists() ? (snap.data().attempts || 0) : 0;
                const newAttempts = current + 1;
                const lockedUntil = newAttempts >= PIN_MAX_ATTEMPTS ? Date.now() + PIN_LOCKOUT_MS : 0;
                await window.setDoc(lockoutRef, { attempts: newAttempts, lockedUntil }, { merge: true });
                return newAttempts;
            } catch (e) {
                console.error('Could not update PIN lockout:', e);
                return 0;
            }
        }

        async function resetPinAttempts() {
            try {
                const lockoutRef = window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'pinLockout');
                await window.setDoc(lockoutRef, { attempts: 0, lockedUntil: 0 }, { merge: true });
            } catch (e) {
                console.error('Could not reset PIN lockout:', e);
            }
        }

        function showAdminPasswordModal() {
            // firealexusa is the master admin ‚Äî skip PIN entirely
            if (window.currentUserEmail === 'firealexusa@gmail.com') {
                // Simulate a successful PIN verification directly
                document.getElementById('admin-password-modal').classList.add('hidden');
                adminPin = '';
                if (window.pendingViewCheckIns) {
                    window.pendingViewCheckIns = false;
                    showViewCheckIns();
                    return;
                }
                if (!pendingAction) {
                    show('admin-content');
                    updateDisplays();
                    return;
                }
                const { action, index } = pendingAction;
                pendingAction = null;
                if (action === 'checkout') { finalizeCheckout(); return; }
                if (action === 'add-child-to-buzzer') { showAddChildForm(); return; }
                if (action === 'show-phone') {
                    const rows = document.querySelectorAll('#checkin-table tbody tr');
                    if (rows[index]) rows[index].classList.add('phone-revealed');
                }
                return;
            }
            adminPin = '';
            updatePinDisplay();
            openModal('admin-password-modal');
        }

        function closeAdminPasswordModal() {
            closeModal('admin-password-modal');
            adminPin = '';
        }

        function addPinDigit(digit) {
            // UI-only quick check from a cached value (real check is in checkAdminPassword)
            if (adminPin.length < 4) {
                adminPin += digit;
                updatePinDisplay();
                
                // Auto-check when 4 digits entered (iPhone style)
                if (adminPin.length === 4) {
                    setTimeout(checkAdminPassword, 200);
                }
            }
        }

        function deletePinDigit() {
            adminPin = adminPin.slice(0, -1);
            updatePinDisplay();
        }

        function clearPin() {
            adminPin = '';
            updatePinDisplay();
        }

        function updatePinDisplay() {
            const display = document.getElementById('pin-display');
            if (adminPin.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = '‚óè'.repeat(adminPin.length);
            }
        }

        async function checkAdminPassword() {
            const entered = adminPin;

            try {
                const settingsRef = window.firebaseDB ? window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin') : null;
                if (!settingsRef) {
                    showCenteredAlert('Error', 'Firebase not initialized');
                    return;
                }

                // ‚îÄ‚îÄ Server-side lockout check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const lockState = await getPinLockoutState();
                if (lockState.lockedUntil && Date.now() < lockState.lockedUntil) {
                    const secsLeft = Math.ceil((lockState.lockedUntil - Date.now()) / 1000);
                    const minsLeft = Math.ceil(secsLeft / 60);
                    adminPin = '';
                    updatePinDisplay();
                    document.getElementById('admin-password-modal').classList.add('hidden');
                    showCenteredAlert('Too many attempts', `Locked out for ${minsLeft} more minute(s). This lockout cannot be bypassed.`);
                    return;
                }

                const settingsSnap = await window.getDoc(settingsRef);

                // Read salt from Firestore ‚Äî never use the hardcoded source salt
                const d = settingsSnap.exists() ? settingsSnap.data() : {};
                let salt = d.pinSalt || null;

                let storedHash = null;
                if (d.passwordHash) {
                    storedHash = d.passwordHash;
                } else if (d.password) {
                    // Migrate legacy plaintext: generate new salt + hash, remove plaintext
                    salt = generateSalt();
                    storedHash = await hashPin(d.password, salt);
                    await window.setDoc(settingsRef, { passwordHash: storedHash, pinSalt: salt });
                }

                // First-ever run ‚Äî default PIN 0000, generate fresh salt
                if (!storedHash) {
                    salt = generateSalt();
                    storedHash = await hashPin('0000', salt);
                    await window.setDoc(settingsRef, { passwordHash: storedHash, pinSalt: salt });
                }

                // If somehow salt is still missing (old install pre-this-fix), generate and re-hash
                // This is a one-time migration ‚Äî after this the salt is always in Firestore
                if (!salt) {
                    salt = generateSalt();
                    // We can't re-hash the stored hash, so reset to 0000 and notify
                    storedHash = await hashPin('0000', salt);
                    await window.setDoc(settingsRef, { passwordHash: storedHash, pinSalt: salt });
                    showCenteredAlert('Security upgrade', 'PIN salt upgraded. PIN has been reset to 0000 ‚Äî please change it immediately.');
                    adminPin = '';
                    updatePinDisplay();
                    return;
                }

                // Hash what the user typed using the Firestore salt
                const enteredHash = await hashPin(entered, salt);

                if (enteredHash !== storedHash) {
                    const newAttempts = await incrementPinAttempts();
                    adminPin = '';
                    updatePinDisplay();
                    if (newAttempts >= PIN_MAX_ATTEMPTS) {
                        document.getElementById('admin-password-modal').classList.add('hidden');
                        showCenteredAlert('Too many attempts', 'Locked out for 5 minutes. This lockout is server-side and cannot be bypassed.');
                    } else {
                        showCenteredAlert('Incorrect PIN', `Access Denied (${PIN_MAX_ATTEMPTS - newAttempts} attempts remaining)`);
                    }
                    return;
                }

                // Correct PIN ‚Äî reset server-side lockout
                await resetPinAttempts();
                document.getElementById('admin-password-modal').classList.add('hidden');
                adminPin = '';
                
                // Check if this was for View Check-Ins
                if (window.pendingViewCheckIns) {
                    window.pendingViewCheckIns = false;
                    showViewCheckIns();
                    return;
                }
                
                if (!pendingAction) {
                    show('admin-content');
                    updateDisplays();
                    return;
                }
                const { action, index } = pendingAction;
                pendingAction = null;
                if (action === 'checkout') {
                    finalizeCheckout();
                    return;
                }
                if (action === 'add-child-to-buzzer') {
                    showAddChildForm();
                    return;
                }
                if (action === 'show-phone') {
                    const rows = document.querySelectorAll('#checkin-table tbody tr');
                    if (rows[index]) rows[index].classList.add('phone-revealed');
                }
            } catch (error) {
                console.error('Error checking admin password:', error);
                adminPin = '';
                updatePinDisplay();
                showCenteredAlert('Error', 'Could not verify password');
            }
        }

        // Show/Hide Change Password Modal
        // ===== CHANGE ADMIN PASSWORD FLOW =====
        let changePasswordPin = '';
        let newPasswordValue = '';
        let confirmPasswordValue = '';
        
        // Step 1: Request current password
        function requestCurrentPasswordForChange() {
            changePasswordPin = '';
            newPasswordValue = '';
            confirmPasswordValue = '';
            updateChangePinDisplay();
            openModal('change-password-step1-modal');
        }
        
        function closeChangePasswordFlow() {
            closeModal('change-password-step1-modal');
            closeModal('change-password-step2-modal');
            closeModal('change-password-step3-modal');
            closeModal('password-confirm-modal');
            changePasswordPin = '';
            newPasswordValue = '';
            confirmPasswordValue = '';
        }
        
        function addChangePinDigit(digit) {
            if (changePasswordPin.length < 4) {
                changePasswordPin += digit;
                updateChangePinDisplay();
                
                // Auto-check when 4 digits entered
                if (changePasswordPin.length === 4) {
                    setTimeout(verifyCurrentPasswordForChange, 200);
                }
            }
        }
        
        function deleteChangePinDigit() {
            changePasswordPin = changePasswordPin.slice(0, -1);
            updateChangePinDisplay();
        }
        
        function clearChangePin() {
            changePasswordPin = '';
            updateChangePinDisplay();
        }
        
        function updateChangePinDisplay() {
            const display = document.getElementById('change-pin-display');
            if (changePasswordPin.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = '‚óè'.repeat(changePasswordPin.length);
            }
        }
        
        // New password entry functions
        function addNewPasswordDigit(digit) {
            if (newPasswordValue.length < 4) {
                newPasswordValue += digit;
                updateNewPasswordDisplay();
                
                // Auto-advance when 4 digits entered
                if (newPasswordValue.length === 4) {
                    setTimeout(() => {
                        closeModal('change-password-step2-modal');
                        openModal('change-password-step3-modal');
                    }, 200);
                }
            }
        }
        
        function deleteNewPasswordDigit() {
            newPasswordValue = newPasswordValue.slice(0, -1);
            updateNewPasswordDisplay();
        }
        
        function clearNewPassword() {
            newPasswordValue = '';
            updateNewPasswordDisplay();
        }
        
        function updateNewPasswordDisplay() {
            const display = document.getElementById('new-password-display');
            if (newPasswordValue.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = newPasswordValue; // Show actual numbers
            }
        }
        
        // Confirm password entry functions
        function addConfirmPasswordDigit(digit) {
            if (confirmPasswordValue.length < 4) {
                confirmPasswordValue += digit;
                updateConfirmPasswordDisplay();
                
                // Auto-check when 4 digits entered
                if (confirmPasswordValue.length === 4) {
                    setTimeout(validateAndConfirmPassword, 200);
                }
            }
        }
        
        function deleteConfirmPasswordDigit() {
            confirmPasswordValue = confirmPasswordValue.slice(0, -1);
            updateConfirmPasswordDisplay();
        }
        
        function clearConfirmPassword() {
            confirmPasswordValue = '';
            updateConfirmPasswordDisplay();
        }
        
        function updateConfirmPasswordDisplay() {
            const display = document.getElementById('confirm-password-display');
            if (confirmPasswordValue.length === 0) {
                display.textContent = '';
            } else {
                display.textContent = confirmPasswordValue; // Show actual numbers
            }
        }
        
        function backToNewPassword() {
            confirmPasswordValue = '';
            updateConfirmPasswordDisplay();
            closeModal('change-password-step3-modal');
            openModal('change-password-step2-modal');
        }
        
        // Verify current password
        async function verifyCurrentPasswordForChange() {
            const entered = changePasswordPin;

            try {
                const settingsRef = window.firebaseDB ? window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin') : null;
                if (!settingsRef) {
                    showCenteredAlert('Error', 'Firebase not initialized');
                    changePasswordPin = '';
                    updateChangePinDisplay();
                    return;
                }

                const settingsSnap = await window.getDoc(settingsRef);
                const d = settingsSnap.exists() ? settingsSnap.data() : {};
                const salt = d.pinSalt || null;

                let storedHash = null;
                if (d.passwordHash) {
                    storedHash = d.passwordHash;
                } else if (d.password) {
                    // Legacy migration handled in checkAdminPassword ‚Äî shouldn't reach here
                    storedHash = null;
                }

                if (!storedHash || !salt) {
                    showCenteredAlert('Error', 'PIN not set up yet. Please use the Admin PIN entry first.');
                    changePasswordPin = '';
                    updateChangePinDisplay();
                    return;
                }

                const enteredHash = await hashPin(entered, salt);

                if (enteredHash !== storedHash) {
                    changePasswordPin = '';
                    updateChangePinDisplay();
                    showCenteredAlert('Incorrect PIN', 'Current password is incorrect');
                    return;
                }

                // Password correct - move to step 2
                closeModal('change-password-step1-modal');
                openModal('change-password-step2-modal');
                changePasswordPin = '';

            } catch (error) {
                console.error('Error verifying password:', error);
                showCenteredAlert('Error', 'Could not verify password');
                changePasswordPin = '';
                updateChangePinDisplay();
            }
        }
        
        // Validate passwords match and show confirmation
        function validateAndConfirmPassword() {
            if (newPasswordValue !== confirmPasswordValue) {
                showCenteredAlert('Error', 'Passwords do not match');
                confirmPasswordValue = '';
                updateConfirmPasswordDisplay();
                return;
            }
            
            // Show confirmation modal
            openModal('password-confirm-modal');
        }
        
        function closePasswordConfirmModal() {
            closeModal('password-confirm-modal');
        }
        
        // Final step: Actually change the password ‚Äî generates new random salt + hash, never stores plaintext
        async function finalizePasswordChange() {
            try {
                const settingsRef = window.doc(window.firebaseDB, 'churches', 'bibleland2025', 'settings', 'admin');
                const newSalt = generateSalt();
                const newHash = await hashPin(newPasswordValue, newSalt);
                // Store hash + new salt ‚Äî old salt is replaced so old hash is worthless
                await window.setDoc(settingsRef, { passwordHash: newHash, pinSalt: newSalt });

                closePasswordConfirmModal();
                closeChangePasswordFlow();

                showCenteredAlert('Success! ‚úÖ', 'Admin password has been changed');
            } catch (error) {
                console.error('Error changing password:', error);
                showCenteredAlert('Error', 'Could not change password');
            }
        }
        
        // Old functions - keeping for compatibility (can be removed if not used elsewhere)
        function showChangePasswordModal() {
            requestCurrentPasswordForChange();
        }
        
        function closeChangePasswordModal() {
            closeChangePasswordFlow();
        }
        
        async function verifyCurrentPassword() {
            await verifyCurrentPasswordForChange();
        }
        
        function confirmNewPassword() {
            validateAndConfirmPassword();
        }
        
        function confirmNewPasswordChange() {
            validateAndConfirmPassword();
        }

        // ‚îÄ‚îÄ‚îÄ Get upcoming Sundays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getUpcomingSundays(count) {
            const sundays = [];
            const today = new Date();
            let current = new Date(today);
            
            // Find next Sunday
            const dayOfWeek = current.getDay();
            const daysUntilSunday = dayOfWeek === 0 ? 7 : 7 - dayOfWeek;
            current.setDate(current.getDate() + daysUntilSunday);
            
            for (let i = 0; i < count; i++) {
                const month = String(current.getMonth() + 1).padStart(2, '0');
                const day = String(current.getDate()).padStart(2, '0');
                const year = current.getFullYear();
                sundays.push(`${month}/${day}/${year}`);
                current.setDate(current.getDate() + 7);
            }
            
            return sundays;
        }

        // ‚îÄ‚îÄ‚îÄ Admin volunteer schedule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDisplays() {
            // Update stats
            document.getElementById('stat-checked-in').textContent = checkIns.length;
            
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) {
                    slots.forEach(vol => uniqueVols.set(vol.phone, vol));
                }
            });
            (volunteers.all || []).forEach(vol => uniqueVols.set(vol.phone, vol));
            document.getElementById('stat-volunteers').textContent = uniqueVols.size;
            
            const sundays = getUpcomingSundays(13);
            let openings = 0;
            sundays.forEach(date => {
                // Use service-specific key
                const serviceKey = `${date}_${window.currentService}`;
                const slots = volunteers[serviceKey] || [];
                openings += (3 - slots.length);
            });
            document.getElementById('stat-upcoming').textContent = openings;

            // ‚îÄ‚îÄ Render schedule table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const schedBody = document.querySelector('#admin-schedule-table tbody');
            schedBody.innerHTML = '';

            // Update service label
            const schedLabel = document.getElementById('sched-service-label');
            if (schedLabel) {
                const svcName = window.currentService === 'russian' ? 'üá∑üá∫ Russian (9 AM)' : 'üá∫üá∏ English (12 PM)';
                schedLabel.textContent = svcName;
            }

            // Sort supervisorDatabase entries by last name for the dropdowns
            const sortedSupEntries = Object.entries(supervisorDatabase).sort((a, b) =>
                (a[1].lastName || '').localeCompare(b[1].lastName || ''));

            function volCell(vol, date, idx) {
                if (!vol) {
                    return `<button class="db-btn assign" onclick="toggleAddVolunteerForm('${escapeHtml(date)}')" title="Add volunteer" style="width:100%;padding:4px 6px;font-size:0.75rem;">Ôºã Add</button>`;
                }
                return `<div style="display:flex;align-items:center;justify-content:space-between;gap:4px;">
                    <div><span class="vol-name">${escapeHtml(vol.name)}</span><br><span class="vol-phone">${escapeHtml(formatPhoneDisplay(vol.phone))}</span></div>
                    <button class="db-btn del" onclick="removeVolunteerFromDate('${escapeHtml(date)}', ${idx})" title="Remove" style="flex-shrink:0;">üóë</button>
                </div>`;
            }

            sundays.forEach(date => {
                const serviceKey = `${date}_${window.currentService}`;
                const slots = volunteers[serviceKey] || [];
                const supervisor = scheduledSupervisors[serviceKey] || null;
                const supervisorHelper = scheduledSupervisorHelpers[serviceKey] || null;

                const statusClass = slots.length === 3 ? 'status-full' : slots.length === 0 ? 'status-open' : 'status-part';
                const statusText = slots.length === 3 ? 'Full' : slots.length === 0 ? 'Need 3' : `${slots.length}/3`;

                const supOpts = sortedSupEntries.map(([ph, s]) =>
                    `<option value="${ph}" ${supervisor && supervisor.phone === ph ? 'selected' : ''}>${s.lastName}, ${s.firstName}</option>`
                ).join('');
                const helpOpts = sortedSupEntries.map(([ph, s]) =>
                    `<option value="${ph}" ${supervisorHelper && supervisorHelper.phone === ph ? 'selected' : ''}>${s.lastName}, ${s.firstName}</option>`
                ).join('');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="date-cell">
                        ${date}<br>
                        <span class="status-pill ${statusClass}">${statusText}</span>
                    </td>
                    <td class="vol-cell">${volCell(slots[0], date, 0)}</td>
                    <td class="vol-cell">${volCell(slots[1] !== undefined ? slots[1] : null, date, 1)}</td>
                    <td class="vol-cell">${volCell(slots[2] !== undefined ? slots[2] : null, date, 2)}</td>
                    <td class="sup-cell">
                        <select class="sched-select" onchange="assignSupervisor('${date}', this.value)">
                            <option value="">‚Äî None ‚Äî</option>${supOpts}
                        </select>
                    </td>
                    <td class="sup-cell">
                        <select class="sched-select" onchange="assignSupervisorHelper('${date}', this.value)">
                            <option value="">‚Äî None ‚Äî</option>${helpOpts}
                        </select>
                    </td>`;
                schedBody.appendChild(tr);

                // Inline add-volunteer form row (hidden by default)
                if (slots.length < 3) {
                    const formTr = document.createElement('tr');
                    formTr.id = `add-vol-form-row-${date}`;
                    formTr.className = 'hidden';
                    formTr.style.background = '#f8fbff';
                    formTr.innerHTML = `
                        <td colspan="6" style="padding:0;">
                            <div class="sched-add-form">
                                <label>Phone: <input type="tel" id="add-vol-phone-${date}" placeholder="(000) 000-0000" inputmode="none" maxlength="14" oninput="formatPhone(this)" style="width:150px;"></label>
                                <label>Name: <input type="text" id="add-vol-name-${date}" placeholder="First Last" style="width:160px;"></label>
                                <button class="db-btn assign" onclick="addVolunteerToDate('${date}')" style="width:auto;padding:4px 10px;font-size:0.78rem;">Save</button>
                                <button class="db-btn edit" onclick="toggleAddVolunteerForm('${date}')" style="width:auto;padding:4px 10px;font-size:0.78rem;">Cancel</button>
                            </div>
                        </td>`;
                    schedBody.appendChild(formTr);
                }
            });

            // Render volunteer database
            renderVolunteerDatabase();
            
            // Render family database
            renderFamilyDatabase();
            
            // Render supervisor database
            renderSupervisorDatabase();
            
            // Render reports
            renderReports();

            // Render parental contracts
            renderContractsTable();
        }

        function formatPhoneDisplay(phone) {
            if (phone.length === 10) {
                return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6)}`;
            }
            return phone;
        }

        function removeVolunteerFromDate(date, index) {
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            let slots = volunteers[serviceKey] || [];
            if (!slots[index]) return;
            
            const volName = slots[index].name;
            
            showConfirmModal(
                `Remove ${volName} from ${date}?`,
                'Confirm Delete',
                () => {
                    slots.splice(index, 1);
                    volunteers[serviceKey] = slots;
                    saveData();
                    updateDisplays();
                }
            );
        }

        function toggleAddVolunteerForm(date) {
            const formRow = document.getElementById(`add-vol-form-row-${date}`);
            if (formRow) {
                formRow.classList.toggle('hidden');
                // Setup numpad for phone input when form is shown
                if (!formRow.classList.contains('hidden')) {
                    setTimeout(setupPhoneInputs, 50);
                }
            }
        }

        function addVolunteerToDate(date) {
            const nameInput = document.getElementById(`add-vol-name-${date}`);
            const phoneInput = document.getElementById(`add-vol-phone-${date}`);
            const name = nameInput.value.trim();
            const phone = phoneInput.value.replace(/\D/g, '').trim();
            if (!name || phone.length !== 10) {
                showCenteredAlert("Please enter full name and valid 10-digit phone number.");
                return;
            }
            
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            
            // Check if already scheduled for this date
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                showCenteredAlert("This person is already scheduled for this date!");
                return;
            }
            
            if (volunteers[serviceKey].length >= 2) {
                showCenteredAlert("This date is already full.");
                return;
            }
            const vol = {
                name,
                phone,
                service: window.currentService
            };
            volunteers[serviceKey].push(vol);
            addToVolunteerAllIfNotExists(vol);
            saveData();
            nameInput.value = '';
            phoneInput.value = '';
            toggleAddVolunteerForm(date);
            updateDisplays();
        }

        function renderVolunteerDatabase(filter) {
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) slots.forEach(v => uniqueVols.set(v.phone, v));
            });
            (volunteers.all || []).forEach(v => uniqueVols.set(v.phone, v));

            const container = document.getElementById('volunteer-database-content');
            const q = (filter !== undefined ? filter : (document.getElementById('vol-search')?.value || '')).toLowerCase().trim();

            let rows = [...uniqueVols.values()];
            // Sort alphabetically by last name
            rows.sort((a, b) => {
                const la = (a.name || '').trim().split(' ').pop().toLowerCase();
                const lb = (b.name || '').trim().split(' ').pop().toLowerCase();
                return la.localeCompare(lb);
            });
            if (q) rows = rows.filter(v => v.name.toLowerCase().includes(q) || v.phone.includes(q));

            const sundays = getUpcomingSundays(13);
            const countEl = document.getElementById('vol-db-count');
            if (countEl) countEl.textContent = rows.length + ' record' + (rows.length !== 1 ? 's' : '');

            if (rows.length === 0) {
                container.querySelector('.db-table-wrap').innerHTML = '<div class="db-empty">No volunteers found</div>';
                return;
            }

            let html = '<table class="db-table"><thead><tr><th>Name</th><th>Phone</th><th></th></tr></thead><tbody>';
            rows.forEach(vol => {
                const parts = (vol.name || '').trim().split(' ');
                const last = parts.length > 1 ? parts.pop() : '';
                const first = parts.join(' ');
                const displayName = last ? `${last}, ${first}` : first;
                html += `<tr>
                    <td class="name-cell">${escapeHtml(displayName)}</td>
                    <td class="phone-cell-db">${escapeHtml(formatPhoneDisplay(vol.phone))}</td>
                    <td class="actions-cell">
                        <button class="db-btn edit" onclick="editVolunteerInfo('${escapeHtml(vol.phone)}')" title="Edit">‚úèÔ∏è</button>
                        <button class="db-btn del"  onclick="deleteVolunteerFromDatabase('${escapeHtml(vol.phone)}')" title="Delete">üóë</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.querySelector('.db-table-wrap').innerHTML = html;
        }

        function editVolunteerName(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;

            const alertModal = document.getElementById('centered-alert');
            const alertContent = alertModal.querySelector('.centered-modal-content');
            const originalHTML = alertContent.innerHTML;

            alertContent.innerHTML = `
                <h3>Edit Volunteer Name</h3>
                <div style="margin: 20px 0;">
                    <input type="text" id="edit-vol-name-only" value="${escapeHtml(vol.name)}" placeholder="Full Name"
                        style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                </div>
                <button class="btn-success" id="save-vol-name-btn" style="margin-right: 8px;">Save</button>
                <button class="btn-outline" id="cancel-vol-name-btn">Cancel</button>
            `;
            openModal(alertModal);
            setTimeout(() => document.getElementById('edit-vol-name-only').focus(), 50);

            document.getElementById('save-vol-name-btn').onclick = () => {
                const newName = document.getElementById('edit-vol-name-only').value.trim();
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
                if (newName && newName !== vol.name) {
                    updateAllVolunteers(phone, 'name', newName);
                }
            };
            document.getElementById('edit-vol-name-only').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('save-vol-name-btn').click();
            });
            document.getElementById('cancel-vol-name-btn').onclick = () => {
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
            };
        }

        function editVolunteerInfo(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            // Create custom edit modal
            const alertModal = document.getElementById('centered-alert');
            const alertContent = alertModal.querySelector('.centered-modal-content');
            const originalHTML = alertContent.innerHTML;
            
            alertContent.innerHTML = `
                <h3>Edit Volunteer</h3>
                <div style="margin: 20px 0;">
                    <input type="tel" id="edit-vol-phone" value="${formatPhoneDisplay(vol.phone)}" placeholder="(000) 000-0000" inputmode="none" oninput="formatPhone(this)" maxlength="14" style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                    <input type="text" id="edit-vol-name" value="${vol.name}" placeholder="Full Name" style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem;">
                </div>
                <button class="btn-success" id="save-vol-edit">Save</button>
                <button class="btn-outline" id="cancel-vol-edit">Cancel</button>
            `;
            
            openModal(alertModal);
            
            // Setup numpad for the phone input
            setTimeout(setupPhoneInputs, 50);
            
            document.getElementById('save-vol-edit').onclick = () => {
                const newName = document.getElementById('edit-vol-name').value.trim();
                const newPhone = document.getElementById('edit-vol-phone').value.replace(/\D/g, '');
                
                if (!newName || newPhone.length !== 10) {
                    alertContent.innerHTML = originalHTML;
                    closeModal(alertModal);
                    showCenteredAlert('Please enter valid name and 10-digit phone number');
                    return;
                }
                
                // Check if new phone already exists (and it's not the same volunteer)
                if (newPhone !== phone && getVolunteerByPhone(newPhone)) {
                    alertContent.innerHTML = originalHTML;
                    closeModal(alertModal);
                    showCenteredAlert('This phone number already exists in the database');
                    return;
                }
                
                // Update name if changed
                if (newName !== vol.name) {
                    updateAllVolunteers(phone, 'name', newName);
                }
                
                // Update phone if changed
                if (newPhone !== phone) {
                    updateAllVolunteers(phone, 'phone', newPhone);
                }
                
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
                updateDisplays();
            };
            
            document.getElementById('cancel-vol-edit').onclick = () => {
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
            };
        }

        function editVolunteerPhone(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;

            const alertModal = document.getElementById('centered-alert');
            const alertContent = alertModal.querySelector('.centered-modal-content');
            const originalHTML = alertContent.innerHTML;

            alertContent.innerHTML = `
                <h3>Edit Phone Number</h3>
                <div style="margin: 20px 0;">
                    <input type="tel" id="edit-vol-phone-only" value="${formatPhoneDisplay(phone)}" placeholder="(000) 000-0000"
                        inputmode="none" oninput="formatPhone(this)" maxlength="14"
                        style="width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                </div>
                <button class="btn-success" id="save-vol-phone-btn" style="margin-right: 8px;">Save</button>
                <button class="btn-outline" id="cancel-vol-phone-btn">Cancel</button>
            `;
            openModal(alertModal);
            setTimeout(setupPhoneInputs, 50);

            document.getElementById('save-vol-phone-btn').onclick = () => {
                const newPhone = document.getElementById('edit-vol-phone-only').value.replace(/\D/g, '');
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
                if (newPhone.length === 10 && newPhone !== phone) {
                    if (getVolunteerByPhone(newPhone)) {
                        showCenteredAlert('This phone number already exists in the database.');
                        return;
                    }
                    updateAllVolunteers(phone, 'phone', newPhone);
                }
            };
            document.getElementById('edit-vol-phone-only').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('save-vol-phone-btn').click();
            });
            document.getElementById('cancel-vol-phone-btn').onclick = () => {
                alertContent.innerHTML = originalHTML;
                closeModal(alertModal);
            };
        }

        function deleteVolunteerFromDatabase(phone) {
            const vol = getVolunteerByPhone(phone);
            if (!vol) return;
            
            showConfirmModal(
                `Remove ${vol.name} from database and all schedules?`,
                'Confirm Delete',
                () => {
                    if (volunteers.all) {
                        volunteers.all = volunteers.all.filter(v => v.phone !== phone);
                    }
                    Object.keys(volunteers).forEach(date => {
                        if (Array.isArray(volunteers[date])) {
                            volunteers[date] = volunteers[date].filter(v => v.phone !== phone);
                        }
                    });
                    saveData();
                    updateDisplays();
                }
            );
        }

        function getVolunteerByPhone(phone) {
            let vol = volunteers.all?.find(v => v.phone === phone);
            if (vol) return vol;
            for (const slots of Object.values(volunteers)) {
                if (Array.isArray(slots)) {
                    vol = slots.find(v => v.phone === phone);
                    if (vol) return vol;
                }
            }
            return null;
        }

        function toggleAddToDatabaseForm() {
            document.getElementById('add-to-db-form').classList.toggle('hidden');
        }

        function addToVolunteerDatabase() {
            const name = document.getElementById('db-vol-name').value.trim();
            const phoneFormatted = document.getElementById('db-vol-phone').value;
            const phone = phoneFormatted.replace(/\D/g, '').trim();
            if (!name || phone.length !== 10) {
                showCenteredAlert("Please enter full name and valid 10-digit phone number.");
                return;
            }
            const uniqueVols = new Map();
            Object.values(volunteers).forEach(slots => {
                if (Array.isArray(slots)) {
                    slots.forEach(vol => uniqueVols.set(vol.phone, vol));
                }
            });
            (volunteers.all || []).forEach(vol => uniqueVols.set(vol.phone, vol));
            if (uniqueVols.has(phone)) {
                showCenteredAlert("Volunteer with this phone already exists.");
                return;
            }
            if (!volunteers.all) volunteers.all = [];
            volunteers.all.push({
                name,
                phone
            });
            saveData();
            document.getElementById('db-vol-name').value = '';
            document.getElementById('db-vol-phone').value = '';
            toggleAddToDatabaseForm();
            updateDisplays();
        }

        function updateAllVolunteers(phone, field, value) {
            if (volunteers.all) {
                volunteers.all = volunteers.all.map(v => v.phone === phone ? {
                    ...v,
                    [field]: value
                } : v);
            }
            Object.keys(volunteers).forEach(date => {
                if (Array.isArray(volunteers[date])) {
                    volunteers[date] = volunteers[date].map(v => v.phone === phone ? {
                        ...v,
                        [field]: value
                    } : v);
                }
            });
            saveData();
            updateDisplays();
        }

        function addToVolunteerAllIfNotExists(vol) {
            // Never auto-add supervisors to volunteer database
            if (supervisorDatabase[vol.phone]) return;
            if (!volunteers.all) volunteers.all = [];
            const exists = volunteers.all.some(v => v.phone === vol.phone);
            if (!exists) {
                volunteers.all.push({ name: vol.name, phone: vol.phone });
            }
        }

        function assignVolunteerToDate(phone) {
            const select = document.getElementById(`assign-date-${phone}`);
            const date = select.value;
            const vol = getVolunteerByPhone(phone);
            if (!vol) {
                showCenteredAlert("Volunteer not found.");
                return;
            }
            
            // Use service-specific key: "date_service" (e.g., "02/15/2026_russian")
            const serviceKey = `${date}_${window.currentService}`;
            
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                showCenteredAlert("This volunteer is already assigned to this date.");
                return;
            }
            if (volunteers[serviceKey].length >= 2) {
                showCenteredAlert("This date is already full (2 volunteers). Delete someone first.");
                return;
            }
            volunteers[serviceKey].push({
                name: vol.name,
                phone: vol.phone,
                service: window.currentService
            });
            saveData();
            showCenteredAlert(`Assigned ${vol.name} to ${date}!`, 'Success');
            updateDisplays();
        }

        // ‚îÄ‚îÄ‚îÄ Family Database Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showAddFamilyModal() {
            // Redirect to check-in with non-member option
            showScreen('checkin-screen');
            document.getElementById('nonmem-btn').click();
        }

        function renderFamilyDatabase(filter) {
            const container = document.getElementById('family-database-content');
            const q = (filter !== undefined ? filter : (document.getElementById('fam-search')?.value || '')).toLowerCase().trim();

            let entries = Object.entries(familyDatabase);
            // Sort by last name
            entries.sort((a, b) => {
                const la = (a[1].lastName || '').toLowerCase();
                const lb = (b[1].lastName || '').toLowerCase();
                return la.localeCompare(lb);
            });
            if (q) entries = entries.filter(([phone, f]) => {
                const name = ((f.firstName || '') + ' ' + (f.lastName || '')).toLowerCase();
                return name.includes(q) || phone.includes(q);
            });

            const countEl = document.getElementById('fam-db-count');
            if (countEl) countEl.textContent = entries.length + ' record' + (entries.length !== 1 ? 's' : '');

            if (entries.length === 0) {
                container.querySelector('.db-table-wrap').innerHTML = '<div class="db-empty">No families found</div>';
                return;
            }

            let html = '<table class="db-table"><thead><tr><th>Name</th><th>Phone</th><th>Type</th><th>Children</th><th></th></tr></thead><tbody>';
            entries.forEach(([phone, f]) => {
                const kids = Array.isArray(f.kids) ? f.kids : (Array.isArray(f) ? f : []);
                const type = f.type || 'nonmember';
                const fname = f.firstName || '';
                const lname = f.lastName || '';
                const displayName = lname ? `${lname}, ${fname}` : fname;
                const kidsHtml = kids.map(k =>
                    `${escapeHtml(k.name)} (${escapeHtml(k.age)})${k.allergies && k.allergies !== 'None' ? ' <span class="db-badge allergy">‚ö† ' + escapeHtml(k.allergies) + '</span>' : ''}`
                ).join(' ¬∑ ');
                html += `<tr>
                    <td class="name-cell">${escapeHtml(displayName)}</td>
                    <td class="phone-cell-db">${escapeHtml(formatPhoneDisplay(phone))}</td>
                    <td class="badge-cell"><span class="db-badge ${escapeHtml(type)}">${type === 'member' ? 'Member' : 'Non-Member'}</span></td>
                    <td class="db-kids-cell">${kidsHtml || '<span style="color:#ccc">‚Äî</span>'}</td>
                    <td class="actions-cell">
                        <button class="db-btn edit" onclick="editFamily('${escapeHtml(phone)}')" title="Edit">‚úèÔ∏è</button>
                        <button class="db-btn del"  onclick="deleteFamily('${escapeHtml(phone)}')" title="Delete" style="margin-left:3px;">üóë</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.querySelector('.db-table-wrap').innerHTML = html;
        }

        function toggleFamilyType(phone) {
            if (!familyDatabase[phone]) return;
            
            const familyData = familyDatabase[phone];
            const currentType = familyData.type || 'nonmember';
            const newType = currentType === 'member' ? 'nonmember' : 'member';
            
            showConfirmModal(
                `Change ${formatPhoneDisplay(phone)} to ${newType === 'member' ? 'Member' : 'Non-Member'}?`,
                'Confirm Change',
                () => {
                    // Update type
                    if (Array.isArray(familyData)) {
                        // Old format - convert to new format
                        familyDatabase[phone] = {
                            type: newType,
                            kids: familyData
                        };
                    } else {
                        // New format - just update type
                        familyDatabase[phone].type = newType;
                    }
                    saveData();
                    renderFamilyDatabase();
                }
            );
        }

        function editFamily(phone) {
            if (!familyDatabase[phone]) return;
            // Remove any stale dynamic modal first
            const _dm = document.querySelector('.success-modal.dynamic-modal'); if(_dm) removeDynamicModal(_dm);
            
            const family = familyDatabase[phone];
            const firstName = family.firstName || '';
            const lastName = family.lastName || '';
            const type = family.type || 'nonmember';
            const typeDisplay = type === 'member' ? 'Member' : 'Non-Member';
            const kids = family.kids || [];
            
            let kidsHTML = '';
            kids.forEach((kid, index) => {
                kidsHTML += `
                    <div style="background: #f8fbff; padding: 12px; margin: 8px 0; border-radius: 8px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <label>Name: <input type="text" id="edit-kid-name-${index}" value="${escapeHtml(kid.name)}" style="width: 200px; padding: 6px;"></label>
                                <label style="margin-left: 12px;">Age: <input type="number" id="edit-kid-age-${index}" value="${escapeHtml(kid.age)}" min="1" max="18" style="width: 80px; padding: 6px;"></label>
                            </div>
                            <button class="btn-icon btn-delete" onclick="removeChildFromEditModal(${index})" title="Remove child" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                        </div>
                        <div>
                            <label>Allergies: <input type="text" id="edit-kid-allergies-${index}" value="${escapeHtml(kid.allergies || 'None')}" style="width: 300px; padding: 6px;"></label>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'success-modal dynamic-modal';
            modal.innerHTML = `
                <div class="success-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h2>Edit Family</h2>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label>First Name: <input type="text" id="edit-first-name" value="${escapeHtml(firstName)}" style="width: 200px; padding: 8px;"></label>
                            <label style="margin-left: 12px;">Last Name: <input type="text" id="edit-last-name" value="${escapeHtml(lastName)}" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>Phone: <input type="tel" id="edit-phone" value="${escapeHtml(formatPhoneDisplay(phone))}" inputmode="none" maxlength="14" style="width: 200px; padding: 8px;"></label>
                            <label style="margin-left: 12px;">Type: 
                                <select id="edit-type" style="width: 150px; padding: 8px;">
                                    <option value="member" ${type === 'member' ? 'selected' : ''}>Member</option>
                                    <option value="nonmember" ${type === 'nonmember' ? 'selected' : ''}>Non-Member</option>
                                </select>
                            </label>
                        </div>
                        <h3>Children:</h3>
                        <div id="edit-kids-list">${kidsHTML}</div>
                        <button class="btn-outline" onclick="addChildToFamily('${phone}')" style="margin-top: 12px; width: 100%;">‚ûï Add Child</button>
                    </div>
                    <button class="btn-success" onclick="saveEditFamily('${phone}')">Save Changes</button>
                    <button class="btn-outline" onclick="closeDynamicModal(this)">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            openModal(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
        }

        function removeChildFromEditModal(index) {
            const kidsList = document.getElementById('edit-kids-list');
            const childDivs = kidsList.querySelectorAll('div[style*="background: #f8fbff"]');
            if (childDivs[index]) {
                childDivs[index].remove();
            }
        }

        function addChildToFamily(phone) {
            const kidsList = document.getElementById('edit-kids-list');
            const currentKidsCount = kidsList.querySelectorAll('div[style*="background: #f8fbff"]').length;
            const newIndex = currentKidsCount;
            
            const newKidHTML = `
                <div style="background: #f8fbff; padding: 12px; margin: 8px 0; border-radius: 8px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <label>Name: <input type="text" id="edit-kid-name-${newIndex}" value="" placeholder="Child Name" style="width: 200px; padding: 6px;"></label>
                            <label style="margin-left: 12px;">Age: <input type="number" id="edit-kid-age-${newIndex}" value="5" min="1" max="18" style="width: 80px; padding: 6px;"></label>
                        </div>
                        <button class="btn-icon btn-delete" onclick="removeChildFromEditModal(${newIndex})" title="Remove child" style="font-size: 0.85rem; padding: 4px 8px;">üóëÔ∏è</button>
                    </div>
                    <div>
                        <label>Allergies: <input type="text" id="edit-kid-allergies-${newIndex}" value="None" style="width: 300px; padding: 6px;"></label>
                    </div>
                </div>
            `;
            
            kidsList.insertAdjacentHTML('beforeend', newKidHTML);
        }

        function saveEditFamily(oldPhone) {
            const newFirstName = document.getElementById('edit-first-name').value.trim();
            const newLastName = document.getElementById('edit-last-name').value.trim();
            const newPhoneFormatted = document.getElementById('edit-phone').value;
            const newPhone = newPhoneFormatted.replace(/\D/g, '');
            const newType = document.getElementById('edit-type').value;
            
            if (!newFirstName || !newLastName || newPhone.length !== 10) {
                showCenteredAlert('Please enter valid first name, last name, and 10-digit phone number');
                return;
            }
            
            // Collect ALL kids from the form (including newly added ones)
            const updatedKids = [];
            const kidsList = document.getElementById('edit-kids-list');
            const kidDivs = kidsList.querySelectorAll('div[style*="background: #f8fbff"]');
            
            kidDivs.forEach((kidDiv, index) => {
                const nameInput = document.getElementById(`edit-kid-name-${index}`);
                const ageInput = document.getElementById(`edit-kid-age-${index}`);
                const allergiesInput = document.getElementById(`edit-kid-allergies-${index}`);
                
                if (nameInput && ageInput && allergiesInput && nameInput.value.trim()) {
                    updatedKids.push({
                        name: nameInput.value.trim(),
                        age: parseInt(ageInput.value),
                        allergies: allergiesInput.value.trim()
                    });
                }
            });
            
            // If phone changed, delete old entry and clear old auto-fill
            if (oldPhone !== newPhone) {
                delete familyDatabase[oldPhone];
                if (parents[oldPhone]) {
                    delete parents[oldPhone];
                }
            }
            
            // Save updated family
            familyDatabase[newPhone] = {
                type: newType,
                firstName: newFirstName,
                lastName: newLastName,
                kids: updatedKids
            };
            
            saveData();
            renderFamilyDatabase();
            const dynModal = document.querySelector('.success-modal.dynamic-modal');
            if (dynModal) removeDynamicModal(dynModal);
        }

        function deleteFamily(phone) {
            if (!familyDatabase[phone]) return;
            
            const family = familyDatabase[phone];
            const name = `${family.firstName || ''} ${family.lastName || ''}`.trim();
            
            showConfirmModal(
                `Delete entire family record for ${name} (${formatPhoneDisplay(phone)})?`,
                'Confirm Delete',
                async () => {
                    // 1. Remove from familyDatabase ‚Äî no auto-fill on next check-in
                    delete familyDatabase[phone];

                    // 2. Remove from parents map ‚Äî clears any cached parent data
                    if (parents[phone]) {
                        delete parents[phone];
                    }

                    // 3. Save locally + queue Firebase sync via saveData()
                    //    saveData() calls flushToCloud() which rewrites the entire
                    //    shared Firestore doc without this family ‚Äî permanent deletion.
                    saveData();

                    // 4. Re-render immediately so UI reflects the deletion
                    renderFamilyDatabase();

                    console.log(`‚úÖ Family deleted: ${name} (${phone})`);
                }
            );
        }

        function deleteKidFromFamily(phone, kidIndex) {
            if (!familyDatabase[phone]) return;
            
            const familyData = familyDatabase[phone];
            const kids = familyData.kids || familyData;
            
            if (!kids[kidIndex]) return;
            
            const kid = kids[kidIndex];
            
            showConfirmModal(
                `Delete ${kid.name} from family ${formatPhoneDisplay(phone)}?`,
                'Confirm Delete',
                () => {
                    kids.splice(kidIndex, 1);
                    
                    // If no kids left, delete the family entry
                    if (kids.length === 0) {
                        delete familyDatabase[phone];
                    } else if (Array.isArray(familyData)) {
                        // Update old format
                        familyDatabase[phone] = kids;
                    }
                    
                    saveData();
                    updateDisplays();
                }
            );
        }

        // ‚îÄ‚îÄ‚îÄ Weekly Reports Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function getSundayKey(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day; // Get Sunday of this week
            const sunday = new Date(d.setDate(diff));
            return `${sunday.getFullYear()}-${String(sunday.getMonth() + 1).padStart(2, '0')}-${String(sunday.getDate()).padStart(2, '0')}`;
        }

        function isSunday() {
            return new Date().getDay() === 0;
        }

        // Called every time a child is checked IN (not out) on a Sunday.
        // Increments the counter for the correct service bucket ‚Äî never deletes.
        function checkAndSaveWeeklyReport() {
            if (!isSunday()) return; // Only track Sundays

            const sundayKey = getTodayKey(); // e.g. "2025-03-02"
            const service   = window.currentService || 'english'; // "russian" | "english"

            if (!weeklyReports[sundayKey]) {
                weeklyReports[sundayKey] = { date: sundayKey, russian: 0, english: 0 };
            }

            // Increment the right service bucket by 1 for this check-in
            if (service === 'russian') {
                weeklyReports[sundayKey].russian = (weeklyReports[sundayKey].russian || 0) + 1;
            } else {
                weeklyReports[sundayKey].english = (weeklyReports[sundayKey].english || 0) + 1;
            }

            saveData();
        }

        function renderReports() {
            const container = document.getElementById('reports-content');
            const isReportAdmin = window.currentUserEmail === 'firealexusa@gmail.com';

            const sortedSundays = Object.keys(weeklyReports).sort().reverse();

            let totalRussian = 0;
            let totalEnglish = 0;
            sortedSundays.forEach(key => {
                totalRussian += weeklyReports[key].russian || 0;
                totalEnglish += weeklyReports[key].english || 0;
            });

            const colSpan = isReportAdmin ? '4' : '3';
            let html = `<div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.95rem;">
                    <thead>
                        <tr style="background:var(--primary);color:white;">
                            <th style="padding:12px 16px;text-align:left;border-radius:8px 0 0 0;">üìÖ Sunday</th>
                            <th style="padding:12px 16px;text-align:center;">üá∑üá∫ 9:00 AM (Russian)</th>
                            <th style="padding:12px 16px;text-align:center;${isReportAdmin ? '' : 'border-radius:0 8px 0 0;'}">üá∫üá∏ 12:00 PM (English)</th>
                            ${isReportAdmin ? '<th style="padding:12px 16px;text-align:center;border-radius:0 8px 0 0;">Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>`;

            if (sortedSundays.length === 0) {
                html += `<tr><td colspan="${colSpan}" style="text-align:center;padding:24px;color:#999;">No Sunday reports yet ‚Äî check-ins on Sundays will appear here.</td></tr>`;
            } else {
                sortedSundays.forEach((key, i) => {
                    const r = weeklyReports[key];
                    const bg = i % 2 === 0 ? '#f8fbff' : 'white';
                    const russianCount = r.russian || 0;
                    const englishCount = r.english || 0;
                    html += `<tr style="background:${bg};" id="report-row-${key}">
                            <td style="padding:12px 16px;font-weight:600;color:var(--text);">${key}</td>
                            <td style="padding:12px 16px;text-align:center;">
                                <span style="font-size:1.4rem;font-weight:700;color:${russianCount > 0 ? '#e74c3c' : '#ccc'};">${russianCount}</span>
                                <span style="font-size:0.8rem;color:#888;display:block;">kids</span>
                            </td>
                            <td style="padding:12px 16px;text-align:center;">
                                <span style="font-size:1.4rem;font-weight:700;color:${englishCount > 0 ? '#4a90e2' : '#ccc'};">${englishCount}</span>
                                <span style="font-size:0.8rem;color:#888;display:block;">kids</span>
                            </td>
                            ${isReportAdmin ? `<td style="padding:8px 12px;text-align:center;white-space:nowrap;">
                                <button onclick="editReportRow('${key}')" style="background:#f0a500;color:white;border:none;border-radius:8px;padding:5px 10px;font-size:0.8rem;cursor:pointer;margin:2px;">‚úèÔ∏è Edit</button>
                                <button onclick="deleteReportRow('${key}')" style="background:#ef4444;color:white;border:none;border-radius:8px;padding:5px 10px;font-size:0.8rem;cursor:pointer;margin:2px;">üóëÔ∏è Delete</button>
                            </td>` : ''}
                        </tr>`;
                });

                html += `<tr style="background:#e8f4e8;font-weight:700;border-top:2px solid #ccc;">
                        <td style="padding:12px 16px;color:var(--text);">Total (all Sundays)</td>
                        <td style="padding:12px 16px;text-align:center;font-size:1.2rem;color:#e74c3c;">${totalRussian}</td>
                        <td style="padding:12px 16px;text-align:center;font-size:1.2rem;color:#4a90e2;">${totalEnglish}</td>
                        ${isReportAdmin ? '<td></td>' : ''}
                    </tr>`;
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        window._editingReportKey = null;

        window.editReportRow = function(key) {
            const r = weeklyReports[key];
            if (!r) return;
            window._editingReportKey = key;
            document.getElementById('report-edit-date-label').textContent = key;
            document.getElementById('edit-russian-count').value = r.russian || 0;
            document.getElementById('edit-english-count').value = r.english || 0;
            openModal('report-edit-modal');
        };

        window.saveReportEdit = function() {
            const key = window._editingReportKey;
            if (!key || !weeklyReports[key]) return;
            const newRussian = Math.max(0, parseInt(document.getElementById('edit-russian-count').value) || 0);
            const newEnglish = Math.max(0, parseInt(document.getElementById('edit-english-count').value) || 0);
            weeklyReports[key].russian = newRussian;
            weeklyReports[key].english = newEnglish;
            closeModal('report-edit-modal');
            window._editingReportKey = null;
            saveData();
            renderReports();
        };

        window.deleteReportRow = function(key) {
            showConfirmModal(
                `Delete the Sunday report for <strong>${key}</strong>? This cannot be undone.`,
                'Delete',
                () => {
                    delete weeklyReports[key];
                    saveData();
                    renderReports();
                }
            );
        };

                // ‚îÄ‚îÄ‚îÄ Supervisor Management Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleAddSupervisorForm() {
            document.getElementById('add-supervisor-form').classList.toggle('hidden');
        }

        function addSupervisorToDatabase() {
            const firstName = document.getElementById('super-first-name').value.trim();
            const lastName = document.getElementById('super-last-name').value.trim();
            const phoneFormatted = document.getElementById('super-phone').value;
            const phone = phoneFormatted.replace(/\D/g, '');
            
            if (!firstName || !lastName || phone.length !== 10) {
                showCenteredAlert('Please enter first name, last name, and valid 10-digit phone number.');
                return;
            }
            
            if (supervisorDatabase[phone]) {
                showCenteredAlert('Supervisor with this phone already exists.');
                return;
            }
            
            supervisorDatabase[phone] = {
                firstName: firstName,
                lastName: lastName
            };
            
            saveData();
            document.getElementById('super-first-name').value = '';
            document.getElementById('super-last-name').value = '';
            document.getElementById('super-phone').value = '';
            toggleAddSupervisorForm();
            renderSupervisorDatabase();
            updateDisplays();
        }

        function renderSupervisorDatabase(filter) {
            const container = document.getElementById('supervisor-database-content');
            const q = (filter !== undefined ? filter : (document.getElementById('sup-search')?.value || '')).toLowerCase().trim();

            let entries = Object.entries(supervisorDatabase);
            // Sort by last name
            entries.sort((a, b) => {
                const la = (a[1].lastName || '').toLowerCase();
                const lb = (b[1].lastName || '').toLowerCase();
                return la.localeCompare(lb);
            });
            if (q) entries = entries.filter(([phone, s]) => {
                const name = ((s.firstName || '') + ' ' + (s.lastName || '')).toLowerCase();
                return name.includes(q) || phone.includes(q);
            });

            const countEl = document.getElementById('sup-db-count');
            if (countEl) countEl.textContent = entries.length + ' record' + (entries.length !== 1 ? 's' : '');

            if (entries.length === 0) {
                container.querySelector('.db-table-wrap').innerHTML = '<div class="db-empty">No supervisors found</div>';
                return;
            }

            let html = '<table class="db-table"><thead><tr><th>Name</th><th>Phone</th><th></th></tr></thead><tbody>';
            entries.forEach(([phone, s]) => {
                const displayName = s.lastName ? `${s.lastName}, ${s.firstName}` : s.firstName;
                html += `<tr>
                    <td class="name-cell">${escapeHtml(displayName)}</td>
                    <td class="phone-cell-db">${escapeHtml(formatPhoneDisplay(phone))}</td>
                    <td class="actions-cell">
                        <button class="db-btn edit" onclick="editSupervisor('${escapeHtml(phone)}')" title="Edit">‚úèÔ∏è</button>
                        <button class="db-btn del"  onclick="deleteSupervisor('${escapeHtml(phone)}')" title="Delete">üóë</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.querySelector('.db-table-wrap').innerHTML = html;
        }

        function editSupervisor(phone) {
            if (!supervisorDatabase[phone]) return;
            // Remove any stale dynamic modal first
            const _dm = document.querySelector('.success-modal.dynamic-modal'); if(_dm) removeDynamicModal(_dm);
            
            const supervisor = supervisorDatabase[phone];
            
            const modal = document.createElement('div');
            modal.className = 'success-modal dynamic-modal';
            modal.innerHTML = `
                <div class="success-content">
                    <h2>Edit Supervisor</h2>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label>Phone: <input type="tel" id="edit-super-phone" value="${escapeHtml(formatPhoneDisplay(phone))}" inputmode="none" maxlength="14" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>First Name: <input type="text" id="edit-super-first" value="${escapeHtml(supervisor.firstName)}" style="width: 200px; padding: 8px;"></label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label>Last Name: <input type="text" id="edit-super-last" value="${escapeHtml(supervisor.lastName)}" style="width: 200px; padding: 8px;"></label>
                        </div>
                    </div>
                    <button class="btn-success" onclick="saveEditSupervisor('${escapeHtml(phone)}')">Save Changes</button>
                    <button class="btn-outline" onclick="closeDynamicModal(this)">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            openModal(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
        }

        function saveEditSupervisor(oldPhone) {
            const newFirstName = document.getElementById('edit-super-first').value.trim();
            const newLastName = document.getElementById('edit-super-last').value.trim();
            const newPhoneFormatted = document.getElementById('edit-super-phone').value;
            const newPhone = newPhoneFormatted.replace(/\D/g, '');
            
            if (!newFirstName || !newLastName || newPhone.length !== 10) {
                showCenteredAlert('Please enter valid first name, last name, and 10-digit phone number');
                return;
            }
            
            // If phone changed, delete old entry
            if (oldPhone !== newPhone) {
                delete supervisorDatabase[oldPhone];
                
                // Update any scheduled supervisors
                Object.keys(scheduledSupervisors).forEach(date => {
                    if (scheduledSupervisors[date] && scheduledSupervisors[date].phone === oldPhone) {
                        scheduledSupervisors[date].phone = newPhone;
                    }
                });
            }
            
            // Save updated supervisor
            supervisorDatabase[newPhone] = {
                firstName: newFirstName,
                lastName: newLastName
            };
            
            saveData();
            renderSupervisorDatabase();
            updateDisplays();
            const dynModal = document.querySelector('.success-modal.dynamic-modal');
            if (dynModal) removeDynamicModal(dynModal);
        }

        function deleteSupervisor(phone) {
            if (!supervisorDatabase[phone]) return;
            
            const supervisor = supervisorDatabase[phone];
            
            showConfirmModal(
                `Delete supervisor ${supervisor.firstName} ${supervisor.lastName} (${formatPhoneDisplay(phone)})?`,
                'Confirm Delete',
                () => {
                    delete supervisorDatabase[phone];
                    
                    // Remove from any scheduled dates
                    Object.keys(scheduledSupervisors).forEach(date => {
                        if (scheduledSupervisors[date] && scheduledSupervisors[date].phone === phone) {
                            delete scheduledSupervisors[date];
                        }
                    });
                    
                    saveData();
                    renderSupervisorDatabase();
                    updateDisplays();
                }
            );
        }

        function assignSupervisor(date, phone) {
            // Use service-specific key: "date_service" (e.g., "02/15/2026_russian")
            const serviceKey = `${date}_${window.currentService}`;
            
            if (!phone) {
                // Remove supervisor assignment for this service
                delete scheduledSupervisors[serviceKey];
            } else {
                const supervisor = supervisorDatabase[phone];
                if (supervisor) {
                    scheduledSupervisors[serviceKey] = {
                        phone: phone,
                        firstName: supervisor.firstName,
                        lastName: supervisor.lastName,
                        service: window.currentService
                    };
                }
            }
            saveData();
            updateDisplays();
        }

        function assignSupervisorHelper(date, phone) {
            // Use service-specific key: "date_service" (e.g., "02/15/2026_russian")
            const serviceKey = `${date}_${window.currentService}`;
            
            if (!phone) {
                // Remove supervisor helper assignment for this service
                delete scheduledSupervisorHelpers[serviceKey];
            } else {
                const helper = supervisorDatabase[phone];
                if (helper) {
                    scheduledSupervisorHelpers[serviceKey] = {
                        phone: phone,
                        firstName: helper.firstName,
                        lastName: helper.lastName,
                        service: window.currentService
                    };
                }
            }
            saveData();
            updateDisplays();
        }

        // ‚îÄ‚îÄ‚îÄ Phone formatting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function formatPhone(input) {
            let digits = input.value.replace(/\D/g, '').slice(0, 10);
            let formatted = '';
            if (digits.length > 0) formatted = '(' + digits.slice(0, 3);
            if (digits.length >= 4) formatted += ') ' + digits.slice(3, 6);
            if (digits.length >= 7) formatted += '-' + digits.slice(6, 10);
            input.value = formatted;
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        loadData();
        show('main-screen');

        // ‚îÄ‚îÄ‚îÄ Schedule View (Public) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function showScheduleView() {
            // Remove any existing schedule view modal first (prevents stacking on refresh)
            const existing = document.getElementById('schedule-view-modal');
            if (existing) removeDynamicModal(existing);

            const modal = document.createElement('div');
            modal.id = 'schedule-view-modal';
            modal.className = 'success-modal dynamic-modal';
            modal.innerHTML = `
                <div id="schedule-view-content">
                    <button class="card-close-btn" onclick="closeDynamicModal(this)">‚úï</button>
                    <h3 style="margin-top:0;color:var(--primary);">Upcoming Schedule</h3>
                    <p id="schedule-view-loading" style="text-align:center;color:#999;">Loading latest data...</p>
                    <div id="schedule-view-body"></div>
                    <button class="btn-primary" onclick="closeDynamicModal(this)" style="margin-top:20px;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            openModal(modal);

            try {
                // Fetch live from volunteers_public ‚Äî this is what volunteer-signup.html writes to
                const _churchCode = window.CHURCH_CODE || 'bibleland2025';
                const publicDocRef = window.doc(window.firebaseDB, 'churches', _churchCode, 'data', 'volunteers_public');
                const snap = await window.getDoc(publicDocRef);
                const liveData = snap.exists() ? snap.data() : {};
                const liveVolunteers = liveData.volunteers || {};
                const liveSupervisors = liveData.scheduledSupervisors || {};

                // Also merge back into local state so local views stay in sync
                Object.assign(volunteers, liveVolunteers);
                Object.assign(scheduledSupervisors, liveSupervisors);

                const sundays = getUpcomingSundays(13);
                let scheduleHTML = '';

                sundays.forEach(date => {
                    const serviceKey = `${date}_${window.currentService}`;
                    const slots = liveVolunteers[serviceKey] || [];
                    const supervisor = liveSupervisors[serviceKey] || null;

                    let volunteersText = '';
                    if (slots.length === 0) {
                        volunteersText = '<p style="color:#999;">No volunteers scheduled yet</p>';
                    } else {
                        volunteersText = '<p><strong>Volunteers:</strong></p>';
                        slots.forEach((vol, idx) => {
                            volunteersText += `<p>${idx + 1}. ${escapeHtml(vol.name)}</p>`;
                        });
                        if (slots.length < 3) {
                            volunteersText += `<p style="color:#ff6b6b;">Still need ${3 - slots.length} more volunteer(s)</p>`;
                        }
                    }

                    let supervisorText = supervisor
                        ? `<p><strong>Supervisor:</strong> ${escapeHtml(supervisor.firstName)} ${escapeHtml(supervisor.lastName)}</p>`
                        : '<p style="color:#999;"><strong>Supervisor:</strong> Not assigned yet</p>';

                    let signUpButton = slots.length < 3
                        ? `<button class="btn-success btn-sm" onclick="showScheduleSignUpForm('${date}')" style="margin-top:8px;">Sign Up for This Date</button>`
                        : '';

                    scheduleHTML += `
                        <div class="schedule-date-block">
                            <h4>${date}</h4>
                            ${volunteersText}
                            ${supervisorText}
                            ${signUpButton}
                        </div>`;
                });

                document.getElementById('schedule-view-loading').remove();
                document.getElementById('schedule-view-body').innerHTML = scheduleHTML;

            } catch (err) {
                console.error('Error loading schedule:', err);
                document.getElementById('schedule-view-loading').textContent = 'Failed to load schedule. Please try again.';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Schedule Sign-Up Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showScheduleSignUpForm(date) {
            const modal = document.createElement('div');
            modal.className = 'success-modal dynamic-modal';
            modal.innerHTML = `
                <div class="success-content" style="max-width: 500px;">
                    <h2 style="color: var(--primary); margin-top: 0;">Sign Up for ${date}</h2>
                    <p>Enter your information to volunteer:</p>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        Phone Number:
                        <input type="tel" id="schedule-signup-phone" placeholder="(000) 000-0000" inputmode="none" maxlength="14"
                               oninput="formatPhone(this); onScheduleSignupPhoneInput()" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        First Name:
                        <input type="text" id="schedule-signup-first" placeholder="First name" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <label style="display: block; text-align: left; margin: 10px 0;">
                        Last Name:
                        <input type="text" id="schedule-signup-last" placeholder="Last name" 
                               style="width: 100%; max-width: 100%; margin-top: 5px;">
                    </label>
                    <div style="margin-top: 20px;">
                        <button class="btn-success" onclick="submitScheduleSignup('${date}')">Submit</button>
                        <button class="btn-outline" onclick="closeDynamicModal(this)">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            openModal(modal);
            
            // Setup numpad for phone input
            setTimeout(setupPhoneInputs, 50);
        }

        // ‚îÄ‚îÄ‚îÄ Auto-fill names when phone is recognized ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onScheduleSignupPhoneInput() {
            const phoneInput = document.getElementById('schedule-signup-phone');
            const phone = phoneInput.value.replace(/\D/g, '');
            
            if (phone.length === 10) {
                // Check volunteers.all database FIRST (priority for volunteer signups)
                if (volunteers.all) {
                    const vol = volunteers.all.find(v => v.phone === phone);
                    if (vol) {
                        document.getElementById('schedule-signup-first').value = vol.firstName || '';
                        document.getElementById('schedule-signup-last').value = vol.lastName || '';
                        return;
                    }
                }
                
                // Check familyDatabase as fallback
                if (familyDatabase[phone]) {
                    const family = familyDatabase[phone];
                    document.getElementById('schedule-signup-first').value = family.firstName || '';
                    document.getElementById('schedule-signup-last').value = family.lastName || '';
                    return;
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ Submit schedule sign-up (DIRECT - NO ADMIN APPROVAL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function submitScheduleSignup(date) {
            const phone = document.getElementById('schedule-signup-phone').value.replace(/\D/g, '');
            const first = document.getElementById('schedule-signup-first').value.trim();
            const last = document.getElementById('schedule-signup-last').value.trim();
            
            if (!phone || phone.length !== 10) {
                showCenteredAlert('Please enter a valid 10-digit phone number');
                return;
            }
            
            if (!first || !last) {
                showCenteredAlert('Please enter both first and last name');
                return;
            }
            
            // Use service-specific key
            const serviceKey = `${date}_${window.currentService}`;
            
            // CHECK BEFORE SAVING
            // Initialize volunteers[serviceKey] if it doesn't exist
            if (!volunteers[serviceKey]) volunteers[serviceKey] = [];
            
            // Check if date is already full
            if (volunteers[serviceKey].length >= 2) {
                const _dm = document.querySelector('.success-modal.dynamic-modal'); if(_dm) removeDynamicModal(_dm);
                showCenteredAlert("This date is already full.");
                return;
            }
            
            // Check if this phone is already signed up for this date
            if (volunteers[serviceKey].some(v => v.phone === phone)) {
                const _dm = document.querySelector('.success-modal.dynamic-modal'); if(_dm) removeDynamicModal(_dm);
                showCenteredAlert("This phone number is already signed up for this date.");
                return;
            }
            
            // Close the sign-up form
            const _dm = document.querySelector('.success-modal.dynamic-modal'); if(_dm) removeDynamicModal(_dm);
            
            // DIRECT SIGNUP - NO ADMIN APPROVAL NEEDED
            const fullName = `${first} ${last}`;
            
            // Add to volunteers list for this date with service key
            volunteers[serviceKey].push({ 
                name: fullName, 
                phone: phone,
                service: window.currentService
            });
            
            // Save to volunteers.all database (volunteer database) - keyed by phone
            if (!volunteers.all) volunteers.all = [];
            
            // Check if volunteer already exists in database
            const existingVolIndex = volunteers.all.findIndex(v => v.phone === phone);
            
            if (existingVolIndex === -1) {
                // New volunteer - add to database
                volunteers.all.push({
                    phone: phone,
                    firstName: first,
                    lastName: last,
                    name: fullName,
                    signupDates: [date]
                });
            } else {
                // Existing volunteer - update their info and add date
                volunteers.all[existingVolIndex].firstName = first;
                volunteers.all[existingVolIndex].lastName = last;
                volunteers.all[existingVolIndex].name = fullName;
                
                if (!volunteers.all[existingVolIndex].signupDates) {
                    volunteers.all[existingVolIndex].signupDates = [];
                }
                if (!volunteers.all[existingVolIndex].signupDates.includes(date)) {
                    volunteers.all[existingVolIndex].signupDates.push(date);
                }
            }
            
            // Persist data
            saveData();
            
            // Close success alert after a moment and refresh schedule
            setTimeout(() => {
                // Remove only dynamic modals, never the static check-in success modal
                document.querySelectorAll('.success-modal.dynamic-modal').forEach(a => removeDynamicModal(a));
                
                // Refresh the schedule view
                showScheduleView();
            }, 1500);
            
            // Show success message
            showCenteredAlert(`‚úÖ ${fullName} signed up for ${date}!`);
        }


        // ‚îÄ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => {
            const nonMemBtn = document.getElementById('continue-nonmember');
            const memBtn = document.getElementById('continue-member');

            if (nonMemBtn) {
                nonMemBtn.addEventListener('click', handleNonMemberPhone);
                document.getElementById('nonmem-phone')
                    .addEventListener('keydown', e => {
                        if (e.key === 'Enter') nonMemBtn.click();
                    });
            }

            if (memBtn) {
                memBtn.addEventListener('click', () => {
                    const phone = document.getElementById('vol-phone-first').value.replace(/\D/g, '');
                    if (phone.length !== 10) {
                        showCenteredAlert('Please enter a valid 10-digit phone number');
                        return;
                    }

                    // Check if this phone is already scheduled within the next 12 weeks
                    const upcomingSundays = getUpcomingSundays(12);
                    let isScheduled = false;

                    for (const date of upcomingSundays) {
                        const serviceKey = `${date}_${window.currentService}`;
                        const slots = volunteers[serviceKey] || [];
                        if (slots.find(v => v.phone === phone)) {
                            isScheduled = true;
                            break;
                        }
                    }

                    // If scheduled within 12 weeks AND we have family data ‚Üí check contract, then skip to check-in
                    if (isScheduled && familyDatabase[phone]) {
                        const family = familyDatabase[phone];
                        isMemberPath = true;
                        memberPhone = document.getElementById('vol-phone-first').value;
                        memberFirst = family.firstName || '';
                        memberLast  = family.lastName  || '';

                        function _showInfoForm() {
                            document.getElementById('phone').value = memberPhone;
                            document.getElementById('firstName').value = memberFirst;
                            document.getElementById('lastName').value = memberLast;

                            if (family.kids && family.kids.length > 0) {
                                document.getElementById('children-list').innerHTML = '';
                                childCounter = 0;
                                family.kids.forEach(child => {
                                    childCounter++;
                                    const div = document.createElement('div');
                                    div.className = 'child-entry';
                                    const allergiesValue = child.allergies || '';
                                    const isOther = allergiesValue !== '' && allergiesValue !== 'None';
                                    const otherText = isOther ? allergiesValue : '';
                                    div.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <div style="flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                    <strong>Child:</strong>
                                                    <input type="text" class="child-name" value="${child.name || ''}" required style="width: 140px;" placeholder="Name" />
                                                </label>
                                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                    <strong>Age:</strong>
                                                    <select class="child-age" style="width: 110px;" required>
                                                        <option value="" disabled ${!child.age ? 'selected' : ''}>Select</option>
                                                        ${[1,2,3,4,5,6].map(age => `<option value="${age}" ${child.age == age ? 'selected' : ''} style="color:#000;">${age}</option>`).join('')}
                                                    </select>
                                                </label>
                                                <label style="margin: 0; display: flex; align-items: center; gap: 4px;">
                                                    <strong>Allergies:</strong>
                                                    <select class="child-allergies" style="width: 140px;" required>
                                                        <option value="" disabled ${allergiesValue === '' ? 'selected' : ''}>Select</option>
                                                        <option value="None" ${allergiesValue === 'None' ? 'selected' : ''} style="color:#000;">None</option>
                                                        <option value="Other" ${isOther ? 'selected' : ''} style="color:#000;">Other</option>
                                                    </select>
                                                </label>
                                                <input type="text" class="child-allergies-other" style="width: 140px; display:${isOther ? 'inline' : 'none'};" value="${otherText}" placeholder="Specify allergy" />
                                            </div>
                                            <button class="btn-icon btn-delete" onclick="this.parentElement.parentElement.remove(); renumberChildren()" title="Remove this child">
                                                <span class="icon">üóëÔ∏è</span>
                                                <span class="text">Remove<br>Child</span>
                                            </button>
                                        </div>
                                    `;
                                    document.getElementById('children-list').appendChild(div);
                                    attachAllergyHandler(div);
                                });
                            } else {
                                document.getElementById('children-list').innerHTML = '';
                                addChildEntry();
                            }
                            show('info-form');
                        }

                        // Show contract if needed before going to check-in
                        if (!window.isContractValid(phone)) {
                            window.showContractModal(memberFirst, memberLast, phone, _showInfoForm);
                        } else {
                            _showInfoForm();
                        }
                        return;
                    }

                    // Not yet scheduled or no family data ‚Äî show volunteer name form
                    if (familyDatabase[phone]) {
                        const family = familyDatabase[phone];
                        document.getElementById('vol-first').value = family.firstName || '';
                        document.getElementById('vol-last').value = family.lastName || '';
                    } else {
                        document.getElementById('vol-first').value = '';
                        document.getElementById('vol-last').value = '';
                    }

                    show('volunteer-form');
                });

                document.getElementById('vol-phone-first')
                    .addEventListener('keydown', e => {
                        if (e.key === 'Enter') memBtn.click();
                    });
            }
        });
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDchZXJyercgztvVv7I57Ol53NDoLFfEEk",
            authDomain: "bible-land-check-in.firebaseapp.com",
            projectId: "bible-land-check-in",
            storageBucket: "bible-land-check-in.firebasestorage.app",
            messagingSenderId: "839634881652",
            appId: "1:839634881652:web:80410e2b38965312b2d521"
        };

        // Church code is stored as a SHA-256 hash ‚Äî the plaintext is never in source
        const CHURCH_CODE = 'bibleland2025'; // used for Firestore path only
        window.CHURCH_CODE = CHURCH_CODE; // expose to non-module scripts
        const CHURCH_CODE_HASH = '3ad78f109c4a6f44bbf7e83104c7713a7cbef8b4b31ccc720f7ccf49ab7d95d8'; // SHA-256 of signup code
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseDB = db;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.currentUserId = null;
        window.isSignupMode = false;

        // Expose contracts loader (uses module-scoped collection/getDocs)
        window._getContractsDocs = async function() {
            const colRef = collection(db, 'churches', CHURCH_CODE, 'contracts');
            const snap = await getDocs(colRef);
            return snap.docs;
        };

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                window.currentUserEmail = user.email;
                document.getElementById('user-email-display').textContent = user.email;
                // Set profile initial (first letter of email)
                const initial = user.email.charAt(0).toUpperCase();
                document.getElementById('user-initial').textContent = initial;
                // Set short name in pill (email before @)
                const shortEl = document.getElementById('user-email-display-short');
                if (shortEl) shortEl.textContent = user.email.split('@')[0];

                // Only show "Change Admin Password" for admins ‚Äî use custom claims, not email
                const changePinLink = document.getElementById('change-pin-link');
                if (changePinLink) {
                    const tokenResult = await user.getIdTokenResult();
                    const isPasswordAdmin = user.email === 'firealexusa@gmail.com';
                    changePinLink.style.display = (tokenResult.claims.admin || isPasswordAdmin) ? 'block' : 'none';
                }
                
                // Show loading
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Load user profile to check service selection
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let selectedService = null;
                
                if (userDoc.exists()) {
                    selectedService = userDoc.data().selectedService;
                }
                
                // If no service selected, show service selection screen
                if (!selectedService) {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('service-selection-screen').classList.remove('hidden');
                    return;
                }
                
                // Store current service
                window.currentService = selectedService;
                updateServiceDisplay(selectedService);
                
                // Load data from Firestore
                await loadFromFirestore();

                // Load parental contracts (separate Firestore collection)
                await window.loadContractsFromFirestore();
                
                // Hide loading, show main app (or resume check-in if returning from volunteer signup)
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');

                    if (window._volunteerReturn) {
                        const ret = window._volunteerReturn;
                        window._volunteerReturn = null;
                        window._resumingCheckin = true; // survives a second auth fire

                        // Restore state ‚Äî contract + volunteer are done
                        memberPhone = ret.phone;
                        memberFirst = ret.firstName;
                        memberLast  = ret.lastName;
                        isMemberPath = true;

                        // Make sure they're in the volunteer list (supervisors excluded)
                        const phoneClean = ret.phone.replace(/[^0-9]/g, '');
                        if (!supervisorDatabase[phoneClean]) {
                            addToVolunteerAllIfNotExists({ name: ret.firstName + ' ' + ret.lastName, phone: phoneClean });
                        }

                        // Populate info-form and show it ‚Äî parent clicks "Check In Now" to get buzzer
                        skipVolunteerSchedule();
                    } else if (!window._resumingCheckin) {
                        // Only go to main screen if we're NOT mid-way through a check-in resume
                        show('main-screen');
                    }
                    // If _resumingCheckin is true, a second auth fire happened ‚Äì leave info-form visible
                }, 1000);
                
                // Set up real-time sync listener
                setupRealtimeSync();

                // If there was pending data from an offline session, flush it now
                if (hasPendingSync) {
                    console.log('üîÑ Flushing offline queue after login...');
                    setTimeout(() => flushToCloud(), 1500);
                }
            } else {
                window.currentUserId = null;
                window.currentUserEmail = null;

                // ‚îÄ‚îÄ Tear down real-time sync listener from the previous user ‚îÄ‚îÄ
                if (window.realtimeSyncUnsubscribe) {
                    window.realtimeSyncUnsubscribe();
                    window.realtimeSyncUnsubscribe = null;
                }
                // Reset so the next login gets a clean listener state
                isInitialLoad = true;
                lastUpdateBy = null;
                lastUpdateTime = null;
                isLocalUpdate = false;
                hasPendingSync = false;
                clearTimeout(pendingSaveTimer);

                // ‚îÄ‚îÄ FIX: Clear all PII from localStorage so no data remains on shared/public devices ‚îÄ‚îÄ
                const keysToRemove = [
                    'kids_checkin_parents', 'kids_checkin_list', 'kids_checkin_used_buzzers',
                    'kids_checkin_volunteers', 'kids_checkin_family_database',
                    'kids_checkin_weekly_reports', 'kids_checkin_supervisors',
                    'kids_checkin_scheduled_supervisors', 'kids_checkin_scheduled_supervisor_helpers',
                    'pendingSyncFlag'
                ];
                keysToRemove.forEach(k => localStorage.removeItem(k));

                // Clear in-memory data so it's not accessible via browser console after logout
                window.parents = {};
                window.checkIns = [];
                window.usedBuzzers = new Set();
                window.volunteers = {};
                window.familyDatabase = {};
                window.weeklyReports = {};
                window.supervisorDatabase = {};
                window.scheduledSupervisors = {};
                window.scheduledSupervisorHelpers = {};

                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app-container').classList.add('hidden');
            }
        });

        // Load data from Firestore
        // ‚îÄ‚îÄ Merge volunteers_public sign-ups into local volunteers map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // volunteer-signup.html writes sign-up slots ONLY to volunteers_public.
        // We must read that doc and overwrite any matching date_service keys so
        // public sign-ups are visible inside the app and are not lost on the next
        // flushToCloud() call.
        async function mergePublicVolunteers() {
            try {
                const publicDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'volunteers_public');
                const snap = await getDoc(publicDocRef);
                if (!snap.exists()) return;
                const pubData = snap.data();
                const pubVols = pubData.volunteers || {};

                // Merge public slots into window.volunteers.
                // Public keys look like "MM/DD/YYYY_russian" / "MM/DD/YYYY_english".
                Object.keys(pubVols).forEach(key => {
                    if (key === 'all') {
                        // Merge master list ‚Äî add anyone not already present
                        if (!window.volunteers.all) window.volunteers.all = [];
                        const existingPhones = new Set(window.volunteers.all.map(v => v.phone));
                        (pubVols.all || []).forEach(v => {
                            if (!existingPhones.has(v.phone)) window.volunteers.all.push(v);
                        });
                    } else if (Array.isArray(pubVols[key])) {
                        // For each date_service slot array, prefer the public version
                        // (it was written by a transaction so it is authoritative for sign-ups)
                        window.volunteers[key] = pubVols[key];
                    }
                });

                console.log('‚úÖ Merged volunteers_public into local volunteers');
            } catch (err) {
                console.warn('‚ö†Ô∏è Could not merge volunteers_public:', err.message);
            }
        }

        async function loadFromFirestore() {
            try {
                updateSyncIndicator('syncing');
                // Use shared data location for the church
                const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
                const docSnap = await getDoc(sharedDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update global variables with shared data
                    if (data.parents) window.parents = data.parents;
                    if (data.checkIns) window.checkIns = data.checkIns;
                    if (data.usedBuzzers) window.usedBuzzers = new Set(data.usedBuzzers);
                    if (data.volunteers) window.volunteers = data.volunteers;
                    if (data.familyDatabase) window.familyDatabase = data.familyDatabase;
                    if (data.weeklyReports) window.weeklyReports = data.weeklyReports;
                    if (data.supervisorDatabase) window.supervisorDatabase = data.supervisorDatabase;
                    if (data.scheduledSupervisors) window.scheduledSupervisors = data.scheduledSupervisors;
                    if (data.scheduledSupervisorHelpers) window.scheduledSupervisorHelpers = data.scheduledSupervisorHelpers;

                    // Merge any sign-ups that came in via volunteer-signup.html
                    await mergePublicVolunteers();
                    
                    // Also save to localStorage for backup
                    originalSaveData();
                    
                    console.log('‚úÖ Shared data loaded from cloud');
                } else {
                    // Document doesn't exist - initialize with empty data structures
                    console.log('üìù No shared data found - initializing fresh');
                    window.parents = window.parents || {};
                    window.checkIns = window.checkIns || [];
                    window.usedBuzzers = window.usedBuzzers || new Set();
                    window.volunteers = window.volunteers || {};
                    window.familyDatabase = window.familyDatabase || {};
                    window.weeklyReports = window.weeklyReports || {};
                    window.supervisorDatabase = window.supervisorDatabase || {};
                    window.scheduledSupervisors = window.scheduledSupervisors || {};
                    window.scheduledSupervisorHelpers = window.scheduledSupervisorHelpers || {};
                    
                    // Create the document with empty structures
                    await window.saveData();
                }
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                // Cloud unreachable ‚Äì fall back to whatever is in localStorage (already loaded by loadData())
                window.parents = window.parents || {};
                window.checkIns = window.checkIns || [];
                window.usedBuzzers = window.usedBuzzers || new Set();
                window.volunteers = window.volunteers || {};
                window.familyDatabase = window.familyDatabase || {};
                window.weeklyReports = window.weeklyReports || {};
                window.supervisorDatabase = window.supervisorDatabase || {};
                window.scheduledSupervisors = window.scheduledSupervisors || {};
                window.scheduledSupervisorHelpers = window.scheduledSupervisorHelpers || {};
                hasPendingSync = true;
                localStorage.setItem('pendingSyncFlag', '1');
                updateSyncIndicator(isOnline() ? 'pending' : 'offline');
                console.warn('‚ö†Ô∏è Using cached local data ‚Äì will sync when connection restores');
            }
        }

        // ‚îÄ‚îÄ‚îÄ Offline-first sync system ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const originalSaveData = window.saveData;

        // Track whether there is unsaved cloud data
        let hasPendingSync = false;
        // Track if we are currently mid-upload (debounce rapid saves)
        let saveInFlight = false;
        let pendingSaveTimer = null;

        // Real-time sync listener vars (declared here so setupRealtimeSync can use them)
        let lastUpdateBy = null;
        let lastUpdateTime = null;
        let isLocalUpdate = false;
        let isInitialLoad = true;

        // ‚îÄ‚îÄ Connectivity helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function isOnline() { return navigator.onLine; }

        window.addEventListener('online', () => {
            console.log('üåê Back online ‚Äì flushing pending data...');
            if (hasPendingSync) flushToCloud();
            else updateSyncIndicator('synced');
        });

        window.addEventListener('offline', () => {
            console.log('üìµ Gone offline');
            updateSyncIndicator('offline');
        });

        // ‚îÄ‚îÄ Core cloud write ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function flushToCloud() {
            if (!window.currentUserId) return;
            if (saveInFlight) return; // another upload already running

            saveInFlight = true;
            updateSyncIndicator('syncing');
            isLocalUpdate = true;

            const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
            // Separate public doc ‚Äî volunteer page reads only this, no PII exposed
            const publicDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'volunteers_public');

            try {
                // Write full private data to data/shared (auth-required by rules)
                // NOTE: window.volunteers is already kept up-to-date by the volunteers_public
                // real-time listener (new sign-ups are merged in as they arrive), so there is
                // no need to re-fetch volunteers_public here. Doing so would cause intentional
                // admin deletions to be resurrected from the public doc.
                await setDoc(sharedDocRef, {
                    parents: window.parents || {},
                    checkIns: window.checkIns || [],
                    usedBuzzers: [...(window.usedBuzzers || [])],
                    volunteers: window.volunteers || {},
                    familyDatabase: window.familyDatabase || {},
                    weeklyReports: window.weeklyReports || {},
                    supervisorDatabase: window.supervisorDatabase || {},
                    scheduledSupervisors: window.scheduledSupervisors || {},
                    scheduledSupervisorHelpers: window.scheduledSupervisorHelpers || {},
                    lastUpdated: new Date().toISOString(),
                    lastUpdatedBy: window.currentUserId
                });

                // Sync volunteer schedule to public doc ‚Äî only the fields the volunteer page needs
                // Use merge:true so regular users (who can only update) never trigger a create
                try {
                    await setDoc(publicDocRef, {
                        volunteers: window.volunteers || {},
                        scheduledSupervisors: window.scheduledSupervisors || {},
                        scheduledSupervisorHelpers: window.scheduledSupervisorHelpers || {},
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                } catch (publicErr) {
                    // Non-admin users cannot create this doc if it doesn't exist yet ‚Äî safe to ignore
                    console.warn('‚ö†Ô∏è Could not update public volunteer doc (non-admin):', publicErr.message);
                }

                hasPendingSync = false;
                localStorage.removeItem('pendingSyncFlag');
                console.log('‚úÖ Cloud sync successful');
                updateSyncIndicator('synced');

                setTimeout(() => { isLocalUpdate = false; }, 2000);
            } catch (err) {
                console.error('‚ùå Cloud sync failed:', err.message);
                hasPendingSync = true;
                localStorage.setItem('pendingSyncFlag', '1');
                updateSyncIndicator(isOnline() ? 'pending' : 'offline');
                isLocalUpdate = false;
            } finally {
                saveInFlight = false;
            }
        }

        // ‚îÄ‚îÄ Overridden saveData: always writes locally, queues cloud upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.saveData = function() {
            // 1. Always persist to localStorage immediately ‚Äî works offline
            originalSaveData();

            if (!window.currentUserId) return;

            // 2. Mark that we have local data not yet confirmed in cloud
            hasPendingSync = true;
            localStorage.setItem('pendingSyncFlag', '1');

            if (!isOnline()) {
                // Offline ‚Äî show indicator, will flush when back online
                updateSyncIndicator('offline');
                return;
            }

            // 3. Debounce rapid successive saves (e.g. checking in multiple children)
            clearTimeout(pendingSaveTimer);
            pendingSaveTimer = setTimeout(() => flushToCloud(), 400);
        };

        // On startup, if there was a pending sync from a previous session, flush it
        if (localStorage.getItem('pendingSyncFlag') === '1') {
            hasPendingSync = true;
        }

        // Real-time sync listener vars (re-declared for clarity)
        
        function setupRealtimeSync() {
            if (!window.currentUserId) return;

            // Tear down any existing listener before creating a new one (e.g. account switch)
            if (window.realtimeSyncUnsubscribe) {
                window.realtimeSyncUnsubscribe();
                window.realtimeSyncUnsubscribe = null;
            }
            isInitialLoad = true;
            
            try {
                // Listen to shared data location
                const sharedDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'shared');
                
                console.log('üì° Setting up real-time sync listener...');
                
                const unsubscribe = onSnapshot(sharedDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        
                        // Skip initial load from listener (we already loaded in loadFromFirestore)
                        if (isInitialLoad) {
                            console.log('‚è≠Ô∏è Skipping initial listener load');
                            lastUpdateBy = data.lastUpdatedBy;
                            lastUpdateTime = data.lastUpdated;
                            isInitialLoad = false;
                            return;
                        }
                        
                        // Skip if this is a local update (within 2 seconds of our own save)
                        if (data.lastUpdatedBy === window.currentUserId && isLocalUpdate) {
                            console.log('‚è≠Ô∏è Skipping self-triggered update');
                            return;
                        }
                        
                        // Skip if this is the exact same update we just processed
                        if (data.lastUpdatedBy === lastUpdateBy && data.lastUpdated === lastUpdateTime) {
                            console.log('‚è≠Ô∏è Skipping duplicate update');
                            return;
                        }
                        
                        lastUpdateBy = data.lastUpdatedBy;
                        lastUpdateTime = data.lastUpdated;
                        
                        console.log('üîÑ Real-time update received from cloud');
                        
                        // Update local data with cloud changes
                        if (data.parents) window.parents = data.parents;
                        if (data.checkIns) window.checkIns = data.checkIns;
                        if (data.usedBuzzers) window.usedBuzzers = new Set(data.usedBuzzers);
                        if (data.volunteers) window.volunteers = data.volunteers;
                        if (data.familyDatabase) window.familyDatabase = data.familyDatabase;
                        if (data.weeklyReports) window.weeklyReports = data.weeklyReports;
                        if (data.supervisorDatabase) window.supervisorDatabase = data.supervisorDatabase;
                        if (data.scheduledSupervisors) window.scheduledSupervisors = data.scheduledSupervisors;
                        if (data.scheduledSupervisorHelpers) window.scheduledSupervisorHelpers = data.scheduledSupervisorHelpers;
                        
                        // Save to localStorage as backup
                        originalSaveData();
                        
                        // Refresh current view if needed
                        const currentView = document.querySelector('.card:not(.hidden)');
                        if (currentView) {
                            if (currentView.id === 'view-checkins') {
                                renderCheckInTable();
                            }
                            if (currentView.id === 'admin-area') {
                                // Refresh family database if visible
                                const familyDbView = document.getElementById('family-db-view');
                                if (familyDbView && !familyDbView.classList.contains('hidden')) {
                                    renderFamilyDatabase();
                                }
                                // Refresh supervisor database if visible
                                const supervisorDbView = document.getElementById('supervisor-db-view');
                                if (supervisorDbView && !supervisorDbView.classList.contains('hidden')) {
                                    renderSupervisorDatabase();
                                }
                            }
                        }
                    } else {
                        console.log('üì≠ No shared data exists yet - will be created on first save');
                    }
                }, (error) => {
                    console.error('‚ùå Real-time sync error:', error);
                });
                
                // Store unsubscribe function
                window.realtimeSyncUnsubscribe = unsubscribe;

                // ‚îÄ‚îÄ Also listen to volunteers_public so sign-ups from volunteer-signup.html
                //    appear in real time without a page refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const publicDocRef = doc(db, 'churches', CHURCH_CODE, 'data', 'volunteers_public');
                let publicInitialLoad = true;
                const unsubscribePublic = onSnapshot(publicDocRef, (pubDoc) => {
                    if (!pubDoc.exists()) return;

                    // Skip the very first fire (we already merged on load)
                    if (publicInitialLoad) {
                        publicInitialLoad = false;
                        return;
                    }

                    // Skip if this update originated from our own flushToCloud() ‚Äî it will
                    // always set lastUpdated on the shared doc first, and isLocalUpdate will
                    // still be true within the 2-second window.
                    if (isLocalUpdate) {
                        console.log('‚è≠Ô∏è Skipping volunteers_public update ‚Äî came from our own save');
                        return;
                    }

                    console.log('üîÑ volunteers_public update received ‚Äî merging new sign-ups');
                    const pubVols = pubDoc.data().volunteers || {};

                    Object.keys(pubVols).forEach(key => {
                        if (key === 'all') {
                            if (!window.volunteers.all) window.volunteers.all = [];
                            const existingPhones = new Set(window.volunteers.all.map(v => v.phone));
                            (pubVols.all || []).forEach(v => {
                                if (!existingPhones.has(v.phone)) window.volunteers.all.push(v);
                            });
                        } else if (Array.isArray(pubVols[key])) {
                            window.volunteers[key] = pubVols[key];
                        }
                    });

                    // Persist locally and refresh any visible schedule views
                    originalSaveData();
                    if (typeof renderVolunteerSchedule === 'function') renderVolunteerSchedule();
                    if (typeof renderAdminSchedule === 'function') renderAdminSchedule();
                }, (error) => {
                    console.warn('‚ö†Ô∏è volunteers_public listener error:', error.message);
                });

                // Tear down both listeners on next setup call
                const _prevUnsub = window.realtimeSyncUnsubscribe;
                window.realtimeSyncUnsubscribe = function() {
                    _prevUnsub && _prevUnsub();
                    unsubscribePublic && unsubscribePublic();
                };
                
            } catch (error) {
                console.error('‚ùå Error setting up real-time sync:', error);
            }
        }

        // Update sync indicator
        function updateSyncIndicator(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            if (!dot || !text) return;

            if (status === 'syncing') {
                dot.className = 'sync-dot syncing';
                text.textContent = 'Syncing...';
            } else if (status === 'offline') {
                dot.className = 'sync-dot offline';
                text.textContent = 'üìµ Offline ‚Äì saved locally';
            } else if (status === 'pending') {
                dot.className = 'sync-dot pending';
                text.textContent = '‚è≥ Waiting to sync...';
            } else {
                dot.className = 'sync-dot';
                text.textContent = '‚úì Synced';
            }
        }

        // Handle login/signup
        let _loginLastAttemptTime = 0;
        const LOGIN_DEBOUNCE_MS = 600;

        window.handleLogin = async function() {
            // Debounce ‚Äî ignore calls within 600ms of the last attempt
            const now = Date.now();
            if (now - _loginLastAttemptTime < LOGIN_DEBOUNCE_MS) return;
            _loginLastAttemptTime = now;

            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (window.isSignupMode) {
                const churchCode = document.getElementById('church-code').value.trim();

                // Hash what the user typed and compare against the stored hash ‚Äî plaintext never in source
                const encoder = new TextEncoder();
                const codeBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(churchCode));
                const codeHash = Array.from(new Uint8Array(codeBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

                if (codeHash !== CHURCH_CODE_HASH) {
                    errorDiv.textContent = 'Invalid church code. Please contact your administrator.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
            }
            
            try {
                if (window.isSignupMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    successDiv.textContent = '‚úÖ Account created! Loading...';
                    successDiv.classList.remove('hidden');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let message = 'An error occurred. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'This email is already registered. Try signing in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                } else if (error.code === 'auth/user-not-found') {
                    message = 'No account found with this email';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password';
                } else if (error.code === 'auth/invalid-credential') {
                    message = 'Invalid email or password';
                }
                
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        };

        // Toggle between login and signup
        window.toggleAuthMode = function() {
            window.isSignupMode = !window.isSignupMode;
            const btnLogin = document.getElementById('btn-login');
            const toggleText = document.getElementById('toggle-text');
            const toggleLink = document.getElementById('toggle-link');
            const churchCodeField = document.getElementById('church-code-field');
            
            if (window.isSignupMode) {
                btnLogin.textContent = 'Create Account';
                toggleText.textContent = 'Already have an account? ';
                toggleLink.textContent = 'Sign in';
                churchCodeField.classList.remove('hidden');
            } else {
                btnLogin.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account? ";
                toggleLink.textContent = 'Create one';
                churchCodeField.classList.add('hidden');
            }
            
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
        };

        // Toggle profile dropdown
        window.toggleProfileDropdown = function() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('show');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && !userInfo.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Handle logout
        window.handleLogout = async function() {
            showConfirmModal('Are you sure you want to logout?', 'Logout', async () => {
                await signOut(auth);
            });
        };

        // Service selection functions
        window.selectService = async function(service) {
            if (!window.currentUserId) return;
            
            try {
                // Save service preference to user profile
                await setDoc(doc(db, 'users', window.currentUserId), {
                    selectedService: service,
                    email: auth.currentUser.email
                }, { merge: true });
                
                window.currentService = service;
                updateServiceDisplay(service);
                
                // Hide service selection, show loading
                document.getElementById('service-selection-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Load data from Firestore
                await loadFromFirestore();
                
                // Show main app
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');
                    show('main-screen');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving service selection:', error);
                showCenteredAlert('Failed to save service selection. Please try again.');
            }
        };

        window.updateServiceDisplay = function(service) {
            const serviceName = service === 'russian' ? 'üá∑üá∫ Russian Service (9:00 AM)' : 'üá∫üá∏ English Service (12:00 PM)';
            const serviceColor = service === 'russian' ? '#ff6b6b' : '#4a90e2';
            
            const mainDisplay = document.getElementById('current-service-display');
            const profileDisplay = document.getElementById('profile-service-display');
            
            if (mainDisplay) {
                mainDisplay.textContent = serviceName;
                mainDisplay.style.background = service === 'russian' ? '#ffe6e6' : '#e3f2fd';
                mainDisplay.style.color = serviceColor;
            }
            
            if (profileDisplay) {
                profileDisplay.textContent = serviceName;
                profileDisplay.style.color = serviceColor;
            }
        };

        window.showServiceSwitchModal = function() {
            openModal('service-switch-modal');
        };

        window.closeServiceSwitchModal = function() {
            closeModal('service-switch-modal');
        };

        window.confirmServiceSwitch = async function(service) {
            if (service === window.currentService) {
                showCenteredAlert('You are already on this service.');
                closeServiceSwitchModal();
                return;
            }

            const serviceName = service === 'russian' ? 'Russian (9 AM)' : 'English (12 PM)';
            closeServiceSwitchModal();
            showConfirmModal(`Switch to ${serviceName} service?`, 'Switch Service', async () => {
                try {
                    await setDoc(doc(db, 'users', window.currentUserId), {
                        selectedService: service
                    }, { merge: true });

                    window.currentService = service;
                    updateServiceDisplay(service);

                    // Refresh current view to show data for new service
                    const currentView = document.querySelector('.card:not(.hidden)');
                    if (currentView && currentView.id === 'view-checkins') {
                        renderCheckInTable();
                    }

                    showCenteredAlert('Service switched successfully!');
                } catch (error) {
                    console.error('Error switching service:', error);
                    showCenteredAlert('Failed to switch service. Please try again.');
                }
            });
        };

        // Suppress reCAPTCHA/App Check iframe "message channel closed" noise
        // These are harmless async teardown errors from the App Check reCAPTCHA iframe
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && typeof e.reason.message === 'string' &&
                (e.reason.message.includes('message channel closed') ||
                 e.reason.message.includes('A listener indicated an asynchronous response'))) {
                e.preventDefault();
            }
        });
        window.addEventListener('error', function(e) {
            if (e.message && (e.message.includes('message channel closed') ||
                e.message.includes('A listener indicated an asynchronous response'))) {
                e.preventDefault();
            }
        });

        // ‚îÄ‚îÄ iPhone / iOS Login Auto-Submit Fix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Root cause: when iOS keyboard appears/disappears it causes a layout
        // shift that can scroll btn-login under the user's lifting finger,
        // firing a ghost click before the password field is even filled.
        //
        // Fix: track the LAST TIME any login input received focus. If btn-login
        // receives a click (or touch) within 400ms of a focus event, it is very
        // likely an accidental trigger ‚Äî silently drop it.
        //
        // We also add a 600ms debounce inside handleLogin itself so even if the
        // ghost click gets through it cannot fire a second Firebase request.

        let _lastLoginInputFocusTime = 0;
        const LOGIN_FOCUS_GUARD_MS = 400;

        ['auth-email', 'auth-password', 'church-code'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('focus', () => {
                _lastLoginInputFocusTime = Date.now();
            }, { passive: true });
            // Also track touchstart on the input itself (keyboard-open moment)
            el.addEventListener('touchstart', () => {
                _lastLoginInputFocusTime = Date.now();
            }, { passive: true });
        });

        // Guard the button's click AND touchend ‚Äî drop if too close to a focus event
        document.getElementById('btn-login').addEventListener('click', function(e) {
            if (Date.now() - _lastLoginInputFocusTime < LOGIN_FOCUS_GUARD_MS) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
        }, true); // capture phase so it runs before onclick

        // Belt-and-suspenders: also guard touchend directly
        document.getElementById('btn-login').addEventListener('touchend', function(e) {
            if (Date.now() - _lastLoginInputFocusTime < LOGIN_FOCUS_GUARD_MS) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
        }, { passive: false });

        // Enter key support for login
        document.getElementById('auth-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('auth-password').focus();
        });
        
        document.getElementById('auth-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (window.isSignupMode) {
                    document.getElementById('church-code').focus();
                } else {
                    // Only attempt login if password field actually has content
                    if (document.getElementById('auth-password').value.length >= 1) {
                        handleLogin();
                    }
                }
            }
        });
        
        document.getElementById('church-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BIBLE LAND PARENTAL CONTRACT ‚Äî Logic
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // In-memory cache: phone (10-digit string) ‚Üí contract object
        // { firstName, lastName, phone, signedAt (ISO string) }
        // Load any locally-saved contracts as fallback (survives Firestore permission errors)
        window.contractsCache = (function() {
            try {
                const stored = localStorage.getItem('blci_contracts');
                return stored ? JSON.parse(stored) : {};
            } catch(e) { return {}; }
        })();

        // Called after contract checkbox changes to enable/disable submit button
        window.onContractCheckboxChange = function() {
            const cb = document.getElementById('contract-agree-checkbox');
            const btn = document.getElementById('contract-submit-btn');
            if (cb && btn) {
                btn.style.opacity = cb.checked ? '1' : '0.45';
                btn.style.pointerEvents = cb.checked ? 'auto' : 'none';
            }
        };

        // Wire up checkbox listener once DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const cb = document.getElementById('contract-agree-checkbox');
            if (cb) cb.addEventListener('change', window.onContractCheckboxChange);
        });
        // Also wire up immediately in case DOM is already ready
        (function() {
            const cb = document.getElementById('contract-agree-checkbox');
            if (cb) cb.addEventListener('change', window.onContractCheckboxChange);
        })();

        // Returns true if the contract for this phone is signed AND less than 1 year old
        window.isContractValid = function(phone10) {
            const c = window.contractsCache[phone10];
            if (!c || !c.signedAt) return false;
            const signedDate = new Date(c.signedAt);
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            return signedDate > oneYearAgo;
        };

        // ‚îÄ‚îÄ Bilingual Contract Text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Add new language here by adding a new key. Key matches window.currentService.
        const CONTRACT_TEXT = {
            english: {
                title:         'Bible Land Parental Contract',
                subtitle:      'Please read and agree to the following before checking in',
                guardianLabel: 'Parent / Guardian',
                intro:         'By enrolling my child in <strong>Bible Land</strong>, I agree to participate and help Bible Land staff in any request needed to keep Bible Land premises clean and safe. I also agree to the following:',
                rules: [
                    'Serve as a volunteer <strong>at least once every 12 weeks</strong>.',
                    'When serving, be ready to <strong>greet kids 15 minutes before service</strong>.',
                    'Serve at <strong>1 holiday service or special event</strong> per year.',
                    'Attend <strong>cleaning day once per year</strong>.',
                    'Pick up my child <strong>within 5 minutes after service ends</strong>.'
                ],
                dateLabel:   'Date:',
                agreeText:   'I have read and agree to the <strong>Bible Land Parental Contract</strong> listed above. I understand this agreement is renewed annually.',
                submitBtn:   '‚úÖ I Agree ‚Äî Continue Check-In',
                cancelBtn:   'Cancel'
            },
            russian: {
                title:         '–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî Bible Land',
                subtitle:      '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π',
                guardianLabel: '–†–æ–¥–∏—Ç–µ–ª—å / –û–ø–µ–∫—É–Ω',
                intro:         '–ó–∞–ø–∏—Å—ã–≤–∞—è —Å–≤–æ–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ –≤ <strong>Bible Land</strong>, —è —Å–æ–≥–ª–∞—à–∞—é—Å—å —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏ —á–∏—Å—Ç–æ—Ç—ã –∏ –ø–æ—Ä—è–¥–∫–∞. –Ø —Ç–∞–∫–∂–µ –ø—Ä–∏–Ω–∏–º–∞—é —Å–ª–µ–¥—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è:',
                rules: [
                    '–°–ª—É–∂–∏—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–º <strong>–∫–∞–∫ –º–∏–Ω–∏–º—É–º —Ä–∞–∑ –≤ 12 –Ω–µ–¥–µ–ª—å</strong>.',
                    '–í–æ –≤—Ä–µ–º—è —Å–ª—É–∂–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å <strong>–∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞</strong>, —á—Ç–æ–±—ã –≤—Å—Ç—Ä–µ—á–∞—Ç—å –¥–µ—Ç–µ–π.',
                    '–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ <strong>1 –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–º —Å–ª—É–∂–µ–Ω–∏–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</strong> –≤ –≥–æ–¥.',
                    '–ü—Ä–∏—Ö–æ–¥–∏—Ç—å –Ω–∞ <strong>–¥–µ–Ω—å —É–±–æ—Ä–∫–∏ —Ä–∞–∑ –≤ –≥–æ–¥</strong>.',
                    '–ó–∞–±–∏—Ä–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ <strong>–≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª—É–∂–µ–Ω–∏—è</strong>.'
                ],
                dateLabel:   '–î–∞—Ç–∞:',
                agreeText:   '–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ —Å–æ–≥–ª–∞—Å–µ–Ω(–∞) —Å <strong>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º Bible Land</strong>, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤—ã—à–µ. –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–≥–æ–¥–Ω–æ.',
                submitBtn:   '‚úÖ –°–æ–≥–ª–∞—Å–µ–Ω(–∞) ‚Äî –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é',
                cancelBtn:   '–û—Ç–º–µ–Ω–∞'
            }
        };

        // Open the contract modal for a member about to check in
        // afterContractFn is called when they successfully agree
        window._contractCallback = null;
        window._contractLang = 'english';

        // Internal helper: render all contract text for the given language
        function _renderContractText(lang) {
            const t = CONTRACT_TEXT[lang] || CONTRACT_TEXT['english'];

            document.getElementById('contract-title').textContent          = t.title;
            document.getElementById('contract-subtitle').textContent       = t.subtitle;
            document.getElementById('contract-guardian-label').textContent = t.guardianLabel;
            document.getElementById('contract-intro').innerHTML            = t.intro;
            document.getElementById('contract-date-label').textContent     = t.dateLabel;
            document.getElementById('contract-agree-text').innerHTML       = t.agreeText;
            document.getElementById('contract-submit-btn').innerHTML       = t.submitBtn;
            document.querySelector('#contract-modal .contract-modal-inner > div:last-child > button:last-child').textContent = t.cancelBtn;

            // Render rules list
            document.getElementById('contract-rules').innerHTML = t.rules.map(r => `<li>${r}</li>`).join('');

            // Set today's date (locale-aware)
            const now = new Date();
            document.getElementById('contract-date-display').textContent = lang === 'russian'
                ? now.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' })
                : now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Highlight the active toggle button
            const ruBtn = document.getElementById('contract-lang-ru');
            const enBtn = document.getElementById('contract-lang-en');
            if (ruBtn && enBtn) {
                if (lang === 'russian') {
                    ruBtn.style.background = '#e74c3c'; ruBtn.style.color = 'white';
                    enBtn.style.background = 'transparent'; enBtn.style.color = '#4a90e2';
                } else {
                    enBtn.style.background = '#4a90e2'; enBtn.style.color = 'white';
                    ruBtn.style.background = 'transparent'; ruBtn.style.color = '#e74c3c';
                }
            }
        }

        // Called when parent taps RU or EN toggle
        window.switchContractLang = function(lang) {
            window._contractLang = lang;
            _renderContractText(lang);
            // Reset checkbox & submit button when language switches
            const cb  = document.getElementById('contract-agree-checkbox');
            const btn = document.getElementById('contract-submit-btn');
            if (cb)  cb.checked = false;
            if (btn) { btn.style.opacity = '0.45'; btn.style.pointerEvents = 'none'; }
        };

        window.showContractModal = function(firstName, lastName, phone10, afterFn) {
            window._contractCallback = afterFn;

            // Default language = current service, fall back to english
            window._contractLang = (window.currentService === 'russian') ? 'russian' : 'english';

            // Populate parent info (language-independent)
            document.getElementById('contract-parent-name').textContent  = `${firstName} ${lastName}`;
            document.getElementById('contract-parent-phone').textContent = formatPhoneDisplay(phone10);

            // Render text in the chosen language
            _renderContractText(window._contractLang);

            // Reset checkbox & button state
            const cb  = document.getElementById('contract-agree-checkbox');
            const btn = document.getElementById('contract-submit-btn');
            if (cb)  cb.checked = false;
            if (btn) { btn.style.opacity = '0.45'; btn.style.pointerEvents = 'none'; }

            openModal('contract-modal');
        };

        window.closeContractModal = function() {
            closeModal('contract-modal');
            window._contractCallback = null;
        };

        // Called when parent clicks "I Agree ‚Äî Continue Check-In"
        window.submitContract = async function() {
            const cb = document.getElementById('contract-agree-checkbox');
            if (!cb || !cb.checked) return;

            const phone10 = (memberPhone || '').replace(/\D/g, '');
            const firstName = memberFirst || '';
            const lastName = memberLast || '';

            const contractData = {
                firstName,
                lastName,
                phone: phone10,
                language: window._contractLang || ((window.currentService === 'russian') ? 'russian' : 'english'),
                signedAt: new Date().toISOString()
            };

            // Update in-memory cache and localStorage immediately ‚Äî this is the
            // fallback so the modal doesn't re-appear if Firestore is unavailable.
            window.contractsCache[phone10] = contractData;
            try {
                localStorage.setItem('blci_contracts', JSON.stringify(window.contractsCache));
            } catch(e) {}

            // Save to Firestore (own collection, separate from shared doc)
            try {
                if (window.firebaseDB && window.doc && window.setDoc) {
                    const contractRef = window.doc(window.firebaseDB,
                        'churches', window.CHURCH_CODE, 'contracts', phone10);
                    await window.setDoc(contractRef, contractData);
                    console.log('‚úÖ Contract saved to Firestore');
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Could not save contract to Firestore:', err.message);
            }

            closeModal('contract-modal');

            // Continue to the original check-in flow
            if (window._contractCallback) {
                const cb2 = window._contractCallback;
                window._contractCallback = null;
                cb2();
            }
        };

        // Load all contracts from Firestore into contractsCache
        // Called after login, alongside loadFromFirestore
        window.loadContractsFromFirestore = async function() {
            if (!window.firebaseDB) return;
            try {
                if (!window._getContractsDocs) return;
                const docs = await window._getContractsDocs();
                // ‚îÄ‚îÄ Replace cache entirely with what's in Firestore ‚îÄ‚îÄ
                // This ensures deleted contracts are never resurrected from localStorage.
                const freshCache = {};
                docs.forEach(d => {
                    freshCache[d.id] = d.data();
                });
                window.contractsCache = freshCache;
                console.log(`‚úÖ Loaded ${docs.length} contracts from Firestore (cache replaced)`);
                // Mirror to localStorage so contracts survive future Firestore outages
                try { localStorage.setItem('blci_contracts', JSON.stringify(window.contractsCache)); } catch(e) {}
                // Re-render if admin panel is open
                if (!document.getElementById('admin-content').classList.contains('hidden')) {
                    renderContractsTable();
                }
            } catch (err) {
                // Firestore rules may still require AppCheck enforcement in Firebase Console.
                // Go to Firebase Console ‚Üí Firestore ‚Üí Rules and ensure the contracts
                // collection allows: allow read, write: if request.auth != null;
                // (remove any "request.app != null" condition)
                // Contracts loaded from localStorage will be used as fallback.
                console.warn('‚ö†Ô∏è Could not load contracts from Firestore:', err.message);
            }
        };

        // Render the contracts table in admin panel
        window.renderContractsTable = function(filter) {
            const wrap = document.getElementById('contracts-table-wrap');
            const countEl = document.getElementById('contracts-db-count');
            if (!wrap) return;

            const q = ((filter !== undefined ? filter :
                (document.getElementById('contracts-search')?.value || ''))).toLowerCase().trim();

            let entries = Object.entries(window.contractsCache);

            if (q) {
                entries = entries.filter(([phone, c]) => {
                    const name = ((c.firstName || '') + ' ' + (c.lastName || '')).toLowerCase();
                    return name.includes(q) || phone.includes(q);
                });
            }

            // Sort by last name
            entries.sort((a, b) => (a[1].lastName || '').localeCompare(b[1].lastName || ''));

            if (countEl) countEl.textContent = entries.length + ' record' + (entries.length !== 1 ? 's' : '');

            if (entries.length === 0) {
                wrap.innerHTML = '<div class="db-empty" style="text-align:center;padding:20px;color:#aaa;">No contracts found</div>';
                return;
            }

            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

            const canDeleteContract = (window.currentUserEmail === 'firealexusa@gmail.com');
            let html = `<table class="db-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Lang</th>
                        <th>Signed On</th>
                        <th>Status</th>
                        ${canDeleteContract ? '<th></th>' : ''}
                    </tr>
                </thead>
                <tbody>`;

            entries.forEach(([phone, c], i) => {
                const bg = i % 2 === 0 ? '#f8fbff' : 'white';
                const signedDate = c.signedAt ? new Date(c.signedAt) : null;
                const isValid = signedDate && signedDate > oneYearAgo;
                const dateStr = signedDate
                    ? signedDate.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' })
                    : '‚Äî';
                const statusBadge = isValid
                    ? `<span class="db-badge" style="background:#d4fce9;color:#1a7a4a;">‚úÖ Valid</span>`
                    : `<span class="db-badge" style="background:#ffeaea;color:#c0392b;">‚ö†Ô∏è Renewal Due</span>`;
                const displayName = c.lastName ? `${c.lastName}, ${c.firstName}` : (c.firstName || '‚Äî');
                const langBadge = c.language === 'russian'
                    ? `<span class="db-badge" style="background:#ffe6e6;color:#c0392b;">üá∑üá∫ RU</span>`
                    : `<span class="db-badge" style="background:#e3f2fd;color:#1565c0;">üá∫üá∏ EN</span>`;
                html += `<tr>
                    <td class="name-cell">${escapeHtml(displayName)}</td>
                    <td class="phone-cell-db">${escapeHtml(formatPhoneDisplay(phone))}</td>
                    <td class="badge-cell">${langBadge}</td>
                    <td class="badge-cell" style="font-size:0.78rem;">${dateStr}</td>
                    <td class="badge-cell">${statusBadge}</td>
                    ${canDeleteContract ? `<td class="actions-cell">
                        <button class="db-btn view-contract-btn" onclick="viewContract('${escapeHtml(phone)}')" title="View signed contract">üëÅÔ∏è</button>
                        <button class="db-btn del" onclick="deleteContract('${escapeHtml(phone)}')" title="Delete contract" style="margin-left:3px;">üóë</button>
                    </td>` : ''}
                </tr>`;
            });

            html += '</tbody></table>';
            wrap.innerHTML = html;
        };

        // ‚îÄ‚îÄ‚îÄ View a single contract (firealexusa only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.viewContract = function(phone10) {
            if (window.currentUserEmail !== 'firealexusa@gmail.com') return;
            const c = window.contractsCache[phone10];
            if (!c) { showCenteredAlert('Contract not found.'); return; }

            const signedDate = c.signedAt ? new Date(c.signedAt) : null;
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const isValid = signedDate && signedDate > oneYearAgo;
            const lang = c.language || 'english';
            const t = {
                english: {
                    title: 'Bible Land Parental Contract',
                    intro: 'By enrolling my child in <strong>Bible Land</strong>, I agree to participate and help Bible Land staff in any request needed to keep Bible Land premises clean and safe. I also agree to the following:',
                    rules: [
                        'Serve as a volunteer <strong>at least once every 12 weeks</strong>.',
                        'When serving, be ready to <strong>greet kids 15 minutes before service</strong>.',
                        'Serve at <strong>1 holiday service or special event</strong> per year.',
                        'Attend <strong>cleaning day once per year</strong>.',
                        'Pick up my child <strong>within 5 minutes after service ends</strong>.'
                    ],
                    agreeText: 'I have read and agree to the <strong>Bible Land Parental Contract</strong> listed above. I understand this agreement is renewed annually.',
                    guardian: 'Parent / Guardian'
                },
                russian: {
                    title: '–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî Bible Land',
                    intro: '–ó–∞–ø–∏—Å—ã–≤–∞—è —Å–≤–æ–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ –≤ <strong>Bible Land</strong>, —è —Å–æ–≥–ª–∞—à–∞—é—Å—å —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏ —á–∏—Å—Ç–æ—Ç—ã –∏ –ø–æ—Ä—è–¥–∫–∞. –Ø —Ç–∞–∫–∂–µ –ø—Ä–∏–Ω–∏–º–∞—é —Å–ª–µ–¥—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è:',
                    rules: [
                        '–°–ª—É–∂–∏—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–º <strong>–∫–∞–∫ –º–∏–Ω–∏–º—É–º —Ä–∞–∑ –≤ 12 –Ω–µ–¥–µ–ª—å</strong>.',
                        '–í–æ –≤—Ä–µ–º—è —Å–ª—É–∂–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å <strong>–∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞</strong>, —á—Ç–æ–±—ã –≤—Å—Ç—Ä–µ—á–∞—Ç—å –¥–µ—Ç–µ–π.',
                        '–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ <strong>1 –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–º —Å–ª—É–∂–µ–Ω–∏–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</strong> –≤ –≥–æ–¥.',
                        '–ü—Ä–∏—Ö–æ–¥–∏—Ç—å –Ω–∞ <strong>–¥–µ–Ω—å —É–±–æ—Ä–∫–∏ —Ä–∞–∑ –≤ –≥–æ–¥</strong>.',
                        '–ó–∞–±–∏—Ä–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ <strong>–≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª—É–∂–µ–Ω–∏—è</strong>.'
                    ],
                    agreeText: '–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞) –∏ —Å–æ–≥–ª–∞—Å–µ–Ω(–∞) —Å <strong>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º Bible Land</strong>, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤—ã—à–µ. –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–≥–æ–¥–Ω–æ.',
                    guardian: '–†–æ–¥–∏—Ç–µ–ª—å / –û–ø–µ–∫—É–Ω'
                }
            }[lang] || { title:'Contract', intro:'', rules:[], agreeText:'', guardian:'Parent' };

            const displayName = `${c.firstName || ''} ${c.lastName || ''}`.trim() || '‚Äî';
            const phoneFmt = formatPhoneDisplay(phone10);
            const dateStr = signedDate
                ? signedDate.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' })
                : '‚Äî';
            const langLabel = lang === 'russian' ? 'üá∑üá∫ Russian' : 'üá∫üá∏ English';
            const statusBadge = isValid
                ? `<span style="background:#d4fce9;color:#1a7a4a;padding:3px 10px;border-radius:20px;font-size:0.82rem;font-weight:600;">‚úÖ Valid</span>`
                : `<span style="background:#ffeaea;color:#c0392b;padding:3px 10px;border-radius:20px;font-size:0.82rem;font-weight:600;">‚ö†Ô∏è Renewal Due</span>`;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay dynamic-modal';
            modal.style.zIndex = '5100';
            modal.innerHTML = `
                <div style="background:white;border-radius:20px;padding:30px 26px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.2);position:relative;">
                    <button onclick="closeDynamicModal(this)" style="position:absolute;top:12px;right:12px;width:36px;height:36px;border:none;background:#ef4444;border-radius:50%;color:white;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
                    <div style="text-align:center;margin-bottom:18px;">
                        <div style="font-size:2rem;margin-bottom:4px;">üìú</div>
                        <h2 style="margin:0 0 4px;color:#4a90e2;font-size:1.25rem;">${t.title}</h2>
                        <div style="display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px;">
                            ${statusBadge}
                            <span style="font-size:0.82rem;color:#666;">${langLabel}</span>
                        </div>
                    </div>
                    <div style="background:#f0f7ff;border-radius:12px;padding:14px 16px;margin-bottom:16px;font-size:0.9rem;">
                        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
                            <div><strong>${t.guardian}:</strong> ${escapeHtml(displayName)}</div>
                            <div><strong>Phone:</strong> ${escapeHtml(phoneFmt)}</div>
                        </div>
                        <div style="margin-top:6px;color:#555;"><strong>Signed:</strong> ${dateStr}</div>
                    </div>
                    <div style="font-size:0.87rem;color:#444;line-height:1.55;margin-bottom:12px;">
                        <p style="margin:0 0 10px;">${t.intro}</p>
                        <ol style="margin:0;padding-left:22px;">
                            ${t.rules.map(r => `<li style="margin-bottom:5px;">${r}</li>`).join('')}
                        </ol>
                    </div>
                    <div style="background:#e8f5e9;border:1.5px solid #a5d6a7;border-radius:10px;padding:12px 14px;font-size:0.85rem;color:#2e7d32;margin-bottom:16px;">
                        ‚úÖ ${t.agreeText}
                    </div>
                    <div style="text-align:center;font-size:0.78rem;color:#999;border-top:1px solid #eee;padding-top:12px;">
                        Contract ID: ${escapeHtml(phone10)} ¬∑ Signed digitally via Bible Land Check-In
                    </div>
                </div>`;
            document.body.appendChild(modal);
            openModal(modal);
        };

        // ‚îÄ‚îÄ‚îÄ Delete a single contract (firealexusa only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.deleteContract = function(phone10) {
            if (window.currentUserEmail !== 'firealexusa@gmail.com') return;

            showConfirmModal(
                `Delete contract for ${formatPhoneDisplay(phone10)}? This cannot be undone.`,
                'Delete Contract',
                async () => {
                    // Remove from in-memory cache
                    delete window.contractsCache[phone10];
                    try { localStorage.setItem('blci_contracts', JSON.stringify(window.contractsCache)); } catch(e) {}

                    // Remove from Firestore
                    try {
                        if (window.firebaseDB && window.doc) {
                            const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                            const contractRef = window.doc(window.firebaseDB, 'churches', window.CHURCH_CODE, 'contracts', phone10);
                            await deleteDoc(contractRef);
                            console.log('‚úÖ Contract deleted from Firestore');
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Could not delete contract from Firestore:', err.message);
                    }

                    renderContractsTable();
                }
            );
        };

        // ‚îÄ‚îÄ‚îÄ Detect volunteer return BEFORE auth fires ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Set window._volunteerReturn immediately; the auth callback reads it
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('volunteer_done') === 'true') {
                window.history.replaceState({}, document.title, window.location.pathname);
                const pending = JSON.parse(localStorage.getItem('pendingVolunteerCheckin') || 'null');
                if (pending) {
                    localStorage.removeItem('pendingVolunteerCheckin');
                    window._volunteerReturn = pending; // auth callback will pick this up
                }
            }
        })();

        // Firebase initialized
        
        // Fix for iPad numpad button white space issue
        // Remove focus from buttons after click to prevent persistent active state
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all numpad buttons
            document.querySelectorAll('.numpad-btn').forEach(button => {
                // Handle touchend for mobile/tablet
                button.addEventListener('touchend', function() {
                    this.blur();
                });
                
                // Handle mouseup for desktop
                button.addEventListener('mouseup', function() {
                    this.blur();
                });
                
                // Prevent focus on touchstart
                button.addEventListener('touchstart', function(e) {
                    // Allow the click to work but prevent focus
                    e.preventDefault();
                    this.click();
                });
            });
            
            // Fix for iOS PWA keyboard not appearing for text/email/password inputs.
            // NOTE: input[type="tel"] is intentionally excluded here ‚Äî those fields
            // always use the custom numpad and must never trigger the native keyboard.
            const inputFields = document.querySelectorAll('input[type="email"], input[type="password"], input[type="text"], input[type="number"]');
            inputFields.forEach(input => {
                // Ensure inputs are focusable in PWA mode
                input.addEventListener('touchstart', function(e) {
                    // Don't prevent default - let iOS handle it
                    this.focus();
                }, { passive: true });

                // Add click handler as backup
                input.addEventListener('click', function() {
                    this.focus();
                });

                // Only remove readonly from non-tel inputs
                input.removeAttribute('readonly');
            });
        });
    </script>

    </div><!-- End main-app-container -->
</body></html>
